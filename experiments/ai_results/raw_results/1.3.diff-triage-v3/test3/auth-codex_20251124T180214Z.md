# AI Security Triage Report

**Agent:** codex (GPT-5)
**Timestamp:** 2025-11-24 18:03:01 UTC
**Duration:** ~00:40

## Executive Summary
- The July 2025 patch introduces a targeted authentication hardening in `SPRequestModule` that blocks unauthenticated access to `/_layouts/15/ToolPane.aspx` when the request is cloaked with a `SignOut.aspx` referrer. In v1 this path skipped auth entirely, letting arbitrary clients reach the ToolPane pipeline pre-auth.
- ToolPane accepts attacker-supplied web part markup (`MSOTlPn_DWP`) and instantiates it via `WebPartImporter` without a form-digest check when the request is not treated as a postback. Chaining the pre-auth bypass with classic DataForm/AggregateDataSource `DataSourcesString` gadgets yields single-request unauth RCE (matches social media “ToolShell” chain for CVE-2025-49706 + CVE-2025-49704).
- A separate change adds a fragment (`#`) rejection to `ProofTokenSignInPage` redirects, closing an auth-token leakage/redirect edge that could aid spoofing.
- Another subsystem (`Microsoft.Ssdqs` serialization binder) now enforces allow/deny lists for `BinaryFormatter` type resolution. This likely addresses a low-privilege RCE vector (candidate for CVE-2025-49701) via unsafe binary deserialization of untrusted payloads.

## Intelligence Gathering
- **Official (CSAF)**: CVE-2025-49706 tagged as CWE-287/Spoofing with PR:N/UI:N; CVE-2025-49704/49701 are RCE with PR:L. Aligns with a pre-auth component and a deserialization/RCE component.
- **ZDI announcement**: Pwn2Own chain combined auth bypass + insecure deserialization to exploit SharePoint (ToolPane endpoint noted).
- **Social media**: @_l0gg coined “ToolShell” and called out single-request unauth RCE via ToolPane; @codewhitesec confirmed chain uses CVE-2025-49706 + CVE-2025-49704 by POSTing to ToolPane.aspx.
- **Historical patterns**: Prior pre-auth bypass (CVE-2023-29357) abused token validation gaps; RCEs (CVE-2019-0604, CVE-2020-1147, CVE-2020-0932) leveraged DataForm/AggregateDataSource `DataSourcesString` losformatter payloads in web part import flows.

## Cross-Reference Map
- Auth bypass + ToolPane exploitation is corroborated by ZDI and both social posts; code diff shows `SPRequestModule` now special-cases ToolPane + SignOut referrer. High confidence link to CVE-2025-49706.
- Deserialization RCE path (web part import + losformatter gadgets) matches historical SharePoint RCE writeups and the social “single-request” hint. No explicit code change, implying the RCE surface persists but is gated by the new auth check (fits CVE-2025-49704: PR:L).
- New BinaryFormatter allow/deny lists (Ssdqs TypeProcessor) are not mentioned in public intel; likely the hidden CVE-2025-49701 RCE fix.

## Vulnerability Analysis (guided by intelligence)
- **Authentication bypass (CVE-2025-49706)**
  - Location: `snapshots_decompiled/v1/Microsoft.-52195226-3676d482/Microsoft/SharePoint/ApplicationRuntime/SPRequestModule.cs:2709-2790` (and duplicate assembly `Microsoft.-67953109-566b57ea`).
  - Behavior in v1: Requests whose referrer equals any `SignOut.aspx` variant (or paths starting with signout/start) set `flag6=false`/`flag7=true`, skipping AccessDenied for unauthenticated users. No path filtering, so `/_layouts/15/ToolPane.aspx` could be reached pre-auth with `Referer: /_layouts/15/SignOut.aspx`.
  - Patch: v2 adds `flag10 = context.Request.Path.EndsWith("ToolPane.aspx")` and, when combined with a signout referrer and kill-switch 53506 **disabled**, forces `flag6=true`/`flag7=false` and logs a high ULS trace. This reinstates the auth challenge for ToolPane only.
  - Bypass surface variants (v1): any signout path (`signoutPathRoot/Previous/Current`) as referrer + ToolPane path; start.aspx variants also flip the same flags, so additional endpoints besides ToolPane might still be reachable via start/signout referrers.

- **Deserialization RCE in ToolPane import flow (CVE-2025-49704, post-auth; becomes pre-auth when chained with the above)**
  - Location: `snapshots_decompiled/v1/Microsoft.-52195226-3676d482/Microsoft/SharePoint/WebPartPages/ToolPane.cs:520-560, 712-840`.
  - Mechanics: In custom toolpane mode (true for `ToolPane.aspx`), `SelectedAspWebPart` pulls `MSOTlPn_DWP` and `MSOTlPn_Uri` from the request and passes the markup into `WebPartImporter.Import(...)` and `GetPartPreviewAndPropertiesFromMarkup` without an upfront form-digest or auth check when the request is not treated as a postback. Web parts like `DataFormWebPart` and `AggregateDataSource` deserialize `DataSourcesString` via `LosFormatter/BinaryFormatter`, enabling classic DataSet/ObjectDataProvider gadget execution.
  - Impact: Arbitrary code execution as the SharePoint application pool. With the v1 auth bypass, this is exploitable pre-auth with a single POST; otherwise PR:L (site owner) still suffices.

- **Proof token redirect hardening (spoofing adjunct)**
  - Location: `snapshots_decompiled/v2/Microsoft.-1bae7604-1834fb48/Microsoft/SharePoint/IdentityModel/ProofTokenSignInPage.cs:320-330`.
  - Adds rejection of redirect URLs containing a fragment (`#`) unless kill-switch 53020 is set, preventing token delivery to fragment-based exfiltration or open-redirect chains.

- **BinaryFormatter type allow/deny enforcement (candidate CVE-2025-49701)**
  - Location: `snapshots_decompiled/v2/Microsoft.-b23f4965-73cc7a11/Microsoft/Ssdqs/Infra/Utilities/TypeProcessor.cs` and `NoneVersionSpecificSerializationBinder.cs`.
  - New allowlist + extensive denylist (DataSet, BinaryFormatter, XamlReader, ClaimsIdentity, etc.) plus generic-type filtering. Without the patch, untrusted binary payloads could resolve arbitrary gadget types, leading to RCE in any Ssdqs deserialization path that uses the binder. Privilege requirement (PR:L) and RCE impact line up with CVE-2025-49701.

## Exploitation Paths
1) **ToolPane pre-auth RCE (v1)**
```
POST /_layouts/15/ToolPane.aspx HTTP/1.1
Host: target
Referer: https://target/_layouts/15/SignOut.aspx
Content-Type: application/x-www-form-urlencoded

MSOTlPn_Uri=https://target/SitePages/anything.aspx&
MSOTlPn_DWP=<webParts><webPart xmlns="http://schemas.microsoft.com/WebPart/v3">
  <metaData><type name="Microsoft.SharePoint.WebPartPages.DataFormWebPart, Microsoft.SharePoint" /></metaData>
  <data>
    <properties>
      <property name="DataSourcesString" type="string">[LosFormatter payload with DataSet/ObjectDataProvider gadget executing cmd]</property>
    </properties>
  </data>
</webPart></webParts>
```
- Relies on auth bypass; no valid form digest needed because the request is not treated as a postback.

2) **ToolPane authenticated RCE (v2 still vulnerable post-auth)**
- Same payload as above but issued by any authenticated site owner (PR:L). Auth bypass is blocked in v2, but the losformatter gadget path remains.
- Alternate gadget: `AggregateDataSource.DataSourcesString` or `DataViewWebPart` losformatter fields to evade simple signatures.

3) **BinaryFormatter gadget injection (Ssdqs, pre-patch)**
- Craft `BinaryFormatter` payload targeting an Ssdqs endpoint that uses `NoneVersionSpecificSerializationBinder`; type resolution would accept dangerous types pre-patch. The new TypeProcessor denylist/allowlist blocks typical gadget types and generics.

## Source Reliability
- CSAF + ZDI: authoritative on CVE mapping and impact. Matches SPRequest/ToolPane auth fix.
- Social media: correctly hinted ToolPane + single-request RCE and aligns with observed SPRequest change; considered reliable corroboration.
- Historical writeups: Strong pattern match for losformatter-based WebPart import RCEs; high confidence the same gadget class applies here.
- Unpublicized TypeProcessor change: no external corroboration; confidence moderate, based on code diff only.

## Novel / Gaps
- The kill-switch `ServerDebugFlags` 53506 can disable the ToolPane auth fix; if toggled, the pre-auth bypass returns. This risk is not mentioned publicly.
- The signout/start referrer logic still suppresses auth for *other* endpoints; only ToolPane is explicitly restored. Additional sensitive pages may remain reachable with crafted referrers.
- Deserialization surface (`MSOTlPn_DWP` losformatter fields) is unchanged; patch only gates it with auth. Additional hardening (e.g., rejecting losformatter payloads or requiring form digest) is absent.
- BinaryFormatter allow/deny lists suggest a separate RCE class not referenced by public intel (likely CVE-2025-49701).

## Mitigation Checks
- v2 returns Access Denied and logs ULS tag 505264341 when ToolPane is requested with a SignOut referrer; v1 allows the request.
- Ensure kill-switch 53506 is NOT set; otherwise, the bypass persists.
- Even on v2, treat ToolPane payload parsing as unsafe—require auth + digest and monitor for losformatter payloads; consider additional request filtering for `MSOTlPn_DWP`.

