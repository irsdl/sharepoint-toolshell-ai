# CVE-2025-49706 / ToolShell Chain Analysis

**Agent:** codex (GPT-5)  
**Timestamp (UTC):** 2025-11-20 22:43:25  
**Duration:** ~00:35  
**Environment:** Local only, no network; refs to tainted `ai_results/` avoided.

## Executive Summary
- Patch adds a targeted auth check in `SPRequestModule.PostAuthenticateRequestHandler` for requests with a **signout referrer + `ToolPane.aspx` path**, indicating exploitation of an auth bypass that let unauthenticated users reach ToolPane endpoints. This aligns with social posts describing a single-request pre-auth chain dubbed **ToolShell**.
- The bypass likely enabled access to web-part editing pages that instantiate complex controls (e.g., result-source/auth settings) and trigger backend deserialization. Multiple search/analytics components simultaneously gained new BinaryFormatter guardrails and type blocklists, suggesting Microsoft is mitigating gadget-based RCE (CVE-2025-49704) reachable once ToolPane is exposed.
- CVE-2025-49701 (auth required RCE) is consistent with additional serialization hardening in auxiliary services; however, the standout pre-auth risk is the ToolPane gatekeeping hole for CVE-2025-49706.

## Intelligence Gathering
- **Official (CSAF):**
  - *CVE-2025-49706* classified as spoofing/improper auth (PR:N/UI:N, C:L/I:L/A:N).
  - *CVE-2025-49704* and *49701* are RCE with PR:L; exploitation more likely for 49704.
- **ZDI announcement:** Pwn2Own chain combined auth bypass + insecure deserialization on SharePoint; authenticated block missing prior to patch.
- **Social media:**
  - @_l0gg and @codewhitesec describe “ToolShell” as a **single POST to ToolPane.aspx** achieving unauth RCE via spoofed auth + deserialization (ZDI-25-580).
- **Historical writeups:** Prior SharePoint chains (CVE-2023-29357/24955) abused weak JWT/claims handling + post-auth deserialization. Deserialization gadgets often rely on BinaryFormatter / XamlReader and type confusion.

## Cross-Referenced Leads
- Repeated community mention of ToolPane + deserialization → Patch adds ToolPane-specific auth enforcement in `SPRequestModule`.
- Multiple new SafeSerialization bindings/disallow lists in search/analytics ingestion code → matches deserialization/RCE angle from ZDI/social posts.
- CSAF marks 49706 as spoofing with confidentiality/integrity impact, consistent with session impersonation via auth module bypass.

## Vulnerability Analysis

### CVE-2025-49706 – Auth Bypass to ToolPane
- **Patch evidence:** `snapshots_decompiled/v2/Microsoft.-52195226-3676d482/Microsoft/SharePoint/ApplicationRuntime/SPRequestModule.cs:2729` (also mirrored in `.../Microsoft.-67953109-566b57ea/...`).
  - New logic detects referrer to `signout.aspx` (`flag8`) and request path ending with `ToolPane.aspx` (`flag10`). If both and farm debug flag not set, it **re-enables authentication** and logs a “Risky bypass limited” trace.
- **Vulnerable behavior (v1):** Same block lacked the ToolPane check; any request with a signout/start referrer (or path) set `checkAuthenticationCookie` false and `flag7` true, preventing 401s. An unauth POST to `/_layouts/15/ToolPane.aspx` with `Referer: /_layouts/15/signout.aspx` reached the page as if authenticated.
- **Bypass surface:**
  - `signoutPath{Root|Previous|Current}` referrers are enough; path itself need not be signout. ToolPane was explicitly abused, but other high-value pages under `_layouts/` may still ride this logic (the patch only special-cases ToolPane).
  - Logic is duplicated across two assemblies, so all WFEs were affected.

### CVE-2025-49704 (likely) – Deserialization RCE once ToolPane reachable
- **Signals in patch:** Multiple BinaryFormatter deserializations gained new explicit-binder or denylist enforcement implying prior gadget entry:
  - `Microsoft/Office/Server/Search/Analytics/ContentPushStore/InheritIDictionaryBinder.cs` (new) and binder wiring for processing docs used by content push ingestion.
  - `Microsoft.Office.Server.Search.Feeding.CTSDocument` uses `ExplicitReferenceSerializationBinder<Dictionary<string, VariantProperties>>` with explicit type list; tolerances tightened and logging raised (v2 hash `...-b3970a17-9bc74dbc`, `CTSDocument.cs:83-105`).
  - `SafeSerialization` now blocks dangerous framework types (DataSet, ObjectDataProvider, XamlReader, BinaryFormatter, NetDataContractSerializer, etc.) via new denylist builder (diff chunk around build of `DisallowedTypesForDeserialization`).
- **Exploitation fit:** ToolPane hosts rich controls (e.g., `EditResultSourceControl`) that accept authentication data structures (cookies/forms) and metadata payloads. In v1 these payloads ultimately pass through BinaryFormatter/NetDataContractSerializer without the new blocklist, allowing gadget injection once an attacker can submit the form pre-auth via the bypass.
- **Result:** Pre-auth attacker crafts ToolPane POST carrying a serialized gadget (e.g., XamlReader-based) in fields that reach the search/BDS pipelines; deserialization during server-side processing yields RCE (matches “single request unauth RCE” claims).

### CVE-2025-49701 – Authenticated RCE Hardening (site owner scope)
- CSAF says PR:L RCE. Numerous SafeSerialization/type-processor changes (denylist of remoting/formatter types, guarded BinaryFormatter usage) likely mitigate authenticated gadget injection via admin/config endpoints (e.g., result sources, BDC metadata). While not fully mapped, the same deserialization surfaces above remain reachable to site owners even after auth is enforced.

## Exploitation Concepts
- **Auth bypass (v1):**
  1) Send POST to `https://victim/_layouts/15/ToolPane.aspx?Mode=Edit` with header `Referer: https://victim/_layouts/15/signout.aspx` and no cookies.
  2) SPRequestModule marks request as anonymous-friendly and skips auth → returns ToolPane markup/processing instead of 401/redirect.
- **Pre-auth RCE chain (ToolShell) idea:**
  1) Use bypass above.
  2) Supply form fields that create/modify a result source or connector using cookie/forms auth data serialized via BinaryFormatter/NetDataContractSerializer fields (e.g., crafted base64 in auth-data hidden inputs).
  3) Server deserializes payload in search/BDS pipeline (now blocked by new binder/denylist) and triggers gadget → code execution under SP service account.
- **Post-auth RCE (49701/49704) fallback:** Site Owner posts same malicious payload via legitimate ToolPane/UI flow; deserialization gadget fires even without bypass.

## Source Reliability
- **High confidence:** CSAF metadata (impacts, privilege requirements); patch diff showing ToolPane-specific auth handling.
- **Medium:** Mapping of deserialization fixes to ToolPane processing—patch shows systemic BinaryFormatter hardening, aligning with ZDI/social claims, but exact field->sink path requires dynamic tracing.
- **Risks/unknowns:** Other endpoints still exempt from auth when signout/start referrers are present; potential residual bypass vectors unpatched.

## Novel Findings / Gaps
- Patch only special-cases `ToolPane.aspx`; the broader `signout/start` referrer exemption remains. Other sensitive pages might still be reachable with crafted referrers.
- New deserialization denylist suggests multiple gadget vectors were pruned; further review should enumerate remaining allowed types to hunt for alternative gadget paths the denylist missed.

## Suggested Next Steps
1) Reproduce bypass on v1: confirm 200/ToolPane processing vs. 401 on v2 using crafted referrer.
2) Trace ToolPane form handling to identify exact payload fields reaching BinaryFormatter/NetDataContractSerializer sinks; build PoC gadget (e.g., XamlReader) to validate RCE on v1.
3) Survey other `_layouts` endpoints reachable via signout referrer to detect residual auth bypass risk.
