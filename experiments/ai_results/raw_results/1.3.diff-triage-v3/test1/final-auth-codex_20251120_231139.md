# Final Verification

## CVE-2025-49706 – Authentication Bypass (ToolPane)

- **Diff evidence:** `diff_reports/v1-to-v2.server-side.patch` hunk at `Microsoft/SharePoint/ApplicationRuntime/SPRequestModule.cs` shows new ToolPane-aware check:
  ```diff
  +                bool flag8 = uri != null && (SPUtility.StsCompareStrings(uri.AbsolutePath, signoutPathRoot) ...);
  +                if ( ... || flag8)
  +                {
  +                    flag6 = false;
  +                    flag7 = true;
  +                    bool flag9 = !SPFarm.CheckFlag((ServerDebugFlags)53506);
  +                    bool flag10 = context.Request.Path.EndsWith("ToolPane.aspx", StringComparison.OrdinalIgnoreCase);
  +                    if (flag9 && flag8 && flag10)
  +                    {
  +                        flag6 = true;
  +                        flag7 = false;
  +                        ULS.SendTraceTag(... "Risky bypass limited (Access Denied) - signout with ToolPane.aspx detected...");
  +                    }
  +                }
  ```

- **V1 vulnerable flow:** (`snapshots_decompiled/v1/.../SPRequestModule.cs:2715-2745`)
  - `flag6` controls auth cookie check; `flag7` marks anonymous allowance.
  - Untrusted input: HTTP request path and **referrer** (`context.Request.UrlReferrer`).
  - V1 condition: if path starts with signout/start or referrer absolute path equals signout, `flag6=false`, `flag7=true` → later branch for unauthenticated user with `flag7` skips 401 and proceeds, effectively allowing the request without authentication.
  - Missing check: no restriction on **which page** benefits. Any request with signout referrer bypasses auth, including `/_layouts/ToolPane.aspx` (rich editing surface). Outcome: unauthenticated actor can reach ToolPane endpoint and trigger server-side processing (leads to RCE chain).

- **Bypass routes validated:**
  1) `Referer: /_layouts/15/signout.aspx` + target `/_layouts/15/ToolPane.aspx` (primary exploited path). Feasibility: High (simple header/path, no creds).
  2) Other `_layouts` pages still inherit the same referrer logic (no ToolPane-specific block). Feasibility: Medium (needs target page that trusts authenticated context after module). Not fully validated for specific endpoints → potential residual bypass.

- **V2 prevention:** With referrer-based bypass detected (`flag8`) and path endswith ToolPane.aspx (`flag10`), the code flips back to `flag6=true`, `flag7=false`, causing normal auth enforcement and logging. This blocks the documented ToolPane path. Other endpoints remain subject to broader bypass rule (not covered by this fix).

- **Confidence:** **High** for ToolPane path (explicit code change). Other `_layouts` bypass remains **Unproven**.

## Deserialization Hardening (CVE-2025-49704 / RCE chain)

### CTSDocument dictionary deserialization
- **Diff evidence:** `Microsoft/Office/Server/Search/Feeding/CTSDocument.cs`
  ```diff
  +                        BinaryFormatter binaryFormatter = new BinaryFormatter();
  +                        Type[] knownTypes = new Type[1] { typeof(Guid) };
  +                        binaryFormatter.Binder = new Microsoft.Office.Server.Security.SafeSerialization.ExplicitReferenceSerializationBinder<Dictionary<string, Microsoft.Office.Server.Search.Feeding.VariantProperties>>("DeserializeDictionary", knownTypes);
  +                        m_properties = (Dictionary<string, ...VariantProperties>)binaryFormatter.Deserialize(serializationStream);
  ```
- **V1 vulnerable flow:** (`snapshots_decompiled/v1/.../CTSDocument.cs:76-94`)
  - GZip stream wraps `BinaryFormatter` with **no binder**. Data source: `m_stream` populated from incoming feed content (untrusted ingestion path).
  - Missing control: allowed type graph unrestricted; attacker-supplied serialized payload could inject gadget types → deserialize and execute on ingestion → RCE.
- **V2 mitigation:** Binder restricts to expected dictionary and known types (Guid). This blocks arbitrary gadget types. Edge: if other allowed types remain dangerous, risk persists but significantly reduced.
- **Confidence:** **Medium** (deserialization + untrusted input implied; exact entry path not fully traced).

### ContentPushStore ProcessingDocument / InheritIDictionaryBinder
- **Diff evidence:** new file `.../Analytics/ContentPushStore/InheritIDictionaryBinder.cs` and patched `ProcessingDocument.Deserialize` hunk:
  ```diff
  +        BinaryFormatter binaryFormatter = new BinaryFormatter();
  +        binaryFormatter.Binder = inheritIDictionaryBinder;
  +        IDictionary<string, object> values = (IDictionary<string, object>)binaryFormatter.Deserialize(serializationStream);
  ```
- **V1 vulnerable flow:** Previously deserialized `doc.Values` via BinaryFormatter without binder in content push pipeline; payload source is pushed analytics document (potentially user-influenced). Arbitrary type instantiation possible → gadget-based RCE.
- **V2 mitigation:** Custom binder likely constrains IDictionary implementations/types. Attack requires bypassing binder; thus prior open gadget surface reduced.
- **Confidence:** **Medium** (no full entry-point proof, but BinaryFormatter hardening is security-significant).

### SafeSerialization denylist expansion & TypeProcessor
- **Diff evidence:** Large addition of `DisallowedTypesForDeserialization` and new `TypeProcessor` with allow/deny logic in `Microsoft.Ssdqs.Infra.Utilities.TypeProcessor`.
- **V1 behavior:** Type resolution (`Type.GetType`) used without explicit deny; dangerous types (DataSet, XamlReader, BinaryFormatter, NetDataContractSerializer, ClaimsIdentity, etc.) were not blocked. Combined with multiple BinaryFormatter/NetDataContractSerializer uses, this permitted gadget graphs.
- **V2 mitigation:** Before accepting type, checks denial/allow lists; throws `BlockedTypeException` when type is not allowed or explicitly denied. Blocks many well-known gadgets.
- **Confidence:** **Low-Medium** (security intent clear; exact exploit path not pinpointed in provided code).

### Search Query UrlMapping BinaryFormatter binder
- **Diff evidence:** new class `Microsoft.Office.Server.Search.Query.UrlMapping.UrlMapping` with `BinaryFormatter` deserialization guarded by `ExplicitReferenceSerializationBinder<Dictionary<string,string>>`.
- **V1 behavior:** This class is new in v2; if earlier logic deserialized mapping bytes without binder, it could be RCE/integrity risk. Without prior file, vulnerability is speculative.
- **Confidence:** **Unproven / speculative** (no v1 counterpart shown).

## Bypass & Completeness Validation
- **Auth bypass:** Only ToolPane path explicitly blocked. Other `_layouts` pages still bypassable via signout/start referrer in v2; **unverified**. Distinct validated routes: 1 (ToolPane). Possible additional routes: other `_layouts` endpoints (speculative).
- **Deserialization dangerous types:** v2 denylist names multiple dangerous framework types (DataSet, ObjectDataProvider, XamlReader, BinaryFormatter, NetDataContractSerializer, ClaimsPrincipal, etc.). Not all remaining allowed types reviewed; cannot assert completeness. 
- **CVE-2025-49701 candidates:** TypeProcessor allow/deny and UrlMapping binder are main speculative candidates.

## Coverage Scan (other security-relevant changes)
- `CookieAuthData` binder (search admin) already used binder in v1; diff shows similar pattern—appears neutral.
- `SafeSerialization` denylist/TypeProcessor: likely RCE hardening (candidate for CVE-2025-49701).
- UrlMapping binder: potential new hardening; purpose unclear → unknown if security-motivated.
- No additional auth-related edits beyond SPRequestModule; thus bypass coverage limited to ToolPane-specific fix.

## Final Assessment per Vulnerability
- **Auth bypass (ToolPane)**: **Confirmed** (code clearly adds a block). Bypass routes validated: 1; others speculative.
- **Deserialization RCE (CTSDocument, ProcessingDocument)**: **Likely** (Medium) based on unrestricted BinaryFormatter in v1 with untrusted inputs; v2 adds binders. 
- **TypeProcessor/denylist (candidate CVE-2025-49701)**: **Unproven** but security-motivated; likely RCE hardening.
- **UrlMapping binder**: **Unproven/speculative**; no v1 reference.

## Bypass Validation Summary
- CVE-2025-49706: **Confirmed 1 distinct bypass route** (ToolPane via signout referrer). Other `_layouts` pages may remain exposed; not validated.
- CVE-2025-49704: Multiple deserialization sinks hardened; dangerous types blocked via denylist. **Only validated generic BinaryFormatter openness**, not each gadget; other bypasses may exist.
- CVE-2025-49701: Candidates identified (TypeProcessor, UrlMapping), confidence low; exploitation path not verified.

**Overall:** Evidence supports the ToolPane auth bypass fix and deserialization hardening. Some changes remain speculative without clearer v1 counterparts or entry points.
