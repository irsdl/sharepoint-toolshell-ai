Agent: Codex (GPT-5)
Timestamp: 2025-11-20 00:07:23
Duration: 25:00

# 1. Vulnerability Discovery
- **ProofTokenSignInPage fragment redirect** – ProofTokenSignInPage accepted any `redirect_uri` containing a fragment (`#`), issued SharePoint proof/identity tokens, and redirected to the raw string. Attackers could embed a secondary redirect (e.g., `/_layouts/15/SPAppRedirect.aspx#https://attacker`) and steal tokens. Class: CWE-601 / CWE-200. Severity: High.

# 2. Root Cause Analysis
- **Mechanism**: `ShouldRedirectWithProofToken` in v1 only validated that the redirect URL was within the same site subscription via `IsAllowedRedirectUrl` and never inspected `RedirectUri.Fragment` (`snapshots_decompiled/v1/.../ProofTokenSignInPage.cs:315-323`). `SignInAppWeb` always redirected to `RedirectUri.OriginalString` (`lines 475-493`). Any fragment survived to the client where SharePoint pages such as SPAppRedirect.aspx interpret `location.hash` to perform further redirects, leaking the freshly minted tokens.
- **Impact Scenario**: An attacker crafts a link to ProofTokenSignInPage with `redirect_uri=https://tenant/_layouts/15/SPAppRedirect.aspx#https://evil`. When an authenticated user hits it, SharePoint issues proof/identity tokens and redirects to SPAppRedirect.aspx, which then follows the fragment to the attacker-controlled site, exposing the tokens and allowing full impersonation.
- **Prerequisites**: Ability to convince a logged-in user (or victim admin) to open a crafted ProofTokenSignInPage URL; no server-side access is required.

# 3. Patch Analysis
- v2 introduces `RevertRedirectFixinProofTokenSigninPage` (kill switch ID 53020) and augments `ShouldRedirectWithProofToken` to deny any redirect that contains a fragment unless the kill switch flag is explicitly enabled (`snapshots_decompiled/v2/.../ProofTokenSignInPage.cs:317-328`). A ULS trace warns that “Hash parameter is not allowed.”
- The remainder of the flow (`SignInAppWeb`, `IsAllowedRedirectUrl`) is unchanged; mitigation relies solely on refusing fragment-bearing URIs. Related files show no further modifications, so the patch specifically targets fragment-based leaks.

# 4. Bypass Hypotheses
- **Low likelihood** – Administrators can re-enable the fragment behaviour by setting server debug flag 53020 (`RevertRedirectFixinProofTokenSigninPage`). If left on, the original vulnerability returns unchanged.
- **Medium likelihood** – The check only fires for literal fragments. A redirect such as `...SPAppRedirect.aspx%23target=https://evil` leaves `RedirectUri.Fragment` empty (because `#` is URL-encoded) yet `SignInAppWeb` still calls `RedirectUri.OriginalString`, so browsers may decode the `%23` and follow the attacker-controlled fragment. Needs verification but remains plausible because no canonicalisation occurs.
- **Medium likelihood** – The trust boundary still equals “any URL in the current site subscription.” An attacker who controls or compromises any site/page inside the tenant can set `redirect_uri` to that page and relay tokens server-side or via DOM APIs, bypassing the fragment restriction entirely.

# 5. Overall Assessment
- **Discovery**: Identified one high-severity open redirect/token leakage vulnerability concentrated in ProofTokenSignInPage.
- **Patch completeness**: Fix blocks literal fragments but does not canonicalise URLs, enforce an allowlist, or prevent tenant-internal relays; enabling kill switch 53020 undoes the protection.
- **Recommendations**: (1) Canonicalise and scrub fragments from the redirect string before issuing `Response.Redirect`; (2) maintain an explicit allowlist (or specific handler list) for redirect targets rather than trusting all subscription URLs; (3) monitor/alert when debug flag 53020 is enabled; (4) consider per-redirect nonce binding or signed return URLs to prevent tampering.
