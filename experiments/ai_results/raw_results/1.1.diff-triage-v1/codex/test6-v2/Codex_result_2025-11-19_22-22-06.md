Agent: Codex (GPT-5)  
Timestamp: 2025-11-19 22:22:06 UTC  
Duration: 120:00  

## 1. Vulnerability Discovery

| ID | Description | Vulnerability Type | Severity |
| --- | --- | --- | --- |
| V1 | `Microsoft.PerformancePoint.Scorecards.ExcelDataSet` exposed as a safe control, allowing arbitrary BinaryFormatter deserialization via `CompressedDataTable` | Deserialization / Serialization | High |
| V2 | `Show-Command` GUI importing PS modules from UNC/device paths even in restricted sessions | Authorization / Access Control | High |
| V3 | `ProofTokenSignInPage` allowed redirect URIs containing attacker-controlled `#fragment` data | Input Validation | Medium |
| V4 | IIS `_forms` virtual directory anonymously executed ASPX outside the SharePoint pipeline | Configuration / Hardening | Medium |

## 2. Root Cause Analysis

- **V1 – ExcelDataSet safe control**
  - `webconfig.pps.xml` grants `TypeName="*"` for `Microsoft.PerformancePoint.Scorecards.Client` (snapshots_norm/v1/C__Program Files_Common Files_Microsoft Shared_Web Server Extensions/16/CONFIG/webconfig.pps.xml:4-9), so pages can instantiate `ExcelDataSet`.
  - `ExcelDataSet.DataTable` lazily deserializes attacker data via `Helper.GetObjectFromCompressedBase64String` → `BinaryFormatter.Deserialize` (snapshots_decompiled/v1/Microsoft.-89ead232-72556f65/Microsoft/PerformancePoint/Scorecards/ExcelDataSet.cs:38-78 and Helper.cs:560-599).
  - Any authenticated author can craft payloads that execute arbitrary code on the WFE.

- **V2 – Show-Command unrestricted module import**
  - `ShowCommandCommand.WaitForWindowClosedOrHelpNeeded` simply executed whatever module path the GUI requested (snapshots_decompiled/v1/Microsoft.-056c3798-daa17c9d/Microsoft/PowerShell/Commands/ShowCommandCommand.cs:390-415) even under `Utils.IsSessionRestricted`.
  - Restricted users could feed UNC or device paths and run arbitrary scripts while ostensibly sandboxed.

- **V3 – ProofTokenSignIn redirect fragments**
  - `ShouldRedirectWithProofToken` only called `IsAllowedRedirectUrl` (snapshots_decompiled/v1/Microsoft.-1bae7604-1834fb48/Microsoft/SharePoint/IdentityModel/ProofTokenSignInPage.cs:315-323) which ignores URI fragments.
  - Attackers could append `#evil=...` data that later client-side code trusts, enabling DOM-based redirects or token confusion during add-in sign-in.

- **V4 – IIS `_forms` bypass**
  - IIS `applicationHost.config` defined `/ _forms` mapping plus a `<location>` that forced anonymous/script access (snapshots_norm/v1/C__Windows_System32_inetsrv_config/applicationHost.config:332-354 and 28667-28679).
  - Files placed in `C:\inetpub\wwwroot\wss\VirtualDirectories\80\_forms` executed without SharePoint’s authentication modules, bypassing site security.

## 3. Patch Analysis

- **V1**: All SharePoint web.configs now include explicit `<SafeControl ... TypeName="ExcelDataSet" Safe="False" ...>` entries (e.g., snapshots_norm/v2/C__Program Files_Common Files_Microsoft Shared_Web Server Extensions/16/CONFIG/web.config:158-163). New upgrade action (`AddExcelDataSetToSafeControls`, snapshots_decompiled/v2/Microsoft.-52195226-3676d482/.../AddExcelDataSetToSafeControls.cs:6-28) injects those entries across every IIS site to ensure existing farms remove the unsafe control.
- **V2**: Added path normalization and restricted-session guard prior to module import (snapshots_decompiled/v2/Microsoft.-056c3798-daa17c9d/.../ShowCommandCommand.cs:402-407). When `Utils.IsSessionRestricted` is true and the module resolves to network/device paths, the cmdlet throws `CommandNameNotAllowed` instead of importing.
- **V3**: Introduced kill-switch constant `RevertRedirectFixinProofTokenSigninPage` and new fragment rejection block (snapshots_decompiled/v2/Microsoft.-1bae7604-1834fb48/.../ProofTokenSignInPage.cs:33-35, 320-328). Any redirect URI with a hash now fails validation unless the new flag is explicitly enabled.
- **V4**: Removed the `/ _forms` virtual directory and `<location>` override from both the main and `_SINGLEFILES` `applicationHost.config`. Requests must now traverse the SharePoint web application and use its authentication settings.

## 4. Bypass Hypotheses

| Vuln | Likelihood | Hypothesis / Evidence |
| --- | --- | --- |
| V1 | High | Farms that never run the upgrade action (schema <16.0.26.16 or manual rollback) still expose `ExcelDataSet`. |
| V1 | Medium | Administrators can reintroduce `<SafeControl Safe="True">` entries via custom solutions, negating the block. |
| V1 | Medium | Other Scorecards controls remain wildcard-safe and may deserialize user input similarly—needs broader audit. |
| V2 | High | Junctions or mounted drives pointing to UNC shares look local yet serve remote code, bypassing the simple path check. |
| V2 | Medium | Full language or unconstrained sessions still freely import UNC/device modules; the fix only covers restricted sessions. |
| V2 | Medium | Attackers can drop malicious modules on local/removable storage the policy already trusts. |
| V3 | High | Enabling kill-switch 53020 re-allows fragments; admins troubleshooting auth could inadvertently reopen the hole. |
| V3 | Medium | `RedirectUriFlags` decoding rewrites the URL after validation; encoded payloads might reintroduce fragment-style data. |
| V3 | Medium | Other SharePoint sign-in pages were untouched and might still allow fragments, enabling alternate attack paths. |
| V4 | High | Extended web apps or custom IIS sites can still declare their own `/ _forms` mappings, preserving the bypass. |
| V4 | Medium | Ops teams might recreate the mapping for legacy reasons, restoring anonymous/script access. |
| V4 | Medium | Other anonymous directories (`/_layouts`, `/_wpresources`) still exist; compromise there gives similar reach. |

## 5. Coverage Check Results

- **Initial findings**: V1–V4 as listed above.
- **New findings from coverage check**: None.
- **Unmapped security changes**: None; every `Security-relevant` hunk maps to V1–V4.
- **Statistics**:
  - Files analyzed: 6 162 total.
  - `.cs`/`.config` files analyzed: 6 161 (all in diff).
  - Security-relevant hunks: 13.
  - Hunks mapped to prior findings: 13.
  - New vulnerabilities from coverage check: 0.
  - Remaining unmapped hunks: 0.
- **Artifacts**: Detailed per-hunk log saved at `analysis/discover-v2-hunk-coverage.csv` (follows required `discover-v2-` prefix).

## 6. Overall Assessment

Two high-severity and two medium-severity vulnerabilities were fixed between v1 and v2. The mitigations are narrowly targeted:
1. Blocking `ExcelDataSet` as a safe control plus an upgrade action prevents a trivially exploitable BinaryFormatter gadget, but other Scorecards classes warrant review.
2. `Show-Command` now refuses UNC/device modules inside restricted sessions, though junction-based bypasses or unrestricted runspaces remain concerns.
3. `ProofTokenSignInPage` now strips fragments from redirect URIs unless a kill switch is flipped; admins must avoid reverting it.
4. IIS no longer exposes the anonymous `/ _forms` virtual directory; ensure the change propagates to every extended web app.

**Recommendations**
1. Confirm the upgrade job ran on every farm web.config and monitor for customizations that re-enable `ExcelDataSet`.
2. Harden `Show-Command` further by resolving junctions and enforcing signatures / trusted locations even in unrestricted sessions.
3. Audit all other login endpoints for fragment handling to ensure holistic protection.
4. Periodically scan IIS configuration for reintroduced `/ _forms` (or similar) mappings and remove them.
