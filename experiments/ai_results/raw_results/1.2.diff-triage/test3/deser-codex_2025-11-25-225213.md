Agent: codex (ChatGPT/GPT-5)
Timestamp: 2025-11-25 22:52:13 UTC
Duration: ~00:30

## Executive Summary
- Primary RCE (CVE-2025-49704): SharePoint includes the SQL Data Quality Services (Microsoft.Ssdqs.*) stack that used BinaryFormatter deserialization with a binder that accepted any type. Site-level authenticated callers could supply crafted payloads through numerous DQS entry points, leading to arbitrary type loading and gadget execution on the server. Patch introduces a strict allow/deny TypeProcessor and explicit blocking of dangerous types, bringing behavior in line with CSAFs CWE-94 Improper Control of Generation of Code description.
- Secondary RCE-capable issue (likely CVE-2025-49701): PerformancePoints `ExcelDataSet` is now explicitly registered as **not** SafeControl, indicating prior ability for page authors to load a DataTable-serialization helper control in content pages. That helper serializes/deserializes DataTables, providing a potential gadget surface for RCE if instantiated by a site owner.
- Authentication bypass hardening (CVE-2025-49706): IIS/appHost/web.config removes the dedicated `/_forms` virtual directory and its anonymous-enabled `<location>` override, tightening authentication on form resources.

## CSAF Advisory Highlights
- CVE-2025-49704: Critical, CVSS 8.8, CWE-94 code injection. AV:N/AC:L/PR:L/UI:N, attacker authenticated as Site Owner can inject and execute code remotely on SharePoint server.
- CVE-2025-49701: Important (also RCE, CVSS 8.8), CWE-285 Improper Authorization. Same AV:N/AC:L/PR:L/UI:N language as 49704; likely another RCE vector requiring Site Owner.
- CVE-2025-49706: Important, CWE-287 Improper Authentication (spoofing). AV:N/AC:L/PR:N/UI:N with confidentiality/integrity impact, no availability impact.

## CVE-to-Diff Mapping
- **RCE via unrestricted BinaryFormatter binder (maps to CVE-2025-49704)**
  - `snapshots_decompiled/v1/Microsoft.-b23f4965-73cc7a11/Microsoft/Ssdqs/Infra/Utilities/NoneVersionSpecificSerializationBinder.cs`: v1 resolved any type via `Type.GetType` with no restrictions before deserializing attacker-controlled BinaryFormatter streams used across the Ssdqs proxies.
  - Patched in v2 (`.../NoneVersionSpecificSerializationBinder.cs`): blocks `System.Type`/`RuntimeType`, routes lookups through new `TypeProcessor` allow/deny logic, and throws `BlockedTypeException` when outside the allowlist.
  - New `TypeProcessor` allowlist/denylist (`snapshots_decompiled/v2/.../TypeProcessor.cs`): permits only primitives, a narrow set of generics, and Microsoft.Ssdqs types; explicitly denies dozens of known gadget types including `BinaryFormatter`, SOAP formatters, `PSObject`, `WorkflowDesigner`, `ObjectDataProvider`, etc.
  - BinaryFormatter call sites now use the guarded binder: `SerializationUtility.ConvertBytesToObject` (same path) still deserializes arbitrary bytes but now enforces the binder; `ChunksExportSession.ByteArrayToObject` (`snapshots_decompiled/v2/Microsoft.-a453c131-bab0bdc4/Microsoft/Ssdqs/Core/Service/Export/ChunksExportSession.cs`) switched from raw `new BinaryFormatter().Deserialize` to the guarded utility.
- **PerformancePoint ExcelDataSet SafeControl restriction (likely CVE-2025-49701, RCE-capable)**
  - Web.config additions mark `Microsoft.PerformancePoint.Scorecards.ExcelDataSet` (v15/v16) as `Safe="False"` (`diff_reports/.../C__inetpub_wwwroot_wss_VirtualDirectories/80/web.config`, same for `20072/web.config`). This blocks page authors from loading the control. Underlying class (`snapshots_decompiled/v1/Microsoft.-89ead232-72556f65/Microsoft/PerformancePoint/Scorecards/ExcelDataSet.cs`) serializes/deserializes `DataTable` using compressed BinaryFormatter, so instantiation by a Site Owner could deserialize untrusted payloads.
- **Authentication bypass/scope tightening (CVE-2025-49706)**
  - IIS `applicationHost.config` removes the `/SharePoint - 80/_forms` virtual directory and the `<location path="SharePoint - 80/_forms">` block that enabled anonymous auth and static content (`diff_reports/v1-to-v2.server-side.patch`, appHost config hunks). This forces `/_forms` to inherit normal authentication instead of anonymous access.

## Vulnerability Analysis
- **Vulnerable behavior (v1)**: Ssdqs serialization binder accepted any type name, so any BinaryFormatter payload received via DQS client/server channels (e.g., `SerializationUtility.ConvertBytesToObject` used by many proxy entry points and SQLCLR stored procedures) would instantiate attacker-chosen gadget types. With Site Owner privileges (per CSAF), an attacker could upload or store crafted binary blobs that the service later deserializes, achieving RCE.
- **Patch mechanics (v2)**: Binder now blocks disallowed types, requires types be on an allowlist, and rejects `System.Type` to prevent reflection-based escalations. TypeProcessor also rejects dangerous generics (SortedSet/SortedDictionary) and a long gadget denylist aligned to known BinaryFormatter exploit chains. Existing BinaryFormatter uses remain but are constrained to allowed Ssdqs and primitive types.
- **Completeness check**: All identified deserialization entry points now funnel through the guarded binder (either directly via `SerializationUtility` or indirectly via `ChunksExportSession`). Residual risk is limited to payloads composed solely of allowed Ssdqs types; review suggests no other generic formatter call sites remain unguarded in the diff. Array/enum/interface types are blanket-allowed by `TypeProcessor.IsTypeExplicitlyAllowed`, so a malicious array type could still pass if not caught by the denylist; however, gadget classes commonly abused are explicitly denied.

## Configuration & Surface Analysis
- SafeControl updates explicitly disallow `ExcelDataSet`, reducing the ability for site-level authors to introduce that serializable type into page markup (likely addressing the second RCE vector noted in CSAF 49701).
- Removing the anonymous `<location>` for `/_forms` closes an unauthenticated route to form resources, consistent with the spoofing/authentication-bypass advisory for CVE-2025-49706.

## Advisory Validation
- CSAFs CWE-94 RCE claim matches the code change: the primary fix is hardened type resolution for BinaryFormatter deserialization, exactly mitigating arbitrary code gadget execution.
- CVE-2025-49701 (authorization/RCE) is not described in detail in CSAF; the only non-binder security change touching RCE surfaces is the SafeControl block for `ExcelDataSet`, which prevents site authors from invoking a BinaryFormatter-based DataTable loader.
- CVE-2025-49706 spoofing is corroborated by the removal of anonymous `/_forms` access in IIS/web.config.

## Additional Findings / Residual Risk
- BinaryFormatter remains in use (even post-fix) across Ssdqs utilities; future gadget types within Microsoft.Ssdqs.* assemblies would not be stopped by the allowlist because all Ssdqs types are permitted. A stricter per-method allowlist (or replacing BinaryFormatter entirely) would further reduce risk.
- `TypeProcessor.IsTypeExplicitlyAllowed` automatically allows arrays/enums/abstract/interfaces once loaded; if an attacker can point deserialization to an array of a not-explicitly-denied gadget type, it depends on the denylist to catch it. Expanding the denylist to cover element types or disallow arrays of non-allowed types would harden further.
