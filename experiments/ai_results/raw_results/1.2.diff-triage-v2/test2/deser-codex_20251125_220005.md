# Diff triage report (Deserialization focus)

## Metadata
- Agent: codex (GPT-5)
- Timestamp: 2025-11-25 22:00:05 UTC
- Source set: snapshots v1 vs v2 (patch diff `diff_reports/v1-to-v2.server-side.patch`)

## Executive summary
- The patch adds explicit SafeControl blocks marking `Microsoft.PerformancePoint.Scorecards.ExcelDataSet` as **unsafe** in all SharePoint web.configs and ships an upgrade step to inject the entries (`Safe="False"`). This matches the CSAF RCE advisories (CVE-2025-49704 primary; CVE-2025-49701 likely same root across SKU list) and blocks instantiation/deserialization of the ExcelDataSet type that wraps BinaryFormatter-compressed DataTables.
- Authentication hardening for sign-in redirects and the `_forms` virtual directory aligns with the CSAF spoofing issue (CVE-2025-49706): redirect URLs with hash fragments are now rejected and the IIS location that allowed anonymous access to `/SharePoint - 80/_forms` is removed.
- Residual risk: other PerformancePoint Scorecards types remain wildcard-safe and still use the same BinaryFormatter-based helper; only `ExcelDataSet` is explicitly denied. Additional binary-serialized payload paths may still be reachable (candidate for CVE-2025-49701 or follow-on issues).

## CSAF advisory mapping
- CVE-2025-49704 (Critical, CWE-94, RCE). Network, low complexity, PR:L, UI:N. Any authenticated Site Owner can inject code to execute on the SharePoint server. Fixed versions 16.0.5508.1000 / 16.0.10417.20027.
- CVE-2025-49701 (Important, CWE-285, RCE). Same attack model as 49704, applies to Subscription Edition too. Likely the same PerformancePoint attack surface but broader SKUs.
- CVE-2025-49706 (Important, CWE-287, Spoofing/auth bypass). PR:N, UI:N, impacts confidentiality/integrity. KBs overlap with above.

## CVE-to-diff correlation
- **ExcelDataSet SafeControl denial (RCE – CVE-2025-49704/49701):**
  - New unsafe SafeControl entries for `Microsoft.PerformancePoint.Scorecards.ExcelDataSet` injected into farm/virtual directory configs: `snapshots_norm/v2/C__Program Files_Common Files_Microsoft Shared_Web Server Extensions/16/CONFIG/web.config`, `.../cloudweb.config`, `snapshots_norm/v2/C__inetpub_wwwroot_wss_VirtualDirectories/80/web.config`, `.../20072/web.config`.
  - Upgrade action to add the unsafe entries during patching: `snapshots_decompiled/v2/Microsoft.-52195226-3676d482/Microsoft/SharePoint/Upgrade/AddExcelDataSetToSafeControls.cs` and duplicate in `.../-67953109-566b57ea/...`. Description explicitly states adding ExcelDataSet to SafeControls “as unsafe”.
  - Dangerous type definition: `snapshots_decompiled/v1/Microsoft.-89ead232-72556f65/Microsoft/PerformancePoint/Scorecards/ExcelDataSet.cs` uses `Helper.GetObjectFromCompressedBase64String` -> BinaryFormatter deserialization of attacker-controlled `CompressedDataTable` data.
- **Sign-in redirect hardening (Spoofing – CVE-2025-49706):**
  - `snapshots_decompiled/v2/Microsoft.-1bae7604-1834fb48/Microsoft/SharePoint/IdentityModel/ProofTokenSignInPage.cs:308-321` now rejects redirect URIs containing a URL fragment unless a debug flag is set, preventing token redirects that hide parameters after `#`.
- **IIS virtual directory tightening (Spoofing/Auth bypass – CVE-2025-49706):**
  - `snapshots_norm/v2/C__Windows_System32_inetsrv_config/applicationHost.config` removes the `<location path="SharePoint - 80/_forms">` block that previously enabled anonymous authentication and static content caching for `_forms`.

## Vulnerability analysis
- **Root cause (ExcelDataSet RCE):** PerformancePoint SafeControls allow all types under `Microsoft.PerformancePoint.Scorecards` (TypeName="*") to be instantiated in page markup. The `ExcelDataSet` type deserializes a Base64-compressed payload with BinaryFormatter (`Helper.GetObjectFromCompressedBase64String`), only restricting to DataTable/Version. BinaryFormatter over `DataTable` is a known unsafe deserialization vector; a Site Owner can craft `CompressedDataTable` with a malicious DataTable binary payload (TypeConfuseDelegate/DataTable gadget) and load it via Scorecards content to achieve code execution under the web app identity.
- **Patch effect:** Explicit SafeControl entries for `ExcelDataSet` with `Safe="False"` + upgrade action ensure SharePoint refuses this control even though the namespace wildcard is still present. The vulnerable code remains, but the control is blocked from being instantiated or serialized via normal page parsing.
- **Spoofing/Auth bypass:** Prior behavior allowed proof-token redirects with `#fragment`, enabling attackers to smuggle parameters past server parsing or craft phishing-style redirects; it also exposed `_forms` anonymously in IIS. The patch blocks fragment redirects and removes anonymous `_forms`, closing that path.

## Exploitation sketch
- **v1 RCE (PerformancePoint ExcelDataSet):**
  1. As a Site Owner, create/upload a Scorecards dashboard or page that includes an `ExcelDataSet` instance (permitted by wildcard SafeControls).
  2. Set `CompressedDataTable` to a BinaryFormatter payload containing a malicious DataTable gadget chain.
  3. When the page loads, `ExcelDataSet.DataTable` calls `Helper.GetObjectFromCompressedBase64String`, deserializing the payload and executing the gadget chain on the server.
- **v2 behavior:** SafeControl entry with `Safe="False"` blocks `ExcelDataSet` instantiation; upgrade action seeds the config, preventing both existing and new pages from loading the control, mitigating the attack.
- **Spoofing/Auth bypass:** In v1, a crafted proof-token redirect URL with a fragment could bypass checks/controls or leak tokens via client-side processing; anonymous `_forms` could aid token theft. v2 rejects fragments and removes the anonymous endpoint.

## Patch completeness and gaps
- ExcelDataSet is explicitly blocked, but the namespace wildcard remains Safe for other PerformancePoint types (`Microsoft.PerformancePoint.Scorecards.Client` TypeName="*"). Other classes also use `Helper.GetObjectFromCompressedBase64String` and BinaryFormatter (e.g., calculated member parsing in `Helper.cs`, other serialized properties). If any of those classes are reachable from user-controlled content (dashboards, import/export), the same deserialization gadget may still be exploitable. This is a plausible candidate for the additional RCE CVE-2025-49701 or future variants.
- The code of `ExcelDataSet` itself was not hardened; the mitigation is entirely configuration-based. Any alternate load path that bypasses SafeControls (API, server-side import, service calls) could still trigger the unsafe deserialization.
- Spoofing fix relies on redirect and IIS config changes; verify that all front-end zones receive the updated config and no other locations re-enable anonymous `_forms`.

## Recommendations / next steps
1) Audit remaining PerformancePoint Scorecards types that use BinaryFormatter helpers and consider marking other high-risk classes unsafe or removing wildcard SafeControls. Add runtime deserialization guards or migrate off BinaryFormatter.
2) Validate that the upgrade action ran on all web apps: confirm `ExcelDataSet` SafeControl entries with `Safe="False"` exist in each web.config (farm, site, MySite).
3) Regression-test login flows to ensure fragment rejection does not break legitimate SSO, and verify `_forms` is no longer anonymously reachable across zones.
4) For additional assurance against CVE-2025-49701, attempt to load other Scorecards serialized payloads (e.g., `TransformerConfigurationRecord`) and confirm they cannot trigger BinaryFormatter deserialization from user input.
