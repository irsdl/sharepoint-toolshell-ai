# CVE-2025-49704 / ToolPane Deserialization Triage

- Agent: codex (GPT-5)
- Timestamp: 2025-11-25 00:51:42
- Duration: ~00:35

## Executive Summary
The patch set blocks a single-request unauthenticated RCE chain against SharePoint’s ToolPane.aspx. The root cause is that the PerformancePoint `ExcelDataSet` control remained SafeControl-enabled through ToolPane web part import, letting attacker-supplied DataSet XML hit dangerous XAML gadget paths (`ExpandedWrapper`/`ObjectDataProvider`/`XamlReader.Parse`) for code execution. The July 2025 update explicitly marks `ExcelDataSet` unsafe in all web.configs and adds an upgrade step to propagate the block. The chain also relied on an auth bypass: anonymous access to `/_forms` plus a signout-based check skipping auth when requesting ToolPane.aspx. The patch removes the anonymous `_forms` location and adds explicit ToolPane signout detection in `SPRequestModule` to deny the bypass. These changes align with CSAF (CWE-94) and social “ToolShell” posts describing a deserialization+auth-bypass single POST.

## Intelligence Highlights
- CSAF 49704: Critical RCE, CWE-94, PR:L site owner; “write arbitrary code to inject and execute remotely.”
- CSAF 49701: Also RCE, PR:L; same release window (likely another type path).
- CSAF 49706: Auth spoofing, PR:N.
- ZDI Pwn2Own note: chain = auth bypass + insecure deserialization in SharePoint (Viettel CS).
- Social (l0gg/codewhitesec): “ToolShell” = single-request unauth RCE via ToolPane.aspx using CVE-2025-49706 + CVE-2025-49704.
- Historical patterns: DataSet/XamlReader gadget (PerformancePoint `ExcelDataSet`), SafeControl misconfig, ToolPane web part import, TypeConverter (`ResXFileRef`) as alternate deserialization vector.

## Cross-Reference Map
- ToolPane.aspx entrypoint mentioned by social; patch touches ToolPane auth in `SPRequestModule.cs` and removes anonymous `_forms` location → confirms auth-bypass leg (49706).
- Deserialization/DataSet patterns from writeups; patch marks `Microsoft.PerformancePoint.Scorecards.ExcelDataSet` unsafe via SafeControls + upgrade action → aligns with RCE leg (49704).
- No public intel on 49701; diff shows broader PowerShell/CLI XML deserialization removals (e.g., `StringToBase64Converter` deletion) suggesting a second type-based RCE fix.

## Vulnerability Analysis
- Files: `16/CONFIG/web.config`, `cloudweb.config`, `.../VirtualDirectories/*/web.config` add SafeControl entries marking `Microsoft.PerformancePoint.Scorecards.ExcelDataSet` (v15 & v16) `Safe="False" SafeAgainstScript="False"`. Upgrade helper `Microsoft/SharePoint/Upgrade/AddExcelDataSetToSafeControls.cs` pushes the block.
- Impact: Prior configs allowed the Scorecards namespace (or default ToolPane import) to instantiate `ExcelDataSet`. Its deserialization of attacker-controlled DataSet XML leads to code execution via XAML gadget chains (`ExpandedWrapper`→`ObjectDataProvider`→`XamlReader.Parse`).
- Trigger: POST to `/_layouts/15/ToolPane.aspx` supplying a web part definition referencing `Microsoft.PerformancePoint.Scorecards.ExcelDataSet, Microsoft.PerformancePoint.Scorecards.Client, Version=16.0.0.0, PublicKeyToken=71e9bce111e9429c` with malicious DataSet XML payload. ToolPane imports the part because SafeControl rules previously allowed it, reaching the deserialization sink pre-auth when chained with the auth bypass.
- Mitigation evidence: SafeControl override (Safe=False) blocks instantiation; upgrade action ensures per-site configs updated.
- Auth bypass (49706): `applicationHost.config` removes anonymous `location path="SharePoint - 80/_forms"` and `_forms` virtual directory; `SPRequestModule.PostAuthenticateRequestHandler` now detects ToolPane.aspx when referrer is signout and denies the short-circuit. Together these stop the unauth ToolPane reachability described in social posts.
- Possible second RCE (49701): Removal of `System.Management.Automation/StringToBase64Converter.cs` and related CLI XML helpers suggests hardening against attacker-controlled base64/CliXml argument deserialization (another type-reflection path). No other code references remain, implying previous reachable gadget surface.

## Dangerous Types (RCE-capable)
- `Microsoft.PerformancePoint.Scorecards.ExcelDataSet` (DataSet deserialization).
- DataSet gadget chain types: `System.Data.Services.Internal.ExpandedWrapper` + `System.Windows.Data.ObjectDataProvider` + `System.Windows.Markup.XamlReader.Parse` (payload type used inside ExcelDataSet data XML).
- Historical alternate gadgets for bypass: `System.Resources.ResXFileRef` TypeConverter, `System.Resources.ResXFileRef.Converter` (not patched here; watch other ToolPane-importable parts), general TypeConverter-based web part properties.
- Potential 49701 surface: CliXml type resolution via deleted `StringToBase64Converter`/`Deserializer` helpers (check any endpoints still decoding base64 args).

## Exploitation Walkthrough (v1)
1) Auth bypass: leverage anonymous `_forms` + signout referrer path to reach `/_layouts/15/ToolPane.aspx` without auth.
2) Send single POST with `__EVENTTARGET=importcontrol` (standard ToolPane import) and a web part XML whose `type` points to `Microsoft.PerformancePoint.Scorecards.ExcelDataSet,...` and whose property embeds crafted DataSet XML (ExpandedWrapper→XamlReader gadget running `cmd.exe /c whoami`).
3) ToolPane loads the part (SafeControl previously allowed), deserializes DataSet, executing payload as farm account. v2 fails at SafeControl check or pre-auth block.

## Source Reliability
- CSAF: high fidelity on vuln class (code injection) and privilege level.
- Social: precise entrypoint (ToolPane) and chain composition; aligns with code changes.
- Historical writeups: show ExcelDataSet/DataSet gadget viability and SafeControl misuse; directly matches patched type.
- Speculation: 49701 inference from CLI XML code removal is lower confidence; needs further confirmation.

## Novel Findings / Gaps
- Identification that the patch adds explicit SafeControl=FALSE entries plus an upgrade action for `ExcelDataSet`, rather than typical binder hardening—indicates the exploitable deserialization sits inside that control.
- Removal of anonymous `_forms` location paired with ToolPane-specific auth logic pinpoints the exact pre-auth vector used in “ToolShell.”
- Potential residual risk: other Scorecards or DataSet-derived controls may remain SafeControl-allowed; similar DataSet gadget payloads could be tried if they still deserialize XML.

## Recommendations / Next Steps
- Validate in lab: v1 ToolPane import of ExcelDataSet web part with DataSet/XamlReader payload; confirm v2 rejection at SafeControl stage and that ToolPane is no longer anonymous.
- Review remaining SafeControls for Scorecards/DataSet/TypeConverter-backed controls; consider explicit Safe=False for other deserialization-prone types.
- Investigate any endpoints still using CliXml/base64 deserialization (possible 49701) and ensure type filtering/binders are enforced.
