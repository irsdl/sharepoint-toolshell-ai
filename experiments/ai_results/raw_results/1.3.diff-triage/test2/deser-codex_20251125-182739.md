Agent: Codex (GPT-5)  
Timestamp: 2025-11-25 18:27:39 UTC  
Duration: ~MM:SS (interactive)  

## Executive Summary
- SharePoint’s ToolPane chain was patched at two layers: an authentication bypass in the request pipeline and multiple unsafe BinaryFormatter deserializations in Search components. The combination previously enabled the “ToolShell” single-request RCE described on social media.
- CVE-2025-49706 (auth bypass): `SPRequestModule.PostAuthenticateRequestHandler` now blocks signout-triggered unauthenticated access when the path ends with `ToolPane.aspx`, preventing anonymous execution of ToolPane payloads (snapshots_decompiled/v2/Microsoft.-52195226-3676d482/Microsoft/SharePoint/ApplicationRuntime/SPRequestModule.cs:2720).
- CVE-2025-49704 (RCE): Search code now wraps several BinaryFormatter deserializations with explicit validating binders to constrain types, signalling prior gadgetable deserialization of attacker-controlled data (cookies, URL mappings, content push payloads). Key fixes in:
  - CookieAuthData deserialization (snapshots_decompiled/v2/Microsoft.-b3970a17-9bc74dbc/Microsoft/Office/Server/Search/Administration/CookieAuthData.cs:30-82).
  - ContentPushStore DbSerializer and IDictionary binder (…/Search/Analytics/ContentPushStore/DbSerializer.cs:1-70 and InheritIDictionaryBinder.cs).
  - URL mapping deserialization (…/Search/Query/UrlMapping/UrlMappingCache.cs:20-70).
- CVE-2025-49701 (bonus RCE): The Ssdqs serialization binder now enforces allow/deny lists for deserialized types, blocking dangerous gadgets like `System.Data.DataSet`, `System.Windows.Markup.XamlReader`, `System.Windows.Data.ObjectDataProvider`, `System.Resources.ResourceDictionary`, BinaryFormatter/SoapFormatter, etc. (snapshots_decompiled/v2/Microsoft.-b23f4965-73cc7a11/Microsoft/Ssdqs/Infra/Utilities/TypeProcessor.cs and NoneVersionSpecificSerializationBinder.cs). Previously it simply resolved `Type.GetType`, enabling arbitrary gadget deserialization.

## Intelligence Gathering
- **Official (CSAF):** CVE-2025-49704/49701 marked as RCE with PR:L, network, no user interaction; CVE-2025-49706 is auth-related. Fits observed fixes: deserialization sinks reachable by authenticated site owners and an auth bypass on ToolPane.
- **ZDI Pwn2Own note:** Auth bypass + insecure deserialization chain on SharePoint.
- **Social media:** “ToolShell” single-request unauth RCE via POST to ToolPane.aspx; chain = CVE-2025-49706 (spoofing) + CVE-2025-49704 (deserialization).
- **Historical writeups:** Prior SharePoint RCEs abused unsafe deserialization of DataSet/Xaml (`ObjectDataProvider`/`ResourceDictionary`) and missing type allowlists; binary formatter gadgets also used in WebPart import and URL mapping. These match the denylist added in TypeProcessor and the new validating binders.

## Cross-Reference Highlights
- Multiple sources (CSAF + social) agree on deserialization RCE with low-priv auth → matches BinaryFormatter fixes in Search and Ssdqs.
- Social “ToolPane.aspx” + ZDI auth bypass → aligns with new ToolPane-specific block in SPRequestModule.
- Historical gadget patterns (DataSet, XamlReader, ObjectDataProvider, ResourceDictionary, BinaryFormatter) → explicitly denied in new TypeProcessor and blocked by new binders.

## Vulnerability Analysis
- **CVE-2025-49706 – ToolPane auth bypass**  
  - Patch: Post-auth handler now checks for `ToolPane.aspx` on signout paths and refuses the legacy bypass (flag6 re-enabled, trace logged) (snapshots_decompiled/v2/Microsoft.-52195226-3676d482/Microsoft/SharePoint/ApplicationRuntime/SPRequestModule.cs:2720).  
  - Prior: ToolPane pages processed under signout URLs were treated as safe anonymous requests, letting attackers hit ToolPane without auth and feed payloads.

+- **CVE-2025-49704 – RCE via unsafe deserialization in Search**  
  - `CookieAuthData` now deserializes Base64 cookie blobs with `ExplicitReferenceSerializationBinder<Cookie>` (…/Search/Administration/CookieAuthData.cs:30-82). Before: BinaryFormatter with no binder on attacker-supplied Base64 cookies ⇒ arbitrary gadget execution.  
  - `ContentPushStore.DbSerializer.Deserialize` now binds to dictionary-only types via `InheritIDictionaryBinder` (…/Search/Analytics/ContentPushStore/DbSerializer.cs:35-70; InheritIDictionaryBinder.cs). Before: BinaryFormatter over untrusted compressed blobs (`doc.Values`) allowing arbitrary object graphs.  
  - `UrlMappingCache.DeserializeMappingTables` now binds to `Dictionary<string,string>` (…/Search/Query/UrlMapping/UrlMappingCache.cs:20-70). Before: compressed BinaryFormatter with no constraints.  
  - These sinks are reachable by authenticated site owners pushing content/URL mappings or manipulating auth cookies, matching PR:L and network vectors.

- **CVE-2025-49701 – RCE-capable type resolution**  
  - `NoneVersionSpecificSerializationBinder` now enforces `TypeProcessor` allow/deny lists before returning a type; denies many high-risk gadgets (`DataSet`, `ObjectDataProvider`, `ResourceDictionary`, `XamlReader`, BinaryFormatter/SoapFormatter, Claims/Principal, JavaScriptSerializer, ObjectStateFormatter, etc.) (snapshots_decompiled/v2/Microsoft.-b23f4965-73cc7a11/Microsoft/Ssdqs/Infra/Utilities/TypeProcessor.cs; NoneVersionSpecificSerializationBinder.cs:70-96).  
  - Prior binder: `Type.GetType` on user-controlled type strings with no validation → attacker could pick any gadget, consistent with historic SharePoint RCE chains.

## Exploitation Sketches
- **Unauth ToolPane chain:** Use signout URL + `/_layouts/15/ToolPane.aspx` POST containing malicious serialized payload (e.g., BinaryFormatter gadget) → pre-patch, auth bypass let request through; ToolPane/underlying Search deserializers executed gadget. Post-patch, request is denied before reaching ToolPane.
- **Search deserialization sinks:**  
  1) Craft BinaryFormatter payload (e.g., `TypeConfuseDelegate` or `ResourceDictionary`/`ObjectDataProvider`) and supply as Base64 cookie value for Search auth data; pre-patch `CookieAuthData` deserializes it immediately.  
  2) Send compressed BinaryFormatter blob to Content Push/URL mapping inputs (`doc.Values`, URL map cache data) to trigger gadget execution in service context; new binders restrict to dictionaries and known primitives.
- **Type selection gadget (CVE-2025-49701):** Any feature using `NoneVersionSpecificSerializationBinder` (Ssdqs serialization utility) could be driven to deserialize arbitrary types; attackers would pick gadgets like `DataSet` or `XamlReader.Parse` to RCE. New allowlist/denylist closes this.

## Dangerous Types (observed/blocked)
- Explicitly denied now: `System.Data.DataSet`, `System.Windows.Data.ObjectDataProvider`, `System.Windows.Markup.XamlReader`, `System.Windows.ResourceDictionary`, `System.Web.UI.ObjectStateFormatter`, `System.Web.Script.Serialization.JavaScriptSerializer`, BinaryFormatter/SoapFormatter, ClaimsIdentity/Principal, `Hashtable`, `ResourceSet/ResXResourceSet`.
- Previously accepted payload containers: arbitrary `Dictionary<string, object>`/`IDictionary` graphs in Search, Base64 cookies, URL mapping blobs.

## Source Reliability
- Social/ZDI accurately flagged ToolPane + deserialization chain; code shows ToolPane-specific auth guard and multiple BinaryFormatter fixes → high confidence.  
- CSAF PR:L/UI:N matches deserialization sinks behind authenticated endpoints.  
- Historical writeups match the gadget types now denied, supporting the assessment that RCE was via classic .NET gadgets rather than logic flaws.

## Novel Findings / Gaps
- Multiple Search subsystems (cookie auth data, content push store, URL mapping cache) shared the same unsafe BinaryFormatter pattern; all now wrapped with validating binders—this breadth wasn’t mentioned in public intel.  
- The new Ssdqs TypeProcessor denylist surfaces additional gadgetable surfaces beyond ToolPane, suggesting broader deserialization hardening across the product.

## Recommendations / Next Steps
1) Re-test ToolPane.aspx with signout-prefixed paths to confirm 401/Access Denied and no web part processing.  
2) Attempt BinaryFormatter gadget delivery through Search cookie auth data and ContentPush/URL mapping inputs on a v1 build to reproduce code execution; verify v2 rejects non-allowed types.  
3) Review any other BinaryFormatter uses lacking `SafeSerialization` binders for similar exposure.
