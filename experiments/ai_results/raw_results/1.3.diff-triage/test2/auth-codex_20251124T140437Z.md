Agent: codex (GPT-5)
Timestamp: 2025-11-24 14:04:37 UTC
Duration: 00:40
Target: SharePoint Server (CVE-2025-49706 primary, CVE-2025-49704/49701 secondary)

## Executive Summary
- Authentication bypass fixed in SPRequestModule: any request with a SignOut/Start referrer (or path) disabled auth checks (`flag6=false`, `flag7=true`). A crafted request to `/_layouts/15/ToolPane.aspx` with `Referer: /_layouts/15/SignOut.aspx` previously skipped authentication, granting anonymous access to the ToolPane endpoint. Patch adds a ToolPane-specific guard and kill-switch flag to force Access Denied and log a risky bypass message.
- ProofTokenSignInPage now rejects redirect URLs containing a fragment (`#...`) unless a debug flag is set, preventing token issuance/redirect flows that leak or tamper with hashes. This closes an auxiliary auth/spoofing vector.
- The ToolPane endpoint (WebPart editing surface) performs no auth on GET and is a known deserialization/RCE surface (loads persisted WebParts/BDC payloads). With the bypass, attackers could reach it pre-auth and trigger existing deserialization gadgets (e.g., malicious WebPart definitions/BDC models/TypeConverters), achieving unauth RCE as described in social intel ("ToolShell").
- No strong evidence of a separate code fix for the deserialization bug in this diff; exploitation likely mitigated indirectly by restoring auth and by framework JSON deserializer hardening.

## Intelligence Gathering
- Official CSAF: CVE-2025-49706 = Improper Authentication/Spoofing (PR:N/UI:N/AV:N); CVE-2025-49701/49704 = RCE with PR:L. Fix KBs for SP 2016/2019/SE.
- ZDI announcement: Pwn2Own chain combined auth bypass + insecure deserialization for SharePoint RCE.
- Social media: "ToolShell" single-request unauth RCE via POST to ToolPane.aspx using CVE-2025-49706 (auth spoof) + CVE-2025-49704 (deserialization). Urgent patching recommended.
- Historical patterns: 2023 pre-auth JWT/HashedProofToken bypass (CVE-2023-29357) and BDC/ToolPane/WebPart deserialization RCEs (e.g., CVE-2020-0932, CVE-2022-29108) reachable via client.svc/ToolPane when auth is missing. ToolPane.aspx GET path skips digest checks and loads persisted WebParts.

### Cross-Reference Highlights
- CSAF spoofing + social "single request" => aligns with SPRequestModule ToolPane referrer bypass.
- ZDI chain + historical ToolPane/BDC RCE writeups => ToolPane as deserialization sink once pre-auth is achieved.
- ProofToken redirect hash check is unique to this patch; not mentioned externally (possible undisclosed bypass).

## Vulnerability Analysis
### CVE-2025-49706 – ToolPane sign-out referrer bypass (confirmed)
- File: `Microsoft/SharePoint/ApplicationRuntime/SPRequestModule.cs` (v1 vs v2). Pre-patch, any request with `Referer.AbsolutePath` matching SignOut/Start paths set `flag6=false` and `flag7=true`, skipping auth enforcement even under claims-only sites.
- ToolPane exposure: page `/_layouts/15/toolpane.aspx` (see layouts file) inherits `ToolpanePage` which only enforces form digest on POST; GET requires no digest. With `flag7=true`, unauthenticated GETs proceed to SPWebPartManager load.
- Patch: introduces `flag8` (signout referrer) + `flag10 = Path.EndsWith("ToolPane.aspx")`; if kill-switch 53506 is not set and both are true, it restores auth (`flag6=true`, `flag7=false`) and logs: "Risky bypass limited (Access Denied) - signout with ToolPane.aspx detected." Effectively blocks the crafted referrer path that allowed anonymous ToolPane access.
- Impact: Anonymous attacker could reach ToolPane.aspx and any downstream logic that assumes authenticated context, enabling spoofing/impersonation and setting up RCE chains.

### Auxiliary auth hardening
- File: `IdentityModel/ProofTokenSignInPage.cs`. Patch rejects redirect URIs containing fragments unless debug flag 53020 is enabled: logs "Hash parameter is not allowed" and refuses redirect. Prevents token leaks or redirect-based auth spoofing via `#` fragments.

### CVE-2025-49704 (deserialization RCE) – inferred surface
- ToolPane.aspx loads persisted WebParts (and BDC controls) without extra checks on GET. Historical exploits use malicious WebPart definitions/BDC metadata to trigger XmlSerializer/TypeConverter/DataSet gadget execution. With the pre-auth bypass, this surface became anonymous. No concrete code-level deserialization fix seen here, so risk reduction likely relies on closing the auth bypass; RCE may still exist post-auth (PR:L) per CSAF.
- Framework change: `System.Web.Script.Serialization.JavaScriptObjectDeserializer` adds `AppSettings.JsonDeserializerLimitedDate` and length-limited date parsing. This looks like a generic deserialization-hardening change, not specific to ToolPane, but slightly reduces payload flexibility.

### CVE-2025-49701 (unknown RCE) – status
- CSAF flags PR:L network RCE. No clear, SharePoint-specific logic change surfaced in this diff beyond general attribute reordering. Potentially still tied to ToolPane/WebPart deserialization flows that require low privileges; exploitation avenues remain similar to CVE-2025-49704 but may target different gadget chains.

## Exploitation Scenarios
1) **Pre-auth ToolPane reachability (fixed)**
- Request: `GET /_layouts/15/ToolPane.aspx?PageView=Shared&ID=<target-webpart-id>`
- Header: `Referer: https://<host>/_layouts/15/SignOut.aspx`
- Outcome pre-patch: SPRequestModule marks request as signout, skips auth, renders ToolPane with target page’s web parts.
- Post-patch: Access denied unless kill-switch 53506 is force-enabled.

2) **ToolShell chain to RCE (leveraging historical gadgets)**
- Step A: Use scenario 1 to anonymously load ToolPane for a target page that already hosts (or that you uploaded via prior auth) a malicious WebPart/BDC definition exploiting known gadgets (e.g., DataSet, DynamicType, WorkflowCompiler) in WebPart serialization.
- Step B: The ToolPane GET causes SPWebPartManager to materialize the WebPart; gadget executes server-side, leading to arbitrary code in w3wp.
- Alternative B: POST to ToolPane.aspx with a crafted WebPart import payload (requires a valid `__REQUESTDIGEST`; can be stolen via bypass if fragment redirects worked pre-patch) to persist the malicious WebPart then trigger it via GET.

3) **ProofToken hash redirect abuse (fixed)**
- Pre-patch: attacker could request proof-token sign-in with `ReturnUrl` containing a `#fragment`, potentially smuggling tokens/client state via fragment handling to bypass normal redirect validation.
- Post-patch: fragment causes redirect denial unless debug flag set.

## Source Reliability
- **High**: CSAF data for CVE mappings/severity. Code diff directly confirms the ToolPane referrer guard.
- **Medium-High**: Social posts accurately predict ToolPane unauth chain; matches the SPRequestModule fix.
- **Medium**: Historical writeups provide proven RCE gadgets and ToolPane behaviors; not specific to this patch but inform exploit paths.
- **Low**: No explicit public intel on the fragment redirect check; analysis based solely on code diff.

## Novel/Unpublic Findings
- Explicit identification of the referrer-based auth bypass in `SPRequestModule` tied to `ToolPane.aspx` and gated by kill-switch 53506 (not disclosed in public intel).
- Discovery of fragment-based redirect rejection in ProofTokenSignInPage (potentially closes a secondary spoofing/token-leak vector not mentioned externally).

## Recommendations / Next Steps
- Ensure the SPRequestModule ToolPane guard (no signout-referrer bypass) is deployed; verify kill-switch 53506 is OFF in production.
- Block or monitor unauthenticated requests to `/_layouts/15/ToolPane.aspx` with SignOut/Start referrers; add WAF rules reflecting the patched behavior.
- Review WebPart/BDC inventories for untrusted or owner-controlled definitions; even post-patch, deserialization RCE remains reachable with low-priv auth per CSAF (CVE-2025-49704/49701).
- Validate ProofToken flows: reject ReturnUrls containing `#` fragments and audit any downstream apps relying on them.
