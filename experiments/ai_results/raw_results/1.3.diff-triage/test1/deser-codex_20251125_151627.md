Agent: codex (GPT-5)
Timestamp: 2025-11-25 15:16:27
Duration: ~00:25

# Executive Summary
- Patch adds strict type allow/deny enforcement to the BinaryFormatter binder used by Microsoft.Ssdqs.Infra (NoneVersionSpecificSerializationBinder -> new TypeProcessor/BlockedTypeException). Prior version accepted attacker-supplied type names, enabling gadget-based code execution (DataSet/ExpandedWrapper+ObjectDataProvider, LosFormatter/ObjectStateFormatter, XamlReader, Workflow ActivitySurrogateSelector, ResourceDictionary, JavaScriptSerializer, ClaimsPrincipal/WindowsIdentity, BinaryFormatter/SoapFormatter/NetDataContractSerializer, SortedDictionary/SortedSet, XmlDocument/XmlDataDocument, etc.). This aligns with CSAF CVE-2025-49704 (low-priv RCE) and social “ToolShell” hints about deserialization RCE.
- SPRequestModule now refuses to skip auth checks when a request to `ToolPane.aspx` arrives with a signout referrer, closing an anonymous-signout trick. This is the likely authentication-bypass leg (CVE-2025-49706) used to reach the ToolPane deserialization sink without creds.
- Secondary hardening introduces safe binders for search analytics ContentPushStore dictionary deserialization; likely covers an additional RCE vector (bonus CVE-2025-49701) by constraining acceptable IDictionary-derived types.

# Intelligence Gathering
- Official (CSAF): CVE-2025-49704/49701 tagged as SharePoint RCE, PR:L, network reachable; CVE-2025-49706 is auth/sso spoofing. Guidance: authenticated site-owner enough; exploitation more likely. CWE-94 for 49704 suggests code/deserialization injection.
- ZDI Pwn2Own note: winning chain combined auth bypass + insecure deserialization on SharePoint.
- Social media: “ToolShell” single-request unauth RCE via POST to ToolPane.aspx chaining CVE-2025-49706 (spoof) + CVE-2025-49704 (deserialization RCE). No code, but confirms endpoint and class of bug.
- Historical patterns: Prior SharePoint deserialization (DataSet/ExpandedWrapper + ObjectDataProvider/XamlReader/LosFormatter), ObjectStateFormatter/TypeConfuseDelegate, JavaScriptSerializer+SimpleTypeResolver, Workflow ActivitySurrogateSelector, ResourceDictionary. All now blocked explicitly in the new deny list.

# Vulnerability Analysis
- **Deserialization RCE (CVE-2025-49704)**  
  - Patch location: `Microsoft.Ssdqs.Infra.Utilities.NoneVersionSpecificSerializationBinder` now routes type resolution through `TypeProcessor.LoadType`, throwing `BlockedTypeException` when a type is not in an allow list or is in a deny list (`BuildDisallowedTypesForDeserialization`, `BuildDisallowedGenerics`).  
  - Deny list contains classic gadget roots: DataSet/DataViewManager, ObjectDataProvider, XamlReader, ResourceDictionary, Workflow Activity/ActivitySurrogateSelector, JavaScriptSerializer/SimpleTypeResolver, ObjectStateFormatter/LosFormatter, BinaryFormatter/SoapFormatter/NetDataContractSerializer, ClaimsIdentity/WindowsIdentity, SortedDictionary/SortedSet, XmlDocument/XmlDataDocument, etc.  
  - Before patch: binder called `Type.GetType` directly with attacker-controlled assembly/type strings and cached them, so any BinaryFormatter payload reaching `SerializationUtility.ConvertSqlBytesToObject` (used throughout Ssdqs SQLCLR stored procedures and proxy entry points) would deserialize arbitrary types. Site owners can hit Ssdqs entry points via SharePoint’s Data Quality/BDC plumbing; with auth bypass (below) it becomes unauth. RCE achievable with classic ExpandedWrapper<DataSet,ObjectDataProvider> or LosFormatter TypeConfuseDelegate payloads.
- **Auth bypass to ToolPane (CVE-2025-49706)**  
  - Patch in `Microsoft.SharePoint.ApplicationRuntime.SPRequestModule`: when a request path is `ToolPane.aspx` and referrer is signout, the module previously disabled auth-cookie checks (`flag6=false`). Now it detects this combination and re-enables the check, logging “Risky bypass limited…signout with ToolPane.aspx detected.” This closes the anonymous signout-based reachability of ToolPane.aspx noted in social posts. ToolPane hosts the vulnerable deserialization workflow, making the chain unauth in v1.
- **Additional RCE hardening (likely CVE-2025-49701)**  
  - New `Microsoft.Office.Server.Search.Analytics.ContentPushStore.InheritIDictionaryBinder` and similar binders wrap BinaryFormatter deserialization of search documents’ IDictionary payloads. Prior code would deserialize arbitrary IDictionary-derived objects; now only specific dictionary types/ModelStateDictionary/RouteValueDictionary/etc. are allowed. This removes another BinaryFormatter gadget surface reachable through search ingestion paths.

# Dangerous Types & Bypass Options (v1)
- From deny list & historical gadgets:  
  - `System.Data.DataSet` / `ExpandedWrapper` + `System.Windows.Data.ObjectDataProvider` → XamlReader.Parse or Process.Start.  
  - `System.Web.UI.ObjectStateFormatter` / `LosFormatter` → TypeConfuseDelegate for command exec.  
  - `System.Workflow.ComponentModel.Serialization.ActivitySurrogateSelector` → Workflow-based gadget.  
  - `System.Web.Script.Serialization.JavaScriptSerializer` + `SimpleTypeResolver` → arbitrary type load.  
  - `System.Windows.Markup.XamlReader`, `System.Windows.ResourceDictionary`, `System.Xml.XmlDocument` → XAML/XML gadget pivots.  
  - Claims/WindowsIdentity/Principal classes for token forgery or impersonation gadgets.  
  - SortedDictionary/SortedSet generics for comparer-based gadget chains.

# Exploitation Approaches (v1)
- **ToolPane chain (per social/ZDI)**  
  1) Send POST to `/_layouts/15/ToolPane.aspx` with `Referer` set to `/_layouts/15/SignOut.aspx` (or variant) to trigger the old auth-skipping path.  
  2) In the body, supply the BinaryFormatter payload where ToolPane/Ssdqs expects serialized settings (SqlBytes-encoded properties). Payload: ExpandedWrapper<DataSet,ObjectDataProvider> containing LosFormatter TypeConfuseDelegate or XamlReader.Parse to run `cmd.exe /c whoami`.  
  3) v1: SPRequestModule skips auth, NoneVersionSpecificSerializationBinder resolves arbitrary types → RCE as w3wp. v2: auth check enforced and type blocked (BlockedTypeException).
- **Authenticated site owner**  
  - Invoke Ssdqs/DQS entry points (e.g., via Data Quality web part or BDC connector) that pass binary settings to SQLCLR (`SerializationUtility.ConvertSqlBytesToObject`). Supply a BinaryFormatter blob with one of the dangerous types above. v1 executes during deserialization; v2 throws BlockedTypeException.
- **Search analytics path (bonus)**  
  - Feed crafted analytics ContentPush payload where document values deserialize to a malicious IDictionary subtype (e.g., ExpandoObject carrying a BinaryFormatter gadget). v1 accepts; v2 restricts to a small whitelist via `InheritIDictionaryBinder`.

# Source Reliability
- CSAF matches code changes: RCE via code generation/deserialization, PR:L; spoofing aligns with ToolPane auth logic. High confidence.  
- Social posts accurately pinpoint ToolPane + single-request unauth: corroborated by SPRequestModule patch.  
- Historical writeups: Dangerous types enumerated now explicitly denied, validating that Microsoft targeted known gadget families.  
- Gap: Public intel didn’t mention the Ssdqs binder by name; novel finding shows the exact allow/deny implementation and affected assemblies (Microsoft.Ssdqs.Infra/Proxy/SQLCLR).

# Novel Findings
- Precise allow/deny lists in `TypeProcessor.BuildDisallowedTypesForDeserialization` reveal every blocked gadget family, enabling defenders to audit for residual gadget classes not covered.  
- Discovery of search analytics `ContentPushStore` binder hardening suggests an additional BinaryFormatter attack surface (potentially CVE-2025-49701) beyond the ToolPane/DQS path.  
- Identification of the signout+ToolPane referrer condition as the specific auth-bypass trigger.

# Recommendations / Next Steps
- Block or monitor requests to `/_layouts/15/ToolPane.aspx` with signout referrers; apply July 2025 updates.  
- For any custom code using `NoneVersionSpecificSerializationBinder`-style logic, adopt explicit allow/deny lists or replace BinaryFormatter/LosFormatter usage.  
- Review search ingestion/analytics pipelines for untrusted BinaryFormatter inputs; ensure binders mirror the new whitelist.  
- Validate that custom Solution/Feature code does not deserialize user-provided SqlBytes/varbinary using legacy Ssdqs utilities.  
- Retest ToolPane with DataSet/ObjectDataProvider and LosFormatter payloads against v2 to confirm BlockedTypeException triggers and auth is enforced.
