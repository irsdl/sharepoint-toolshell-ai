Agent: Codex (GPT-5)
Timestamp: 2025-11-26 16:37:22
Duration: 00:35

Root Cause Analysis
- SharePoint SafeControls in v1 marked the entire `Microsoft.PerformancePoint.Scorecards` client namespace as safe via wildcards (`snapshots_norm/v1/C__inetpub_wwwroot_wss_VirtualDirectories/80/web.config:240-245`), so the `[Serializable]` `ExcelDataSet` type was implicitly allowed in page/viewstate payloads.
- `ExcelDataSet` lazily deserializes user-controlled `CompressedDataTable` with `BinaryFormatter` through `Helper.GetObjectFromCompressedBase64String` (`snapshots_decompiled/v1/Microsoft.-89ead232-72556f65/Microsoft/PerformancePoint/Scorecards/ExcelDataSet.cs:20-76` and `Helper.cs:580-599`), decompressing attacker-supplied Base64 into objects.
- The deserializer allows `DataSet`/`DataTable` (`System.Data.BinarySerialization` binder allowlist at `snapshots_decompiled/v1/Microsoft.-52195226-3676d482/System/Data/BinarySerialization.cs:14-55`), types that are known BinaryFormatter gadgets, enabling code execution when a crafted binary payload is fed into `CompressedDataTable`.
- Exploitation path: any context that accepts persisted viewstate/web part state/PerformancePoint payloads containing `ExcelDataSet` (e.g., PerformancePoint pages where SafeControls are honored) would deserialize the nested BinaryFormatter blob, leading to server-side RCE if the attacker can submit signed state or stored content.

Patch Analysis
- v2 adds explicit `SafeControl` entries for `ExcelDataSet` with `Safe="False"` in both farm configs and site web.configs (`snapshots_norm/v2/C__Program Files_Common Files_Microsoft Shared_Web Server Extensions/16/CONFIG/web.config:150-163`, `.../cloudweb.config:150-163`, `.../VirtualDirectories/80/web.config:493-494`, `.../VirtualDirectories/20072/web.config:161-162`), overriding prior wildcard allowance.
- New upgrade actions `AddExcelDataSetToSafeControls` insert these unsafe entries automatically during upgrades (`snapshots_decompiled/v2/Microsoft.-52195226-3676d482/Microsoft/SharePoint/Upgrade/AddExcelDataSetToSafeControls.cs:7-35` and duplicate in `...-67953109-566b57ea/...:7-35`).
- No code changes were made to `ExcelDataSet`; the mitigation is configuration-only and relies on SafeControls enforcement.

Bypass Hypotheses
- **Template gap (Likelihood: Medium):** The provisioning template still registers the entire `Microsoft.PerformancePoint.Scorecards` namespace as safe with wildcards and no `Safe="False"` override (`snapshots_norm/v2/C__Program Files_Common Files_Microsoft Shared_Web Server Extensions/16/CONFIG/webconfig.pps.xml:3-9`). New sites built from this template could omit the unsafe entry unless the upgrade action runs post-provisioning.
- **Wildcard precedence risk (Likelihood: Medium):** Existing wildcard SafeControls for the same assembly/namespace remain (`snapshots_norm/v2/C__inetpub_wwwroot_wss_VirtualDirectories/80/web.config:240-245`). The patch assumes SharePoint resolves the explicit `Safe="False"` entries to block the type; if lookup prefers the earlier wildcard `Safe="True"` entries, `ExcelDataSet` may still deserialize.
- **Re-registration / config drift (Likelihood: Medium):** Because the vulnerable class is unchanged, any admin or feature that re-adds a `Safe="True"` entry for `Microsoft.PerformancePoint.Scorecards.ExcelDataSet` (or introduces a new version token not listed in the unsafe entries) would re-open the gadget; the fix provides no code-level guard.
- **Other BinaryFormatter paths (Likelihood: Low):** `Helper.GetObjectFromCompressedBase64String` remains available and ignores its expected-type parameter (`Helper.cs:580-599`). If any other serializable Scorecards object routes attacker-controlled Base64 through this helper (e.g., future features using the namespace wildcard), the same DataTable gadget surface persists despite the targeted block.

Overall Assessment & Recommendations
- The patch addresses the known entry by explicitly marking `ExcelDataSet` unsafe across current configs and adding upgrade hooks, but leaves SafeControl wildcards and the vulnerable BinaryFormatter code intact; effectiveness depends on SafeControls precedence and template coverage.
- Harden further by removing the wildcard SafeControls for `Microsoft.PerformancePoint.Scorecards*` or explicitly marking other non-control serializable types as unsafe in all templates (`webconfig.pps.xml` included).
- Eliminate BinaryFormatter usage in `ExcelDataSet`/`Helper` (replace with safe serializers or strict allowlists without DataSet/DataTable) so that re-registration cannot revive the gadget.
- Add automated checks to ensure new web applications inherit the unsafe entry (update provisioning templates, add health analyzer rule) and consider signing/validating any stored PerformancePoint payloads to prevent tampering.
