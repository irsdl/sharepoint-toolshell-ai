# CVE-2025-49704 Deserialization Patch Evaluation
- Agent: codex (GPT-5)
- Timestamp: 2025-11-26 18:22:04 UTC
- Duration: 00:30

## Root Cause Analysis
- **Unsafe gadget:** `Microsoft.PerformancePoint.Scorecards.ExcelDataSet` is `Serializable` and lazily inflates a `DataTable` from attacker-controlled base64 by calling `Helper.GetObjectFromCompressedBase64String` (snapshots_decompiled/v1/Microsoft.-89ead232-72556f65/Microsoft/PerformancePoint/Scorecards/ExcelDataSet.cs:39-52; Helper.cs:580-599). The helper uses `BinarySerialization.Deserialize` (BinaryFormatter) to materialize the data with only minimal type restrictions (DataSet/DataTable/Version) (System/Data/BinarySerialization.cs:10-62), so a crafted binary-serialized DataTable payload reaches BinaryFormatter and can execute DataTable/DataSet gadget chains (RCE, data exfiltration) once the `DataTable` getter is invoked.
- **Why reachable:** SharePoint’s SafeControls list whitelists the entire `Microsoft.PerformancePoint.Scorecards` namespace via wildcard entries (e.g., snapshots_norm/v1/C__inetpub_wwwroot_wss_VirtualDirectories/80/web.config:240-245), so ExcelDataSet was implicitly treated as safe for deserialization/instantiation in page/web part contexts. When user-controlled content (e.g., PerformancePoint dashboard parts, ASPX markup, or viewstate/personalization data gated only by SafeControls) references this type, SharePoint will create it and later trigger the compressed DataTable expansion.
- **Prereqs for exploit:** Ability to persist content that is parsed under SafeControls (add/modify a page or PerformancePoint artifact) and supply arbitrary `CompressedDataTable`/`ExcelFileBlob` data. No code execution mitigations are present once the gadget is instantiated; exploitation occurs during BinaryFormatter deserialization inside the helper.

## Patch Analysis
- **Config changes:** v2 adds explicit SafeControl entries marking ExcelDataSet as unsafe in all primary configs:
  - snapshots_norm/v2/C__Program Files_Common Files_Microsoft Shared_Web Server Extensions/16/CONFIG/cloudweb.config:161-162
  - snapshots_norm/v2/C__Program Files_Common Files_Microsoft Shared_Web Server Extensions/16/CONFIG/web.config:161-162
  - snapshots_norm/v2/C__inetpub_wwwroot_wss_VirtualDirectories/80/web.config:493-494
  - snapshots_norm/v2/C__inetpub_wwwroot_wss_VirtualDirectories/20072/web.config:494-495
  These entries set `Safe="False"` to override the earlier wildcard safelist.
- **Upgrade hook:** New upgrade action `AddExcelDataSetToSafeControls` injects the unsafe entries if missing (snapshots_decompiled/v2/Microsoft.-52195226-3676d482/Microsoft/SharePoint/Upgrade/AddExcelDataSetToSafeControls.cs:1-22), ensuring future web.configs pick up the block during upgrade.
- **Effect:** Because SafeControls resolution checks type-specific entries before wildcard namespaces (SafeAssemblyInfo.FindTypeEntryInfo → SafeControls.FindTypeEntryInfo), the added `Safe="False"` entries blacklist ExcelDataSet even though the namespace-wide `TypeName="*"` entries remain.

## Bypass Hypotheses
1. **Unpatched/alternative web.configs (Medium):** Only the main farm configs and two virtual directories were updated. Any other web app or vdir that still carries the wildcard safelist without the new `Safe="False"` entries (e.g., custom IIS sites, additional port bindings, or legacy backups) would still treat ExcelDataSet as safe. Evidence: wildcard safelist remains in v2 (snapshots_norm/v2/C__inetpub_wwwroot_wss_VirtualDirectories/80/web.config:240-245), showing how other configs could still be permissive if not upgraded.
2. **Other Scorecards gadgets still allowed (Medium):** The namespace-wide `TypeName="*"` entries for `Microsoft.PerformancePoint.Scorecards.*` remain Safe by default (snapshots_norm/v2/C__inetpub_wwwroot_wss_VirtualDirectories/80/web.config:240-245). Patch blacklists only ExcelDataSet; any other serializable type in the same assembly that deserializes attacker data (not assessed here) would stay exploitable via the same SafeControls whitelisting.
3. **Non-SafeControls entry points (Low):** The class and its BinaryFormatter-based expansion logic are still present (ExcelDataSet.cs:39-52; Helper.cs:580-599). If any service/API path accepts ExcelDataSet directly and does not consult SafeControls (e.g., import endpoints or internal PerformancePoint APIs), the config changes provide no protection.
4. **Version drift (Low):** The blacklist targets assembly versions 15.0.0.0 and 16.0.0.0. A future side-by-side assembly with a new version string would fall back to the namespace wildcard and could re-open the issue until a matching unsafe entry is added.

## Overall Assessment & Recommendations
- The patch correctly blacklists ExcelDataSet in key configs and wires an upgrade step, which should neutralize the gadget in SafeControls-gated deserialization paths.
- Residual risk remains because the wildcard safelist for the entire Scorecards namespace is untouched and only select web.configs were modified.

**Recommended hardening:**
- Remove or change the namespace-wide `TypeName="*"` SafeControls entries for `Microsoft.PerformancePoint.Scorecards.*` to `Safe="False"` or to a minimal allowlist of required web parts.
- Verify all web applications/virtual directories inherit the unsafe ExcelDataSet entries (audit for missing entries beyond the four updated files).
- Audit other Scorecards types for BinaryFormatter/DataSet deserialization and blacklist any additional risky types; or eliminate BinaryFormatter use in `Helper.GetObjectFromCompressedBase64String` in favor of a safe serializer.
