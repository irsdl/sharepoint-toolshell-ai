Agent: codex
Timestamp: 2025-11-26 13:58:47
Duration: 00:30

## Root Cause Analysis
- ExcelDataSet (`snapshots_decompiled/v1/Microsoft.-89ead232-72556f65/Microsoft/PerformancePoint/Scorecards/ExcelDataSet.cs:1-104`) is a serializable wrapper for Excel data. It stores attacker-controlled base64 (`CompressedDataTable`) that is expanded with `Helper.GetObjectFromCompressedBase64String` using `BinaryFormatter` on decompressed data (Helper.cs:556-599). The expected-type parameter is ignored, so any payload allowed by the binder is processed.
- `BinarySerialization` (System/Data/BinarySerialization.cs:8-62) permits BinaryFormatter deserialization of `DataSet`, `DataTable`, `SchemaSerializationMode`, and `Version` and uses `DataSetSurrogateSelector`, enabling a BinaryFormatter attack surface even when restricted to those types.
- SharePoint SafeControls marked the entire `Microsoft.PerformancePoint.Scorecards` namespace as safe (`C__inetpub_wwwroot_wss_VirtualDirectories/80/web.config:240-245` in v1), so ExcelDataSet was treated as safe despite being a non-control object with a BinaryFormatter-backed property. Any page/web part personalization content containing this type would be accepted and instantiated.
- Attack flow: a user able to inject content (web part import, page editing, or crafted view state/personalization data) can include an `ExcelDataSet` instance with a malicious `CompressedDataTable`. When the server later accesses `DataTable` (getter at lines 44-52), the BinaryFormatter payload executes under the limited allowlist (DataTable/DataSet gadget surface), enabling RCE/DoS depending on payload. Preconditions: ability to submit serialized state that SharePoint deserializes (page edit or import rights) and the Scorecards client assembly available on the server.

## Patch Analysis
- v2 adds explicit SafeControls entries marking ExcelDataSet as unsafe in core configs: `cloudweb.config` and `web.config` (`.../CONFIG/cloudweb.config:150-163`, `.../CONFIG/web.config:150-163`) and site web.configs (`C__inetpub_wwwroot_wss_VirtualDirectories/80/web.config:485-495`, `.../20072/web.config` similarly). These entries set `Safe="False"` for versions 15.0.0.0 and 16.0.0.0.
- Upgrade action `AddExcelDataSetToSafeControls` (Microsoft/SharePoint/Upgrade/AddExcelDataSetToSafeControls.cs:6-28) was added to inject the unsafe entries automatically during upgrade.
- No other types were changed; wildcard SafeControls for the Scorecards namespace remain, so only ExcelDataSet was explicitly blocked.

## Bypass Hypotheses
- Other Scorecards types remain fully trusted via namespace wildcards (`C__inetpub_wwwroot_wss_VirtualDirectories/80/web.config:240-245`). If any other class in `Microsoft.PerformancePoint.Scorecards` uses BinaryFormatter or similar unsafe deserialization (not covered by this patch), it would still be allowed. Likelihood: Medium (wildcard trust is broad; no evidence of another gadget in provided files, but the trust scope persists).
- Code-level vulnerability persists: ExcelDataSet still deserializes BinaryFormatter content with an allowlist that includes `DataTable`/`DataSet` and ignores the expected-type parameter (Helper.cs:556-599; BinarySerialization.cs:8-62). If an attacker can reach this code path outside SafeControls gating (e.g., another API path that accepts ExcelDataSet), the config patch does not mitigate it. Likelihood: Medium where such a path exists.
- Configuration coverage risk: the unsafe entries were added to specific configs present in the snapshots. New web applications or custom web.config templates that do not receive the upgrade action would lack the `Safe="False"` entries, restoring the original exposure. Likelihood: Low-Medium depending on admin practices.

## Overall Assessment
- The patch explicitly blocks ExcelDataSet in SafeControls across observed configs and adds an upgrade action to enforce it. This prevents the standard SafeControls-driven deserialization vector in these files.
- The patch is narrowly scoped: it does not address the underlying BinaryFormatter usage inside ExcelDataSet or the broad wildcard trust for the Scorecards namespace. No other dangerous types were identified in the provided materials, but the remaining trust surface could harbor undiscovered gadgets.
- Recommendations: (1) Remove or tighten the wildcard SafeControls entries for `Microsoft.PerformancePoint.Scorecards` or add explicit allowlists for specific web controls only. (2) Refactor ExcelDataSet to avoid BinaryFormatter altogether (e.g., use safe XML/JSON parsing of tabular data) and honor an explicit allowlist parameter. (3) Ensure new web apps/config templates include the unsafe ExcelDataSet entries; add validation/health check to confirm presence.
